'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
exports.shaderGraphPreview = void 0;
const cc_1 = require("cc");
const Interactive_preview_1 = require("./Interactive-preview");
const regions = [new cc_1.gfx.BufferTextureCopy()];
regions[0].texExtent.depth = 1;
function insertAdditionals(geometry) {
    if (!geometry.customAttributes) {
        geometry.customAttributes = [];
    }
    geometry.customAttributes.push({
        attr: new cc_1.gfx.Attribute(cc_1.gfx.AttributeName.ATTR_TANGENT, cc_1.gfx.Format.RGBA32F),
        values: EditorExtends.GeometryUtils.calculateTangents(geometry.positions, geometry.indices, geometry.normals, geometry.uvs),
    });
    return geometry;
}
const primitiveData = {
    box: {
        mesh: cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.box())),
        scale: new cc_1.Vec3(1, 1, 1),
    },
    sphere: {
        mesh: cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.sphere())),
        scale: new cc_1.Vec3(1, 1, 1),
    },
    capsule: {
        mesh: cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.capsule())),
        scale: new cc_1.Vec3(0.8, 0.8, 0.8),
    },
    cylinder: {
        mesh: cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cylinder())),
        scale: new cc_1.Vec3(0.8, 0.8, 0.8),
    },
    torus: {
        mesh: cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.torus())),
        scale: new cc_1.Vec3(1, 1, 1),
    },
    cone: {
        mesh: cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.cone())),
        scale: new cc_1.Vec3(1, 1, 1),
    },
    quad: {
        mesh: cc_1.utils.createMesh(insertAdditionals(cc_1.primitives.quad())),
        scale: new cc_1.Vec3(1, 1, 1),
    },
};
const tempVec3A = new cc_1.Vec3();
const tempVec3B = new cc_1.Vec3();
const tempQuatA = new cc_1.Quat();
const _matInsInfo = {
    parent: null,
    owner: null,
    subModelIdx: 0,
};
class ShaderGraphPreview extends Interactive_preview_1.InteractivePreview {
    constructor() {
        super(...arguments);
        this.primitive = 'sphere';
        this.material = null;
        this.cacheMeshs = {};
    }
    init(registerName, queryName) {
        super.init(registerName, queryName);
        const device = cc_1.director.root.device;
        this.uniformBuffer = device.createBuffer(new cc_1.gfx.BufferInfo(cc_1.gfx.BufferUsageBit.UNIFORM, cc_1.gfx.MemoryUsageBit.HOST | cc_1.gfx.MemoryUsageBit.DEVICE, 16));
        this.dummyUniformBuffer = device.createBuffer(new cc_1.gfx.BufferViewInfo(this.uniformBuffer, 0, this.uniformBuffer.size));
        this.storageBuffer = !isSceneNative ? this.uniformBuffer : device.createBuffer(new cc_1.gfx.BufferInfo(cc_1.gfx.BufferUsageBit.STORAGE, cc_1.gfx.MemoryUsageBit.HOST | cc_1.gfx.MemoryUsageBit.DEVICE, 16));
        this.dummyStorageBuffer = !isSceneNative ? this.dummyUniformBuffer :
            device.createBuffer(new cc_1.gfx.BufferViewInfo(this.storageBuffer, 0, this.storageBuffer.size));
        this.dummySampleTexture = device.createTexture(new cc_1.gfx.TextureInfo(cc_1.gfx.TextureType.TEX2D, cc_1.gfx.TextureUsageBit.SAMPLED, cc_1.gfx.Format.RGBA8, 4, 4));
        this.dummyStorageTexture = !isSceneNative ? this.dummySampleTexture : device.createTexture(new cc_1.gfx.TextureInfo(cc_1.gfx.TextureType.TEX2D, cc_1.gfx.TextureUsageBit.STORAGE, cc_1.gfx.Format.RGBA8, 4, 4));
        this.dummySampler = device.getSampler(new cc_1.gfx.SamplerInfo());
    }
    createNodes() {
        this.lightComp = new cc.Node('Shader Graph Preview Light').addComponent(cc_1.DirectionalLight);
        this.lightComp.node.setRotationFromEuler(-45, -45, 0);
        this.lightComp.node.setParent(this.scene);
        this.modelComp = new cc_1.Node('Shader Graph Preview Model').addComponent(cc_1.MeshRenderer);
        this.modelComp.mesh = primitiveData.sphere.mesh;
        const material = new cc_1.Material();
        material.initialize({ effectName: 'builtin-standard' });
        this.modelComp.material = material;
        this.setMaterial(material);
        this.modelComp.node.setParent(this.scene);
    }
    setMaterial(material) {
        if (material && material !== this.material) {
            const comp = this.modelComp;
            _matInsInfo.parent = material;
            _matInsInfo.owner = comp;
            const instantiated = new cc_1.renderer.MaterialInstance(_matInsInfo);
            comp.material = instantiated;
            this.material = material;
            this.updateDs();
            this.cameraComp.enabled = true;
            this.cameraComp.node.getWorldPosition(tempVec3A);
            this.modelComp.node.getWorldPosition(tempVec3B);
            this.viewDist = cc_1.Vec3.distance(tempVec3A, tempVec3B);
        }
    }
    // 部分材质如果没有调用该方法会有报错，如spine相关材质
    // 大部分材质不需要调用也会正常预览
    updateDs() {
        const model = this.modelComp.model;
        if (model) {
            for (let i = 0; i < model.subModels.length; i++) {
                const ds = model.subModels[i].descriptorSet;
                const bindings = ds.layout.bindings;
                const device = cc_1.director.root.device;
                for (let j = 0; j < bindings.length; j++) {
                    const desc = bindings[j];
                    const binding = desc.binding;
                    const dsType = desc.descriptorType;
                    // bind buffer
                    if (dsType & cc_1.gfx.DescriptorType.UNIFORM_BUFFER ||
                        dsType & cc_1.gfx.DescriptorType.DYNAMIC_UNIFORM_BUFFER) {
                        if (!ds.getBuffer(binding)) {
                            ds.bindBuffer(binding, this.dummyUniformBuffer);
                        }
                    }
                    else if (dsType & cc_1.gfx.DescriptorType.STORAGE_BUFFER ||
                        dsType & cc_1.gfx.DescriptorType.DYNAMIC_STORAGE_BUFFER) {
                        if (!ds.getBuffer(binding)) {
                            ds.bindBuffer(binding, this.dummyStorageBuffer);
                        }
                    }
                    // binde texture
                    else if (dsType & cc_1.gfx.DESCRIPTOR_SAMPLER_TYPE) {
                        if (!ds.getTexture(binding)) {
                            if (dsType & cc_1.gfx.DescriptorType.SAMPLER_TEXTURE ||
                                dsType & cc_1.gfx.DescriptorType.TEXTURE) {
                                ds.bindTexture(binding, this.dummySampleTexture);
                            }
                            else if (dsType & cc_1.gfx.DescriptorType.STORAGE_IMAGE) {
                                ds.bindTexture(binding, this.dummyStorageTexture);
                            }
                        }
                        if (!ds.getSampler(binding)) {
                            ds.bindSampler(binding, this.dummySampler);
                        }
                    }
                }
                ds.update();
            }
        }
    }
    setMesh(primitive, mesh, scale = cc_1.Vec3.ONE) {
        this.modelComp.mesh = mesh;
        // 在部分情况下，该接口会先于setMaterial调用 #12259
        // 如果上个材质刚好和目标材质类型不同，就会导致引擎底层无法正确绑定纹理，从而报错
        this.updateDs();
        this.modelComp.node.setScale(scale);
        this.primitive = primitive;
        this.cameraComp.enabled = true;
    }
    setPrimitive(primitive) {
        if (primitive && primitive !== this.primitive) {
            const cacheMesh = this.cacheMeshs[primitive];
            if (!cacheMesh) {
                cc.assetManager.loadAny(primitive, (err, mesh) => {
                    if (err) {
                        return console.error(err);
                    }
                    this.cacheMeshs[primitive] = mesh;
                    this.setMesh(primitive, mesh);
                });
            }
            else {
                this.setMesh(primitive, cacheMesh);
            }
        }
    }
    setLightEnable(enable) {
        if (this.lightComp.enabled !== enable) {
            this.lightComp.enabled = enable;
        }
    }
    resetCamera() {
        super.resetCamera(this.modelComp.node);
    }
}
const shaderGraphPreview = new ShaderGraphPreview();
exports.shaderGraphPreview = shaderGraphPreview;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2hhZGVyLWdyYXBoLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29udHJpYnV0aW9ucy9wcmV2aWV3L3NoYWRlci1ncmFwaC1wcmV2aWV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFlBQVksQ0FBQzs7O0FBRWIsMkJBY1k7QUFNWiwrREFBMkQ7QUFDM0QsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFJLFFBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLENBQUM7QUFDOUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDO0FBRS9CLFNBQVMsaUJBQWlCLENBQUMsUUFBOEI7SUFDckQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRTtRQUM1QixRQUFRLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO0tBQ2xDO0lBQ0QsUUFBUSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQztRQUMzQixJQUFJLEVBQUUsSUFBSSxRQUFHLENBQUMsU0FBUyxDQUFDLFFBQUcsQ0FBQyxhQUFhLENBQUMsWUFBWSxFQUFFLFFBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDO1FBQzNFLE1BQU0sRUFBRSxhQUFhLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLE9BQVEsRUFBRSxRQUFRLENBQUMsT0FBUSxFQUFFLFFBQVEsQ0FBQyxHQUFJLENBQWE7S0FDN0ksQ0FBQyxDQUFDO0lBQ0gsT0FBTyxRQUFRLENBQUM7QUFDcEIsQ0FBQztBQU9ELE1BQU0sYUFBYSxHQUFtQztJQUNsRCxHQUFHLEVBQUU7UUFDRCxJQUFJLEVBQUUsVUFBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUMzRCxLQUFLLEVBQUUsSUFBSSxTQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDM0I7SUFDRCxNQUFNLEVBQUU7UUFDSixJQUFJLEVBQUUsVUFBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM5RCxLQUFLLEVBQUUsSUFBSSxTQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDM0I7SUFDRCxPQUFPLEVBQUU7UUFDTCxJQUFJLEVBQUUsVUFBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFVLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUMvRCxLQUFLLEVBQUUsSUFBSSxTQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7S0FDakM7SUFDRCxRQUFRLEVBQUU7UUFDTixJQUFJLEVBQUUsVUFBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFVLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUNoRSxLQUFLLEVBQUUsSUFBSSxTQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7S0FDakM7SUFDRCxLQUFLLEVBQUU7UUFDSCxJQUFJLEVBQUUsVUFBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFVLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUM3RCxLQUFLLEVBQUUsSUFBSSxTQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDM0I7SUFDRCxJQUFJLEVBQUU7UUFDRixJQUFJLEVBQUUsVUFBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFVLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM1RCxLQUFLLEVBQUUsSUFBSSxTQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDM0I7SUFDRCxJQUFJLEVBQUU7UUFDRixJQUFJLEVBQUUsVUFBSyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxlQUFVLENBQUMsSUFBSSxF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LENBQUMsQ0FBQztxQkFDN0I7b0JBQ0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsR0FBRyxJQUFJLENBQUM7b0JBQ2xDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUNsQyxDQUFDLENBQUMsQ0FBQzthQUNOO2lCQUFNO2dCQUNILElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQ3RDO1NBQ0o7SUFDTCxDQUFDO0lBRU0sY0FBYyxDQUFDLE1BQWU7UUFDakMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sS0FBSyxNQUFNLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1NBQ25DO0lBQ0wsQ0FBQztJQUVNLFdBQVc7UUFDZCxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0MsQ0FBQztDQUNKO0FBRUQsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLGtCQUFrQixFQUFFLENBQUM7QUFFM0MsZ0RBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQge1xuICAgIERpcmVjdGlvbmFsTGlnaHQsXG4gICAgZ2Z4LFxuICAgIE1hdGVyaWFsLFxuICAgIE1lc2gsXG4gICAgTWVzaFJlbmRlcmVyLFxuICAgIHByaW1pdGl2ZXMsXG4gICAgUXVhdCxcbiAgICBSZW5kZXJlcixcbiAgICByZW5kZXJlcixcbiAgICB1dGlscyxcbiAgICBWZWMzLFxuICAgIGRpcmVjdG9yLFxuICAgIE5vZGUsXG59IGZyb20gJ2NjJztcblxuZGVjbGFyZSBjb25zdCBjYzogYW55O1xuZGVjbGFyZSBjb25zdCBFZGl0b3JFeHRlbmRzOiBhbnk7XG5kZWNsYXJlIGNvbnN0IGlzU2NlbmVOYXRpdmU6IGJvb2xlYW47XG5cbmltcG9ydCB7IEludGVyYWN0aXZlUHJldmlldyB9IGZyb20gJy4vSW50ZXJhY3RpdmUtcHJldmlldyc7XG5jb25zdCByZWdpb25zID0gW25ldyBnZnguQnVmZmVyVGV4dHVyZUNvcHkoKV07XG5yZWdpb25zWzBdLnRleEV4dGVudC5kZXB0aCA9IDE7XG5cbmZ1bmN0aW9uIGluc2VydEFkZGl0aW9uYWxzKGdlb21ldHJ5OiBwcmltaXRpdmVzLklHZW9tZXRyeSkge1xuICAgIGlmICghZ2VvbWV0cnkuY3VzdG9tQXR0cmlidXRlcykge1xuICAgICAgICBnZW9tZXRyeS5jdXN0b21BdHRyaWJ1dGVzID0gW107XG4gICAgfVxuICAgIGdlb21ldHJ5LmN1c3RvbUF0dHJpYnV0ZXMucHVzaCh7XG4gICAgICAgIGF0dHI6IG5ldyBnZnguQXR0cmlidXRlKGdmeC5BdHRyaWJ1dGVOYW1lLkFUVFJfVEFOR0VOVCwgZ2Z4LkZvcm1hdC5SR0JBMzJGKSxcbiAgICAgICAgdmFsdWVzOiBFZGl0b3JFeHRlbmRzLkdlb21ldHJ5VXRpbHMuY2FsY3VsYXRlVGFuZ2VudHMoZ2VvbWV0cnkucG9zaXRpb25zLCBnZW9tZXRyeS5pbmRpY2VzISwgZ2VvbWV0cnkubm9ybWFscyEsIGdlb21ldHJ5LnV2cyEpIGFzIG51bWJlcltdLFxuICAgIH0pO1xuICAgIHJldHVybiBnZW9tZXRyeTtcbn1cblxuaW50ZXJmYWNlIElQcmltaXRpdmVJbmZvIHtcbiAgICBtZXNoOiBNZXNoO1xuICAgIHNjYWxlOiBWZWMzO1xufVxuXG5jb25zdCBwcmltaXRpdmVEYXRhOiBSZWNvcmQ8c3RyaW5nLCBJUHJpbWl0aXZlSW5mbz4gPSB7XG4gICAgYm94OiB7XG4gICAgICAgIG1lc2g6IHV0aWxzLmNyZWF0ZU1lc2goaW5zZXJ0QWRkaXRpb25hbHMocHJpbWl0aXZlcy5ib3goKSkpLFxuICAgICAgICBzY2FsZTogbmV3IFZlYzMoMSwgMSwgMSksXG4gICAgfSxcbiAgICBzcGhlcmU6IHtcbiAgICAgICAgbWVzaDogdXRpbHMuY3JlYXRlTWVzaChpbnNlcnRBZGRpdGlvbmFscyhwcmltaXRpdmVzLnNwaGVyZSgpKSksXG4gICAgICAgIHNjYWxlOiBuZXcgVmVjMygxLCAxLCAxKSxcbiAgICB9LFxuICAgIGNhcHN1bGU6IHtcbiAgICAgICAgbWVzaDogdXRpbHMuY3JlYXRlTWVzaChpbnNlcnRBZGRpdGlvbmFscyhwcmltaXRpdmVzLmNhcHN1bGUoKSkpLFxuICAgICAgICBzY2FsZTogbmV3IFZlYzMoMC44LCAwLjgsIDAuOCksXG4gICAgfSxcbiAgICBjeWxpbmRlcjoge1xuICAgICAgICBtZXNoOiB1dGlscy5jcmVhdGVNZXNoKGluc2VydEFkZGl0aW9uYWxzKHByaW1pdGl2ZXMuY3lsaW5kZXIoKSkpLFxuICAgICAgICBzY2FsZTogbmV3IFZlYzMoMC44LCAwLjgsIDAuOCksXG4gICAgfSxcbiAgICB0b3J1czoge1xuICAgICAgICBtZXNoOiB1dGlscy5jcmVhdGVNZXNoKGluc2VydEFkZGl0aW9uYWxzKHByaW1pdGl2ZXMudG9ydXMoKSkpLFxuICAgICAgICBzY2FsZTogbmV3IFZlYzMoMSwgMSwgMSksXG4gICAgfSxcbiAgICBjb25lOiB7XG4gICAgICAgIG1lc2g6IHV0aWxzLmNyZWF0ZU1lc2goaW5zZXJ0QWRkaXRpb25hbHMocHJpbWl0aXZlcy5jb25lKCkpKSxcbiAgICAgICAgc2NhbGU6IG5ldyBWZWMzKDEsIDEsIDEpLFxuICAgIH0sXG4gICAgcXVhZDoge1xuICAgICAgICBtZXNoOiB1dGlscy5jcmVhdGVNZXNoKGluc2VydEFkZGl0aW9uYWxzKHByaW1pdGl2ZXMucXVhZCgpKSksXG4gICAgICAgIHNjYWxlOiBuZXcgVmVjMygxLCAxLCAxKSxcbiAgICB9LFxufTtcblxuY29uc3QgdGVtcFZlYzNBID0gbmV3IFZlYzMoKTtcbmNvbnN0IHRlbXBWZWMzQiA9IG5ldyBWZWMzKCk7XG5jb25zdCB0ZW1wUXVhdEEgPSBuZXcgUXVhdCgpO1xuXG5jb25zdCBfbWF0SW5zSW5mbyA9IHtcbiAgICBwYXJlbnQ6IG51bGwhIGFzIE1hdGVyaWFsLFxuICAgIG93bmVyOiBudWxsISBhcyBSZW5kZXJlcixcbiAgICBzdWJNb2RlbElkeDogMCxcbn07XG5cbmNsYXNzIFNoYWRlckdyYXBoUHJldmlldyBleHRlbmRzIEludGVyYWN0aXZlUHJldmlldyB7XG4gICAgcHJpdmF0ZSBsaWdodENvbXAhOiBEaXJlY3Rpb25hbExpZ2h0O1xuICAgIHByaXZhdGUgbW9kZWxDb21wITogTWVzaFJlbmRlcmVyO1xuICAgIHByaXZhdGUgcHJpbWl0aXZlID0gJ3NwaGVyZSc7XG4gICAgcHJpdmF0ZSBtYXRlcmlhbDogTWF0ZXJpYWwgfCBudWxsID0gbnVsbDtcblxuICAgIHByaXZhdGUgZHVtbXlVbmlmb3JtQnVmZmVyITogZ2Z4LkJ1ZmZlcjtcblxuICAgIHByaXZhdGUgZHVtbXlTdG9yYWdlVGV4dHVyZSE6IGdmeC5UZXh0dXJlO1xuICAgIHByaXZhdGUgZHVtbXlTYW1wbGVUZXh0dXJlITogZ2Z4LlRleHR1cmU7XG4gICAgcHJpdmF0ZSBkdW1teVNhbXBsZXIhOiBnZnguU2FtcGxlcjtcblxuICAgIHByaXZhdGUgZHVtbXlTdG9yYWdlQnVmZmVyITogZ2Z4LkJ1ZmZlcjtcbiAgICBwcml2YXRlIHVuaWZvcm1CdWZmZXIhOiBnZnguQnVmZmVyO1xuICAgIHByaXZhdGUgc3RvcmFnZUJ1ZmZlciE6IGdmeC5CdWZmZXI7XG5cbiAgICBwcml2YXRlIGNhY2hlTWVzaHM6IFJlY29yZDxzdHJpbmcsIE1lc2g+ID0ge307XG5cbiAgICBwdWJsaWMgaW5pdChyZWdpc3Rlck5hbWU6IHN0cmluZywgcXVlcnlOYW1lOiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIuaW5pdChyZWdpc3Rlck5hbWUsIHF1ZXJ5TmFtZSk7XG5cbiAgICAgICAgY29uc3QgZGV2aWNlID0gZGlyZWN0b3Iucm9vdCEuZGV2aWNlO1xuXG4gICAgICAgIHRoaXMudW5pZm9ybUJ1ZmZlciA9IGRldmljZS5jcmVhdGVCdWZmZXIobmV3IGdmeC5CdWZmZXJJbmZvKFxuICAgICAgICAgICAgZ2Z4LkJ1ZmZlclVzYWdlQml0LlVOSUZPUk0sXG4gICAgICAgICAgICBnZnguTWVtb3J5VXNhZ2VCaXQuSE9TVCB8IGdmeC5NZW1vcnlVc2FnZUJpdC5ERVZJQ0UsXG4gICAgICAgICAgICAxNixcbiAgICAgICAgKSk7XG4gICAgICAgIHRoaXMuZHVtbXlVbmlmb3JtQnVmZmVyID0gZGV2aWNlLmNyZWF0ZUJ1ZmZlcihuZXcgZ2Z4LkJ1ZmZlclZpZXdJbmZvKHRoaXMudW5pZm9ybUJ1ZmZlciwgMCwgdGhpcy51bmlmb3JtQnVmZmVyLnNpemUpKTtcblxuICAgICAgICB0aGlzLnN0b3JhZ2VCdWZmZXIgPSAhaXNTY2VuZU5hdGl2ZSA/IHRoaXMudW5pZm9ybUJ1ZmZlciA6IGRldmljZS5jcmVhdGVCdWZmZXIobmV3IGdmeC5CdWZmZXJJbmZvKFxuICAgICAgICAgICAgZ2Z4LkJ1ZmZlclVzYWdlQml0LlNUT1JBR0UsXG4gICAgICAgICAgICBnZnguTWVtb3J5VXNhZ2VCaXQuSE9TVCB8IGdmeC5NZW1vcnlVc2FnZUJpdC5ERVZJQ0UsXG4gICAgICAgICAgICAxNixcbiAgICAgICAgKSk7XG4gICAgICAgIHRoaXMuZHVtbXlTdG9yYWdlQnVmZmVyID0gIWlzU2NlbmVOYXRpdmUgPyB0aGlzLmR1bW15VW5pZm9ybUJ1ZmZlciA6XG4gICAgICAgICAgICBkZXZpY2UuY3JlYXRlQnVmZmVyKG5ldyBnZnguQnVmZmVyVmlld0luZm8odGhpcy5zdG9yYWdlQnVmZmVyLCAwLCB0aGlzLnN0b3JhZ2VCdWZmZXIuc2l6ZSkpO1xuXG4gICAgICAgIHRoaXMuZHVtbXlTYW1wbGVUZXh0dXJlID0gZGV2aWNlLmNyZWF0ZVRleHR1cmUobmV3IGdmeC5UZXh0dXJlSW5mbyhcbiAgICAgICAgICAgIGdmeC5UZXh0dXJlVHlwZS5URVgyRCxcbiAgICAgICAgICAgIGdmeC5UZXh0dXJlVXNhZ2VCaXQuU0FNUExFRCxcbiAgICAgICAgICAgIGdmeC5Gb3JtYXQuUkdCQTgsXG4gICAgICAgICAgICA0LCA0LFxuICAgICAgICApKTtcbiAgICAgICAgdGhpcy5kdW1teVN0b3JhZ2VUZXh0dXJlID0gIWlzU2NlbmVOYXRpdmUgPyB0aGlzLmR1bW15U2FtcGxlVGV4dHVyZSA6IGRldmljZS5jcmVhdGVUZXh0dXJlKG5ldyBnZnguVGV4dHVyZUluZm8oXG4gICAgICAgICAgICBnZnguVGV4dHVyZVR5cGUuVEVYMkQsXG4gICAgICAgICAgICBnZnguVGV4dHVyZVVzYWdlQml0LlNUT1JBR0UsXG4gICAgICAgICAgICBnZnguRm9ybWF0LlJHQkE4LFxuICAgICAgICAgICAgNCwgNCxcbiAgICAgICAgKSk7XG4gICAgICAgIHRoaXMuZHVtbXlTYW1wbGVyID0gZGV2aWNlLmdldFNhbXBsZXIobmV3IGdmeC5TYW1wbGVySW5mbygpKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBjcmVhdGVOb2RlcygpIHtcbiAgICAgICAgdGhpcy5saWdodENvbXAgPSBuZXcgY2MuTm9kZSgnU2hhZGVyIEdyYXBoIFByZXZpZXcgTGlnaHQnKS5hZGRDb21wb25lbnQoRGlyZWN0aW9uYWxMaWdodCk7XG4gICAgICAgIHRoaXMubGlnaHRDb21wLm5vZGUuc2V0Um90YXRpb25Gcm9tRXVsZXIoLTQ1LCAtNDUsIDApO1xuICAgICAgICB0aGlzLmxpZ2h0Q29tcC5ub2RlLnNldFBhcmVudCh0aGlzLnNjZW5lKTtcblxuICAgICAgICB0aGlzLm1vZGVsQ29tcCA9IG5ldyBOb2RlKCdTaGFkZXIgR3JhcGggUHJldmlldyBNb2RlbCcpLmFkZENvbXBvbmVudChNZXNoUmVuZGVyZXIpO1xuICAgICAgICB0aGlzLm1vZGVsQ29tcC5tZXNoID0gcHJpbWl0aXZlRGF0YS5zcGhlcmUubWVzaDtcbiAgICAgICAgY29uc3QgbWF0ZXJpYWwgPSBuZXcgTWF0ZXJpYWwoKTtcbiAgICAgICAgbWF0ZXJpYWwuaW5pdGlhbGl6ZSh7IGVmZmVjdE5hbWU6ICdidWlsdGluLXN0YW5kYXJkJyB9KTtcbiAgICAgICAgdGhpcy5tb2RlbENvbXAubWF0ZXJpYWwgPSBtYXRlcmlhbDtcbiAgICAgICAgdGhpcy5zZXRNYXRlcmlhbChtYXRlcmlhbCk7XG5cbiAgICAgICAgdGhpcy5tb2RlbENvbXAubm9kZS5zZXRQYXJlbnQodGhpcy5zY2VuZSk7XG4gICAgfVxuXG4gICAgcHVibGljIHNldE1hdGVyaWFsKG1hdGVyaWFsOiBNYXRlcmlhbCB8IG51bGwpIHtcbiAgICAgICAgaWYgKG1hdGVyaWFsICYmIG1hdGVyaWFsICE9PSB0aGlzLm1hdGVyaWFsKSB7XG4gICAgICAgICAgICBjb25zdCBjb21wID0gdGhpcy5tb2RlbENvbXA7XG4gICAgICAgICAgICBfbWF0SW5zSW5mby5wYXJlbnQgPSBtYXRlcmlhbDtcbiAgICAgICAgICAgIF9tYXRJbnNJbmZvLm93bmVyID0gY29tcDtcbiAgICAgICAgICAgIGNvbnN0IGluc3RhbnRpYXRlZCA9IG5ldyByZW5kZXJlci5NYXRlcmlhbEluc3RhbmNlKF9tYXRJbnNJbmZvKTtcbiAgICAgICAgICAgIGNvbXAubWF0ZXJpYWwgPSBpbnN0YW50aWF0ZWQ7XG4gICAgICAgICAgICB0aGlzLm1hdGVyaWFsID0gbWF0ZXJpYWw7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZURzKCk7XG4gICAgICAgICAgICB0aGlzLmNhbWVyYUNvbXAuZW5hYmxlZCA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLmNhbWVyYUNvbXAubm9kZS5nZXRXb3JsZFBvc2l0aW9uKHRlbXBWZWMzQSk7XG4gICAgICAgICAgICB0aGlzLm1vZGVsQ29tcC5ub2RlLmdldFdvcmxkUG9zaXRpb24odGVtcFZlYzNCKTtcbiAgICAgICAgICAgIHRoaXMudmlld0Rpc3QgPSBWZWMzLmRpc3RhbmNlKHRlbXBWZWMzQSwgdGVtcFZlYzNCKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIOmDqOWIhuadkOi0qOWmguaenOayoeacieiwg+eUqOivpeaWueazleS8muacieaKpemUme+8jOWmgnNwaW5l55u45YWz5p2Q6LSoXG4gICAgLy8g5aSn6YOo5YiG5p2Q6LSo5LiN6ZyA6KaB6LCD55So5Lmf5Lya5q2j5bi46aKE6KeIXG4gICAgcHVibGljIHVwZGF0ZURzKCkge1xuICAgICAgICBjb25zdCBtb2RlbCA9IHRoaXMubW9kZWxDb21wLm1vZGVsO1xuICAgICAgICBpZiAobW9kZWwpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbW9kZWwuc3ViTW9kZWxzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZHMgPSBtb2RlbC5zdWJNb2RlbHNbaV0uZGVzY3JpcHRvclNldDtcbiAgICAgICAgICAgICAgICBjb25zdCBiaW5kaW5ncyA9IGRzLmxheW91dC5iaW5kaW5ncztcbiAgICAgICAgICAgICAgICBjb25zdCBkZXZpY2UgPSBkaXJlY3Rvci5yb290IS5kZXZpY2U7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBiaW5kaW5ncy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkZXNjID0gYmluZGluZ3Nbal07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmcgPSBkZXNjLmJpbmRpbmc7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRzVHlwZSA9IGRlc2MuZGVzY3JpcHRvclR5cGU7XG4gICAgICAgICAgICAgICAgICAgIC8vIGJpbmQgYnVmZmVyXG4gICAgICAgICAgICAgICAgICAgIGlmIChkc1R5cGUgJiBnZnguRGVzY3JpcHRvclR5cGUuVU5JRk9STV9CVUZGRVIgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRzVHlwZSAmIGdmeC5EZXNjcmlwdG9yVHlwZS5EWU5BTUlDX1VOSUZPUk1fQlVGRkVSKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRzLmdldEJ1ZmZlcihiaW5kaW5nKSkgeyBkcy5iaW5kQnVmZmVyKGJpbmRpbmcsIHRoaXMuZHVtbXlVbmlmb3JtQnVmZmVyKTsgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRzVHlwZSAmIGdmeC5EZXNjcmlwdG9yVHlwZS5TVE9SQUdFX0JVRkZFUiB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgZHNUeXBlICYgZ2Z4LkRlc2NyaXB0b3JUeXBlLkRZTkFNSUNfU1RPUkFHRV9CVUZGRVIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZHMuZ2V0QnVmZmVyKGJpbmRpbmcpKSB7IGRzLmJpbmRCdWZmZXIoYmluZGluZywgdGhpcy5kdW1teVN0b3JhZ2VCdWZmZXIpOyB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gYmluZGUgdGV4dHVyZVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChkc1R5cGUgJiBnZnguREVTQ1JJUFRPUl9TQU1QTEVSX1RZUEUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZHMuZ2V0VGV4dHVyZShiaW5kaW5nKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkc1R5cGUgJiBnZnguRGVzY3JpcHRvclR5cGUuU0FNUExFUl9URVhUVVJFIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzVHlwZSAmIGdmeC5EZXNjcmlwdG9yVHlwZS5URVhUVVJFKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzLmJpbmRUZXh0dXJlKGJpbmRpbmcsIHRoaXMuZHVtbXlTYW1wbGVUZXh0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRzVHlwZSAmIGdmeC5EZXNjcmlwdG9yVHlwZS5TVE9SQUdFX0lNQUdFKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRzLmJpbmRUZXh0dXJlKGJpbmRpbmcsIHRoaXMuZHVtbXlTdG9yYWdlVGV4dHVyZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRzLmdldFNhbXBsZXIoYmluZGluZykpIHsgZHMuYmluZFNhbXBsZXIoYmluZGluZywgdGhpcy5kdW1teVNhbXBsZXIpOyB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZHMudXBkYXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNldE1lc2gocHJpbWl0aXZlOiBzdHJpbmcsIG1lc2g6IE1lc2gsIHNjYWxlOiBWZWMzID0gVmVjMy5PTkUpIHtcbiAgICAgICAgdGhpcy5tb2RlbENvbXAubWVzaCA9IG1lc2g7XG4gICAgICAgIC8vIOWcqOmDqOWIhuaDheWGteS4i++8jOivpeaOpeWPo+S8muWFiOS6jnNldE1hdGVyaWFs6LCD55SoICMxMjI1OVxuICAgICAgICAvLyDlpoLmnpzkuIrkuKrmnZDotKjliJrlpb3lkoznm67moIfmnZDotKjnsbvlnovkuI3lkIzvvIzlsLHkvJrlr7zoh7TlvJXmk47lupXlsYLml6Dms5XmraPnoa7nu5HlrprnurnnkIbvvIzku47ogIzmiqXplJlcbiAgICAgICAgdGhpcy51cGRhdGVEcygpO1xuICAgICAgICB0aGlzLm1vZGVsQ29tcC5ub2RlLnNldFNjYWxlKHNjYWxlKTtcbiAgICAgICAgdGhpcy5wcmltaXRpdmUgPSBwcmltaXRpdmU7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5lbmFibGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0UHJpbWl0aXZlKHByaW1pdGl2ZTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChwcmltaXRpdmUgJiYgcHJpbWl0aXZlICE9PSB0aGlzLnByaW1pdGl2ZSkge1xuICAgICAgICAgICAgY29uc3QgY2FjaGVNZXNoID0gdGhpcy5jYWNoZU1lc2hzW3ByaW1pdGl2ZV07XG4gICAgICAgICAgICBpZiAoIWNhY2hlTWVzaCkge1xuICAgICAgICAgICAgICAgIGNjLmFzc2V0TWFuYWdlci5sb2FkQW55KHByaW1pdGl2ZSwgKGVycjogRXJyb3IsIG1lc2g6IE1lc2gpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlTWVzaHNbcHJpbWl0aXZlXSA9IG1lc2g7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0TWVzaChwcmltaXRpdmUsIG1lc2gpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldE1lc2gocHJpbWl0aXZlLCBjYWNoZU1lc2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHNldExpZ2h0RW5hYmxlKGVuYWJsZTogYm9vbGVhbikge1xuICAgICAgICBpZiAodGhpcy5saWdodENvbXAuZW5hYmxlZCAhPT0gZW5hYmxlKSB7XG4gICAgICAgICAgICB0aGlzLmxpZ2h0Q29tcC5lbmFibGVkID0gZW5hYmxlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHJlc2V0Q2FtZXJhKCkge1xuICAgICAgICBzdXBlci5yZXNldENhbWVyYSh0aGlzLm1vZGVsQ29tcC5ub2RlKTtcbiAgICB9XG59XG5cbmNvbnN0IHNoYWRlckdyYXBoUHJldmlldyA9IG5ldyBTaGFkZXJHcmFwaFByZXZpZXcoKTtcblxuZXhwb3J0IHsgc2hhZGVyR3JhcGhQcmV2aWV3IH07XG4iXX0=