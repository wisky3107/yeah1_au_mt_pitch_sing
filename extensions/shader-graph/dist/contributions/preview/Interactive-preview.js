"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.InteractivePreview = void 0;
const cc_1 = require("cc");
const buffer_1 = require("./buffer");
const preview_base_1 = require("./preview-base");
const tempVec3A = new cc_1.Vec3();
const tempVec3B = new cc_1.Vec3();
function clamp(val, min, max) {
    return val < min ? min : val > max ? max : val;
}
function makeVec3InRange(inVec3, min, max) {
    inVec3.x = clamp(inVec3.x, min, max);
    inVec3.y = clamp(inVec3.y, min, max);
    inVec3.z = clamp(inVec3.z, min, max);
    return inVec3;
}
/**
 * 可交互的Preview窗口基类，可以在窗口中方便的预览场景中的元素
 */
class InteractivePreview extends preview_base_1.PreviewBase {
    constructor() {
        super();
        this.isMouseDown = false;
        this.viewDist = 10;
        this.orbitRotateSpeed = 0.01;
        this.curCameraRot = new cc_1.Quat();
        this.viewCenter = new cc_1.Vec3();
        this.node = new cc_1.Node();
        this.isMouseLeft = false;
        this._flipWheelDirection = true;
        this._curPos = cc.v3();
        this._curRot = new cc_1.Quat();
        this._forward = cc.v3(cc_1.Vec3.UNIT_Z);
        this._v3a = cc.v3();
        this.scene = new cc_1.Scene('');
        this.cameraComp = new cc_1.Node().addComponent(cc_1.Camera);
        // @ts-ignore
        this.cameraComp.node.parent = this.scene;
        this.cameraComp.node.setPosition(0, 1, 2.5);
        this.cameraComp.node.lookAt(cc_1.Vec3.ZERO);
        this.cameraComp.near = 0.01;
        this.cameraComp.enabled = false;
        this.createNodes();
        // @ts-ignore
        this.scene._load(); // ensure scene initialized
        // @ts-ignore
        this.scene._activate();
        this.cameraComp.clearColor = new cc_1.Color(71, 71, 71, 255);
        this.camera = this.cameraComp.camera;
        this.camera.isWindowSize = false;
        this.camera.cameraUsage = cc_1.renderer.scene.CameraUsage?.EDITOR;
        this.camera.detachCamera();
    }
    createNodes() {
    }
    init(registerName, queryName) {
        this.scene.name = registerName;
        this.cameraComp.node.name = registerName + 'camera';
        this.previewBuffer = new buffer_1.PreviewBuffer(registerName, queryName, this.scene);
    }
    resetCamera(modelNode) {
        this.camera.changeTargetWindow(this.previewBuffer.window);
        tempVec3A.set(0, 1, 2.5);
        this.cameraComp.node.setPosition(tempVec3A);
        this.cameraComp.node.lookAt(cc_1.Vec3.ZERO);
        modelNode.getWorldPosition(tempVec3B);
        cc_1.Vec3.set(this.viewCenter, 0, 0, 0);
        this.viewDist = cc_1.Vec3.distance(tempVec3A, tempVec3B);
        cce.Engine.repaintInEditMode();
    }
    destroyNode() {
        if (this.node && (0, cc_1.isValid)(this.node, true)) {
            this.node.setParent(null);
            this.node._destroyImmediate();
            this.node = null;
        }
    }
    perfectCameraView(boundary) {
        this.viewDist = this.getFitDistance(boundary);
        this.cameraComp.node.getWorldRotation(this._curRot);
        cc_1.Vec3.transformQuat(tempVec3A, cc_1.Vec3.UNIT_Z, this._curRot);
        cc_1.Vec3.multiplyScalar(tempVec3A, tempVec3A, this.viewDist);
        cc_1.Vec3.add(tempVec3B, this.viewCenter, tempVec3A);
        this.cameraComp.node.setWorldPosition(tempVec3B);
        this.cameraComp.node.lookAt(this.viewCenter);
        cce.Engine.repaintInEditMode();
    }
    getFitDistance(boundary) {
        if (!boundary) {
            return 0;
        }
        this.viewCenter = boundary.center;
        const maxRange = boundary.halfExtents.length();
        //  为了让距离看起来更舒适
        const distScalar = 1.2;
        const fov = this.cameraComp.fov;
        const depthSize = Math.tan(((fov / 2) * Math.PI) / 180);
        const dist = (maxRange * distScalar) / depthSize;
        this.cameraComp.near = dist - maxRange;
        this.cameraComp.far = dist + maxRange;
        return dist;
    }
    onMouseDown(event) {
        this.isMouseDown = true;
        this.cameraComp.node.getWorldRotation(this._curRot);
        this.cameraComp.node.getWorldPosition(this._curPos);
        if ((event.button === cc_1.EventMouse.BUTTON_LEFT || !event.button)) {
            this.isMouseLeft = true;
        }
        this.cameraComp.node.getWorldRotation(this.curCameraRot);
    }
    onMouseMove(event) {
        if (!this.isMouseDown) {
            return;
        }
        if (this.isMouseLeft) {
            this.rotate(event.movementX | 0, event.movementY | 0);
        }
    }
    onMouseUp(event) {
        this.isMouseDown = false;
        this.isMouseLeft = false;
    }
    onMouseWheel(event) {
        this.scale(event.wheelDeltaY);
    }
    scale(delta) {
        if (this._flipWheelDirection) {
            delta = -delta;
        }
        const finalDelta = ((this.cameraComp.far - this.cameraComp.near) / 100);
        const node = this.cameraComp.node;
        const curPos = this._curPos;
        const forward = this._forward;
        const v3a = this._v3a;
        node.getWorldPosition(curPos);
        node.getWorldRotation(this._curRot);
        cc_1.Vec3.transformQuat(forward, cc_1.Vec3.UNIT_Z, this._curRot);
        cc_1.Vec3.multiplyScalar(v3a, forward, finalDelta * Math.sign(delta));
        cc_1.Vec3.add(curPos, curPos, v3a);
        makeVec3InRange(curPos, -1e12, 1e12);
        const tempDist = cc_1.Vec3.distance(curPos, this.viewCenter);
        const min = this.cameraComp.near * 2;
        const max = this.cameraComp.far / 3;
        // if (tempDist > min && max > tempDist) {
        this.viewDist = tempDist;
        node.setWorldPosition(curPos);
        // }
    }
    rotate(dx, dy) {
        if (!this.isMouseDown && !this.isMouseLeft) {
            return;
        }
        this.cameraComp.node.getWorldRotation(this._curRot);
        const rot = this._curRot;
        const euler = cc.v3();
        cc_1.Quat.rotateX(rot, rot, -dy * this.orbitRotateSpeed);
        cc_1.Quat.rotateAround(rot, rot, cc_1.Vec3.UNIT_Y, -dx * this.orbitRotateSpeed);
        cc_1.Quat.toEuler(euler, rot);
        cc_1.Quat.fromEuler(rot, euler.x, euler.y, 0); // clear rotate of z
        const offset = cc.v3(0, 0, 1);
        cc_1.Vec3.transformQuat(offset, offset, rot);
        cc_1.Vec3.normalize(offset, offset);
        cc_1.Vec3.multiplyScalar(offset, offset, this.viewDist);
        cc_1.Vec3.add(this._curPos, this.viewCenter, offset);
        this.cameraComp.node.setWorldPosition(this._curPos);
        const up = cc.v3(0, 1, 0);
        cc_1.Vec3.transformQuat(up, up, rot);
        cc_1.Vec3.normalize(up, up);
        this.cameraComp.node.lookAt(this.viewCenter, up);
    }
    setZoom(scale) {
        //向前滚动 > 0 向后滚动 < 0
        this.cameraComp.node.lookAt(this.cameraComp.camera.forward);
        this.cameraComp.node.worldPosition.add(this.cameraComp.camera.forward.multiplyScalar(scale));
        this.cameraComp.node.setWorldPosition(this.cameraComp.node.worldPosition);
        this.viewDist = cc_1.Vec3.distance(this.cameraComp.node.worldPosition, this.viewCenter);
    }
    hide() {
        this.cameraComp.enabled = false;
    }
}
exports.InteractivePreview = InteractivePreview;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZXJhY3RpdmUtcHJldmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb250cmlidXRpb25zL3ByZXZpZXcvSW50ZXJhY3RpdmUtcHJldmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBcUc7QUFDckcscUNBQXlDO0FBQ3pDLGlEQUE2QztBQUc3QyxNQUFNLFNBQVMsR0FBRyxJQUFJLFNBQUksRUFBRSxDQUFDO0FBQzdCLE1BQU0sU0FBUyxHQUFHLElBQUksU0FBSSxFQUFFLENBQUM7QUFFN0IsU0FBUyxLQUFLLENBQUMsR0FBVyxFQUFFLEdBQVcsRUFBRSxHQUFXO0lBQ2hELE9BQU8sR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQztBQUNuRCxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsTUFBWSxFQUFFLEdBQVcsRUFBRSxHQUFXO0lBQzNELE1BQU0sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBRXJDLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFFRDs7R0FFRztBQUNILE1BQU0sa0JBQW1CLFNBQVEsMEJBQVc7SUFtQnhDO1FBQ0ksS0FBSyxFQUFFLENBQUM7UUFoQkYsZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFDcEIsYUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNk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O0FBRVEsZ0RBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2FtZXJhLCBDb2xvciwgZ2VvbWV0cnksIGlzVmFsaWQsIE5vZGUsIFF1YXQsIHJlbmRlcmVyLCBTY2VuZSwgVmVjMywgRXZlbnRNb3VzZSB9IGZyb20gJ2NjJztcbmltcG9ydCB7IFByZXZpZXdCdWZmZXIgfSBmcm9tICcuL2J1ZmZlcic7XG5pbXBvcnQgeyBQcmV2aWV3QmFzZSB9IGZyb20gJy4vcHJldmlldy1iYXNlJztcbmRlY2xhcmUgY29uc3QgY2NlOiBhbnk7XG5kZWNsYXJlIGNvbnN0IGNjOiBhbnk7XG5jb25zdCB0ZW1wVmVjM0EgPSBuZXcgVmVjMygpO1xuY29uc3QgdGVtcFZlYzNCID0gbmV3IFZlYzMoKTtcblxuZnVuY3Rpb24gY2xhbXAodmFsOiBudW1iZXIsIG1pbjogbnVtYmVyLCBtYXg6IG51bWJlcikge1xuICAgIHJldHVybiB2YWwgPCBtaW4gPyBtaW4gOiB2YWwgPiBtYXggPyBtYXggOiB2YWw7XG59XG5cbmZ1bmN0aW9uIG1ha2VWZWMzSW5SYW5nZShpblZlYzM6IFZlYzMsIG1pbjogbnVtYmVyLCBtYXg6IG51bWJlcikge1xuICAgIGluVmVjMy54ID0gY2xhbXAoaW5WZWMzLngsIG1pbiwgbWF4KTtcbiAgICBpblZlYzMueSA9IGNsYW1wKGluVmVjMy55LCBtaW4sIG1heCk7XG4gICAgaW5WZWMzLnogPSBjbGFtcChpblZlYzMueiwgbWluLCBtYXgpO1xuXG4gICAgcmV0dXJuIGluVmVjMztcbn1cblxuLyoqXG4gKiDlj6/kuqTkupLnmoRQcmV2aWV356qX5Y+j5Z+657G777yM5Y+v5Lul5Zyo56qX5Y+j5Lit5pa55L6/55qE6aKE6KeI5Zy65pmv5Lit55qE5YWD57SgXG4gKi9cbmNsYXNzIEludGVyYWN0aXZlUHJldmlldyBleHRlbmRzIFByZXZpZXdCYXNlIHtcbiAgICBwcm90ZWN0ZWQgc2NlbmUhOiBTY2VuZTtcbiAgICBwcm90ZWN0ZWQgY2FtZXJhQ29tcCE6IENhbWVyYTtcbiAgICBwcm90ZWN0ZWQgY2FtZXJhOiByZW5kZXJlci5zY2VuZS5DYW1lcmEgfCBhbnk7XG4gICAgcHJvdGVjdGVkIGlzTW91c2VEb3duID0gZmFsc2U7XG4gICAgcHJvdGVjdGVkIHZpZXdEaXN0ID0gMTA7XG4gICAgcHJvdGVjdGVkIG9yYml0Um90YXRlU3BlZWQgPSAwLjAxO1xuICAgIHByb3RlY3RlZCBjdXJDYW1lcmFSb3QgPSBuZXcgUXVhdCgpO1xuICAgIHByb3RlY3RlZCB2aWV3Q2VudGVyID0gbmV3IFZlYzMoKTtcbiAgICBwcm90ZWN0ZWQgbm9kZTogTm9kZSB8IG51bGwgPSBuZXcgTm9kZSgpO1xuXG4gICAgcHJvdGVjdGVkIGlzTW91c2VMZWZ0ID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIF9mbGlwV2hlZWxEaXJlY3Rpb24gPSB0cnVlO1xuICAgIHByaXZhdGUgX2N1clBvcyA9IGNjLnYzKCk7XG4gICAgcHJpdmF0ZSBfY3VyUm90ID0gbmV3IFF1YXQoKTtcbiAgICBwcml2YXRlIF9mb3J3YXJkID0gY2MudjMoVmVjMy5VTklUX1opO1xuICAgIHByaXZhdGUgX3YzYSA9IGNjLnYzKCk7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5zY2VuZSA9IG5ldyBTY2VuZSgnJyk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcCA9IG5ldyBOb2RlKCkuYWRkQ29tcG9uZW50KENhbWVyYSk7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLm5vZGUucGFyZW50ID0gdGhpcy5zY2VuZTtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLm5vZGUuc2V0UG9zaXRpb24oMCwgMSwgMi41KTtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLm5vZGUubG9va0F0KFZlYzMuWkVSTyk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5uZWFyID0gMC4wMTtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLmVuYWJsZWQgPSBmYWxzZTtcblxuICAgICAgICB0aGlzLmNyZWF0ZU5vZGVzKCk7XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICB0aGlzLnNjZW5lLl9sb2FkKCk7IC8vIGVuc3VyZSBzY2VuZSBpbml0aWFsaXplZFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHRoaXMuc2NlbmUuX2FjdGl2YXRlKCk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5jbGVhckNvbG9yID0gbmV3IENvbG9yKDcxLCA3MSwgNzEsIDI1NSk7XG4gICAgICAgIHRoaXMuY2FtZXJhID0gdGhpcy5jYW1lcmFDb21wLmNhbWVyYTtcbiAgICAgICAgdGhpcy5jYW1lcmEuaXNXaW5kb3dTaXplID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY2FtZXJhLmNhbWVyYVVzYWdlID0gcmVuZGVyZXIuc2NlbmUuQ2FtZXJhVXNhZ2U/LkVESVRPUjtcbiAgICAgICAgdGhpcy5jYW1lcmEuZGV0YWNoQ2FtZXJhKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGNyZWF0ZU5vZGVzKCkge1xuXG4gICAgfVxuXG4gICAgcHVibGljIGluaXQocmVnaXN0ZXJOYW1lOiBzdHJpbmcsIHF1ZXJ5TmFtZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuc2NlbmUubmFtZSA9IHJlZ2lzdGVyTmFtZTtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLm5vZGUubmFtZSA9IHJlZ2lzdGVyTmFtZSArICdjYW1lcmEnO1xuXG4gICAgICAgIHRoaXMucHJldmlld0J1ZmZlciA9IG5ldyBQcmV2aWV3QnVmZmVyKHJlZ2lzdGVyTmFtZSwgcXVlcnlOYW1lLCB0aGlzLnNjZW5lKTtcbiAgICB9XG5cbiAgICByZXNldENhbWVyYShtb2RlbE5vZGU6IE5vZGUpIHtcbiAgICAgICAgdGhpcy5jYW1lcmEuY2hhbmdlVGFyZ2V0V2luZG93KHRoaXMucHJldmlld0J1ZmZlci53aW5kb3cpO1xuICAgICAgICB0ZW1wVmVjM0Euc2V0KDAsIDEsIDIuNSk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5ub2RlLnNldFBvc2l0aW9uKHRlbXBWZWMzQSk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5ub2RlLmxvb2tBdChWZWMzLlpFUk8pO1xuICAgICAgICBtb2RlbE5vZGUuZ2V0V29ybGRQb3NpdGlvbih0ZW1wVmVjM0IpO1xuICAgICAgICBWZWMzLnNldCh0aGlzLnZpZXdDZW50ZXIsIDAsIDAsIDApO1xuICAgICAgICB0aGlzLnZpZXdEaXN0ID0gVmVjMy5kaXN0YW5jZSh0ZW1wVmVjM0EsIHRlbXBWZWMzQik7XG4gICAgICAgIGNjZS5FbmdpbmUucmVwYWludEluRWRpdE1vZGUoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZGVzdHJveU5vZGUoKSB7XG4gICAgICAgIGlmICh0aGlzLm5vZGUgJiYgaXNWYWxpZCh0aGlzLm5vZGUsIHRydWUpKSB7XG4gICAgICAgICAgICB0aGlzLm5vZGUuc2V0UGFyZW50KG51bGwpO1xuICAgICAgICAgICAgdGhpcy5ub2RlLl9kZXN0cm95SW1tZWRpYXRlKCk7XG4gICAgICAgICAgICB0aGlzLm5vZGUgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHBlcmZlY3RDYW1lcmFWaWV3KGJvdW5kYXJ5OiBnZW9tZXRyeS5BQUJCIHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnZpZXdEaXN0ID0gdGhpcy5nZXRGaXREaXN0YW5jZShib3VuZGFyeSk7XG5cbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLm5vZGUuZ2V0V29ybGRSb3RhdGlvbih0aGlzLl9jdXJSb3QpO1xuXG4gICAgICAgIFZlYzMudHJhbnNmb3JtUXVhdCh0ZW1wVmVjM0EsIFZlYzMuVU5JVF9aLCB0aGlzLl9jdXJSb3QpO1xuICAgICAgICBWZWMzLm11bHRpcGx5U2NhbGFyKHRlbXBWZWMzQSwgdGVtcFZlYzNBLCB0aGlzLnZpZXdEaXN0KTtcbiAgICAgICAgVmVjMy5hZGQodGVtcFZlYzNCLCB0aGlzLnZpZXdDZW50ZXIsIHRlbXBWZWMzQSk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5ub2RlLnNldFdvcmxkUG9zaXRpb24odGVtcFZlYzNCKTtcblxuICAgICAgICB0aGlzLmNhbWVyYUNvbXAubm9kZS5sb29rQXQodGhpcy52aWV3Q2VudGVyKTtcbiAgICAgICAgY2NlLkVuZ2luZS5yZXBhaW50SW5FZGl0TW9kZSgpO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBnZXRGaXREaXN0YW5jZShib3VuZGFyeTogZ2VvbWV0cnkuQUFCQiB8IG51bGwgfCB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKCFib3VuZGFyeSkge1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy52aWV3Q2VudGVyID0gYm91bmRhcnkuY2VudGVyO1xuICAgICAgICBjb25zdCBtYXhSYW5nZSA9IGJvdW5kYXJ5LmhhbGZFeHRlbnRzLmxlbmd0aCgpO1xuXG4gICAgICAgIC8vICDkuLrkuoborqnot53nprvnnIvotbfmnaXmm7ToiJLpgIJcbiAgICAgICAgY29uc3QgZGlzdFNjYWxhciA9IDEuMjtcbiAgICAgICAgY29uc3QgZm92ID0gdGhpcy5jYW1lcmFDb21wLmZvdjtcbiAgICAgICAgY29uc3QgZGVwdGhTaXplID0gTWF0aC50YW4oKChmb3YgLyAyKSAqIE1hdGguUEkpIC8gMTgwKTtcbiAgICAgICAgY29uc3QgZGlzdCA9IChtYXhSYW5nZSAqIGRpc3RTY2FsYXIpIC8gZGVwdGhTaXplO1xuICAgICAgICB0aGlzLmNhbWVyYUNvbXAubmVhciA9IGRpc3QgLSBtYXhSYW5nZTtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLmZhciA9IGRpc3QgKyBtYXhSYW5nZTtcblxuICAgICAgICByZXR1cm4gZGlzdDtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25Nb3VzZURvd24oZXZlbnQ6IGFueSkge1xuICAgICAgICB0aGlzLmlzTW91c2VEb3duID0gdHJ1ZTtcblxuICAgICAgICB0aGlzLmNhbWVyYUNvbXAubm9kZS5nZXRXb3JsZFJvdGF0aW9uKHRoaXMuX2N1clJvdCk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5ub2RlLmdldFdvcmxkUG9zaXRpb24odGhpcy5fY3VyUG9zKTtcblxuICAgICAgICBpZiAoKGV2ZW50LmJ1dHRvbiA9PT0gRXZlbnRNb3VzZS5CVVRUT05fTEVGVCB8fCAhZXZlbnQuYnV0dG9uKSkge1xuICAgICAgICAgICAgdGhpcy5pc01vdXNlTGVmdCA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNhbWVyYUNvbXAubm9kZS5nZXRXb3JsZFJvdGF0aW9uKHRoaXMuY3VyQ2FtZXJhUm90KTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25Nb3VzZU1vdmUoZXZlbnQ6IGFueSkge1xuICAgICAgICBpZiAoIXRoaXMuaXNNb3VzZURvd24pIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgaWYgKHRoaXMuaXNNb3VzZUxlZnQpIHtcbiAgICAgICAgICAgIHRoaXMucm90YXRlKGV2ZW50Lm1vdmVtZW50WCB8IDAsIGV2ZW50Lm1vdmVtZW50WSB8IDApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG9uTW91c2VVcChldmVudDogYW55KSB7XG4gICAgICAgIHRoaXMuaXNNb3VzZURvd24gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5pc01vdXNlTGVmdCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbk1vdXNlV2hlZWwoZXZlbnQ6IGFueSkge1xuICAgICAgICB0aGlzLnNjYWxlKGV2ZW50LndoZWVsRGVsdGFZKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc2NhbGUoZGVsdGE6IG51bWJlcikge1xuICAgICAgICBpZiAodGhpcy5fZmxpcFdoZWVsRGlyZWN0aW9uKSB7XG4gICAgICAgICAgICBkZWx0YSA9IC1kZWx0YTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGZpbmFsRGVsdGEgPSAoKHRoaXMuY2FtZXJhQ29tcC5mYXIgLSB0aGlzLmNhbWVyYUNvbXAubmVhcikgLyAxMDApO1xuICAgICAgICBjb25zdCBub2RlID0gdGhpcy5jYW1lcmFDb21wLm5vZGU7XG4gICAgICAgIGNvbnN0IGN1clBvcyA9IHRoaXMuX2N1clBvcztcbiAgICAgICAgY29uc3QgZm9yd2FyZCA9IHRoaXMuX2ZvcndhcmQ7XG4gICAgICAgIGNvbnN0IHYzYSA9IHRoaXMuX3YzYTtcblxuICAgICAgICBub2RlLmdldFdvcmxkUG9zaXRpb24oY3VyUG9zKTtcbiAgICAgICAgbm9kZS5nZXRXb3JsZFJvdGF0aW9uKHRoaXMuX2N1clJvdCk7XG4gICAgICAgIFZlYzMudHJhbnNmb3JtUXVhdChmb3J3YXJkLCBWZWMzLlVOSVRfWiwgdGhpcy5fY3VyUm90KTtcblxuICAgICAgICBWZWMzLm11bHRpcGx5U2NhbGFyKHYzYSwgZm9yd2FyZCwgZmluYWxEZWx0YSAqIE1hdGguc2lnbihkZWx0YSkpO1xuICAgICAgICBWZWMzLmFkZChjdXJQb3MsIGN1clBvcywgdjNhKTtcbiAgICAgICAgbWFrZVZlYzNJblJhbmdlKGN1clBvcywgLTFlMTIsIDFlMTIpO1xuICAgICAgICBjb25zdCB0ZW1wRGlzdCA9IFZlYzMuZGlzdGFuY2UoY3VyUG9zLCB0aGlzLnZpZXdDZW50ZXIpO1xuICAgICAgICBjb25zdCBtaW4gPSB0aGlzLmNhbWVyYUNvbXAubmVhciAqIDI7XG4gICAgICAgIGNvbnN0IG1heCA9IHRoaXMuY2FtZXJhQ29tcC5mYXIgLyAzO1xuXG4gICAgICAgIC8vIGlmICh0ZW1wRGlzdCA+IG1pbiAmJiBtYXggPiB0ZW1wRGlzdCkge1xuICAgICAgICB0aGlzLnZpZXdEaXN0ID0gdGVtcERpc3Q7XG4gICAgICAgIG5vZGUuc2V0V29ybGRQb3NpdGlvbihjdXJQb3MpO1xuICAgICAgICAvLyB9XG5cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgcm90YXRlKGR4OiBudW1iZXIsIGR5OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLmlzTW91c2VEb3duICYmICF0aGlzLmlzTW91c2VMZWZ0KSB7IHJldHVybjsgfVxuICAgICAgICB0aGlzLmNhbWVyYUNvbXAubm9kZS5nZXRXb3JsZFJvdGF0aW9uKHRoaXMuX2N1clJvdCk7XG4gICAgICAgIGNvbnN0IHJvdCA9IHRoaXMuX2N1clJvdDtcbiAgICAgICAgY29uc3QgZXVsZXIgPSBjYy52MygpO1xuXG4gICAgICAgIFF1YXQucm90YXRlWChyb3QsIHJvdCwgLWR5ICogdGhpcy5vcmJpdFJvdGF0ZVNwZWVkKTtcbiAgICAgICAgUXVhdC5yb3RhdGVBcm91bmQocm90LCByb3QsIFZlYzMuVU5JVF9ZLCAtZHggKiB0aGlzLm9yYml0Um90YXRlU3BlZWQpO1xuICAgICAgICBRdWF0LnRvRXVsZXIoZXVsZXIsIHJvdCk7XG5cbiAgICAgICAgUXVhdC5mcm9tRXVsZXIocm90LCBldWxlci54LCBldWxlci55LCAwKTsgLy8gY2xlYXIgcm90YXRlIG9mIHpcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gY2MudjMoMCwgMCwgMSk7XG4gICAgICAgIFZlYzMudHJhbnNmb3JtUXVhdChvZmZzZXQsIG9mZnNldCwgcm90KTtcbiAgICAgICAgVmVjMy5ub3JtYWxpemUob2Zmc2V0LCBvZmZzZXQpO1xuXG4gICAgICAgIFZlYzMubXVsdGlwbHlTY2FsYXIob2Zmc2V0LCBvZmZzZXQsIHRoaXMudmlld0Rpc3QpO1xuICAgICAgICBWZWMzLmFkZCh0aGlzLl9jdXJQb3MsIHRoaXMudmlld0NlbnRlciwgb2Zmc2V0KTtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLm5vZGUuc2V0V29ybGRQb3NpdGlvbih0aGlzLl9jdXJQb3MpO1xuXG4gICAgICAgIGNvbnN0IHVwID0gY2MudjMoMCwgMSwgMCk7XG4gICAgICAgIFZlYzMudHJhbnNmb3JtUXVhdCh1cCwgdXAsIHJvdCk7XG4gICAgICAgIFZlYzMubm9ybWFsaXplKHVwLCB1cCk7XG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5ub2RlLmxvb2tBdCh0aGlzLnZpZXdDZW50ZXIsIHVwKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0Wm9vbShzY2FsZTogbnVtYmVyKSB7XG4gICAgICAgIC8v5ZCR5YmN5rua5YqoID4gMCDlkJHlkI7mu5rliqggPCAwXG4gICAgICAgIHRoaXMuY2FtZXJhQ29tcC5ub2RlLmxvb2tBdCh0aGlzLmNhbWVyYUNvbXAuY2FtZXJhLmZvcndhcmQpO1xuICAgICAgICB0aGlzLmNhbWVyYUNvbXAubm9kZS53b3JsZFBvc2l0aW9uLmFkZCh0aGlzLmNhbWVyYUNvbXAuY2FtZXJhLmZvcndhcmQubXVsdGlwbHlTY2FsYXIoc2NhbGUpKTtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLm5vZGUuc2V0V29ybGRQb3NpdGlvbih0aGlzLmNhbWVyYUNvbXAubm9kZS53b3JsZFBvc2l0aW9uKTtcbiAgICAgICAgdGhpcy52aWV3RGlzdCA9IFZlYzMuZGlzdGFuY2UodGhpcy5jYW1lcmFDb21wLm5vZGUud29ybGRQb3NpdGlvbiwgdGhpcy52aWV3Q2VudGVyKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaGlkZSgpIHtcbiAgICAgICAgdGhpcy5jYW1lcmFDb21wLmVuYWJsZWQgPSBmYWxzZTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IEludGVyYWN0aXZlUHJldmlldyB9O1xuIl19