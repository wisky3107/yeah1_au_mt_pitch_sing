"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PreviewBuffer = void 0;
const cc_1 = require("cc");
// @ts-ignore
module.paths.push(AppModulePath);
class PreviewBuffer {
    constructor(registerName, name, scene = null) {
        this.device = cc.director.root.device;
        this.width = Math.floor(cc.director.root.mainWindow.width);
        this.height = Math.floor(cc.director.root.mainWindow.height);
        this.data = new Uint8Array(this.width * this.height * 4);
        this.renderScene = null;
        this.scene = null;
        this.windows = {};
        this.window = null;
        // windowList: IWindowInfo[] = [];
        this.regions = [new cc_1.gfx.BufferTextureCopy()];
        this.lock = false;
        this.needInvertGFXApi = [
            cc_1.gfx.API.GLES2,
            cc_1.gfx.API.GLES3,
            cc_1.gfx.API.WEBGL,
            cc_1.gfx.API.WEBGL2,
        ];
        this.renderData = {
            width: this.width,
            height: this.height,
            buffer: this.data,
        };
        this._name = name;
        this._registerName = registerName;
        this.onLoadScene(scene);
        this.regions[0].texExtent.width = this.width;
        this.regions[0].texExtent.height = this.height;
        this.createWindow();
        this.queue = [];
    }
    resize(width, height, window = null) {
        window || (window = this.window);
        // only resize when window is render window
        if (!window)
            return;
        width = Math.floor(width);
        height = Math.floor(height);
        this.renderData.width = this.width = width;
        this.renderData.height = this.height = height;
        this.regions[0].texExtent.width = width;
        this.regions[0].texExtent.height = height;
        window.resize(width, height);
        this.renderData.buffer = this.data = new Uint8Array(this.width * this.height * 4);
    }
    /**
     * WARNING: DO'NOT USE IT BEFORE DRAW!!!
     */
    clear() {
        // hack: resize width and height with 0 will be clear buff,realtime clear all data
        if (!isSceneNative) {
            this.resize(0, 0, this.window); // 原生场景会报错
        }
        this.resize(this.width, this.height, this.window);
    }
    createWindow(uuid = null) {
        if (uuid && this.windows[uuid]) {
            this.window = this.windows[uuid];
            return;
        }
        const root = cc.director.root;
        const renderPassInfo = new cc_1.gfx.RenderPassInfo([new cc_1.gfx.ColorAttachment(root.mainWindow.swapchain.colorTexture.format)], new cc_1.gfx.DepthStencilAttachment(root.mainWindow.swapchain.depthStencilTexture.format));
        renderPassInfo.colorAttachments[0].barrier = root.device.getGeneralBarrier(new cc_1.gfx.GeneralBarrierInfo(0, cc_1.gfx.AccessFlagBit.FRAGMENT_SHADER_READ_TEXTURE));
        const window = root.createWindow({
            title: this._name,
            width: this.width,
            height: this.height,
            renderPassInfo,
            isOffscreen: true,
        });
        this.window = window;
        uuid && (this.windows[uuid] = window);
    }
    removeWindow(uuid) {
        if (uuid && this.windows[uuid]) {
            cc.director.root.destroyWindow(this.windows[uuid]);
            if (this.windows[uuid] === this.window)
                this.window = null;
            delete this.windows[uuid];
        }
    }
    onLoadScene(scene) {
        this.windows = {};
        this.scene = scene;
        this.renderScene = scene.renderScene;
    }
    switchCameras(camera, currWindow) {
        if (currWindow) {
            camera.isWindowSize = false;
            camera.isEnable = true;
            camera.changeTargetWindow(currWindow);
            cc.director.root.tempWindow = currWindow;
        }
    }
    copyFrameBuffer(window = null) {
        window || (window = this.window);
        if (!window || !window.framebuffer)
            return this.renderData;
        this.device.copyTextureToBuffers(window.framebuffer.colorTextures[0], [new Uint8Array(this.renderData.buffer.buffer)], this.regions);
        this.formatBuffer(this.renderData.buffer, !this.needInvertGFXApi.includes(this.device.gfxAPI), this.device.gfxAPI === cc_1.gfx.API.METAL);
        return this.renderData;
    }
    formatBuffer(buffer, needInvert, conversionBGRA) {
        if (!needInvert)
            return buffer;
        let startIndex, invertIndex;
        const V_U_Vec4 = { r: 0, g: 0, b: 0, a: 0 };
        const indexArr = conversionBGRA ? PreviewBuffer.indexOfBGRA : PreviewBuffer.indexOfRGBA;
        for (let w = 0; w < this.renderData.width; w++) {
            for (let h = 0; h <= this.renderData.height / 2; h++) {
                startIndex = (h * this.renderData.width + w) * 4;
                // invert index
                invertIndex = ((this.renderData.height - h) * this.renderData.width + w) * 4;
                // flip Y
                V_U_Vec4.r = buffer[startIndex + indexArr[0]];
                V_U_Vec4.g = buffer[startIndex + indexArr[1]];
                V_U_Vec4.b = buffer[startIndex + indexArr[2]];
                V_U_Vec4.a = buffer[startIndex + indexArr[3]];
                buffer[startIndex + 0] = buffer[invertIndex + indexArr[0]];
                buffer[startIndex + 1] = buffer[invertIndex + indexArr[1]];
                buffer[startIndex + 2] = buffer[invertIndex + indexArr[2]];
                buffer[startIndex + 3] = buffer[invertIndex + indexArr[3]];
                buffer[invertIndex + 0] = V_U_Vec4.r;
                buffer[invertIndex + 1] = V_U_Vec4.g;
                buffer[invertIndex + 2] = V_U_Vec4.b;
                buffer[invertIndex + 3] = V_U_Vec4.a;
            }
        }
        return buffer;
    }
    getImageDataInQueue(width, height, event) {
        const params = {
            width: Math.floor(width),
            height: Math.floor(height),
        };
        this.queue.push({
            params,
            event,
        });
        this.step();
    }
    async step() {
        if (this.lock) {
            return;
        }
        this.lock = true;
        const item = this.queue.shift();
        if (!item) {
            this.lock = false;
            return;
        }
        const { params, event } = item;
        const data = await this.getImageData(params.width, params.height);
        event.reply(null, data);
        this.lock = false;
        this.step();
    }
    async getImageData(width, height) {
        if (!this.renderScene) {
            return this.renderData;
        }
        cce.Engine.repaintInEditMode();
        const root = this.renderScene.root;
        const currWindow = this.window;
        if (!currWindow) {
            return this.renderData;
        }
        let curWindowCamera = null;
        if (root) {
            for (const window of root.windows) {
                if (window.cameras.length > 0 && window === currWindow) {
                    // 对于preview可以认为一个window对应一个view
                    curWindowCamera = window.cameras[0];
                }
            }
        }
        if (!curWindowCamera) {
            return this.renderData;
        }
        const needResize = width && height && (width !== this.width || height !== this.height);
        if (needResize) {
            this.resize(width, height, currWindow);
        }
        if (curWindowCamera.width !== this.width || curWindowCamera.height !== this.height) {
            curWindowCamera.resize(width, height);
        }
        curWindowCamera.update(true);
        // 取一帧渲染完的数据
        return await new Promise((resolve) => {
            cc.director.once(cc.Director.EVENT_AFTER_DRAW, () => {
                resolve(this.copyFrameBuffer(this.window));
            });
        });
    }
}
exports.PreviewBuffer = PreviewBuffer;
PreviewBuffer.indexOfRGBA = [0, 1, 2, 3]; // r=>0 g=>1 b=>2 a=>3
PreviewBuffer.indexOfBGRA = [2, 1, 0, 3]; // r=>2 g=>1 b=>0 a=>3
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVmZmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbnRyaWJ1dGlvbnMvcHJldmlldy9idWZmZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkJBQW1DO0FBS25DLGFBQWE7QUFDYixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztBQVNqQyxNQUFhLGFBQWE7SUFnQnRCLFlBQVksWUFBb0IsRUFBRSxJQUFZLEVBQUUsUUFBYSxJQUFJO1FBZGpFLFdBQU0sR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDakMsVUFBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RELFdBQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN4RCxTQUFJLEdBQUcsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3BELGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLFVBQUssR0FBUSxJQUFJLENBQUM7UUFDbEIsWUFBTyxHQUFRLEVBQUUsQ0FBQztRQUNsQixXQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ2Qsa0NBQWtDO1FBQ2xDLFlBQU8sR0FBRyxDQUFDLElBQUksUUFBRyxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FBQztRQUd4QyxTQUFJLEdBQUcsS0FBSyxDQUFDO1FBdUZOLHFCQUFnQixHQUFHO1lBQ3RCLFFBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSztZQUNiLFFBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSztZQUNiLFFBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSztZ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QUFPLEVBQUUsRUFBRTtZQUNqQyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtnQkFDaEQsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDL0MsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7O0FBN09MLHNDQThPQztBQWhIVSx5QkFBVyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQSxzQkFBc0I7QUFDakQseUJBQVcsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUEsc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2Z4LCByZW5kZXJlciB9IGZyb20gJ2NjJztcblxuZGVjbGFyZSBjb25zdCBjYzogYW55O1xuZGVjbGFyZSBjb25zdCBjY2U6IGFueTtcbmRlY2xhcmUgY29uc3QgaXNTY2VuZU5hdGl2ZTogYm9vbGVhbjtcbi8vIEB0cy1pZ25vcmVcbm1vZHVsZS5wYXRocy5wdXNoKEFwcE1vZHVsZVBhdGgpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElXaW5kb3dJbmZvIHtcbiAgICBpbmRleDogbnVtYmVyO1xuICAgIHV1aWQ6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgd2luZG93PzogYW55O1xufVxuXG5leHBvcnQgY2xhc3MgUHJldmlld0J1ZmZlciB7XG4gICAgcHJpdmF0ZSBfbmFtZTogc3RyaW5nO1xuICAgIGRldmljZSA9IGNjLmRpcmVjdG9yLnJvb3QuZGV2aWNlO1xuICAgIHdpZHRoID0gTWF0aC5mbG9vcihjYy5kaXJlY3Rvci5yb290Lm1haW5XaW5kb3cud2lkdGgpO1xuICAgIGhlaWdodCA9IE1hdGguZmxvb3IoY2MuZGlyZWN0b3Iucm9vdC5tYWluV2luZG93LmhlaWdodCk7XG4gICAgZGF0YSA9IG5ldyBVaW50OEFycmF5KHRoaXMud2lkdGggKiB0aGlzLmhlaWdodCAqIDQpO1xuICAgIHJlbmRlclNjZW5lOiBhbnkgPSBudWxsO1xuICAgIHNjZW5lOiBhbnkgPSBudWxsO1xuICAgIHdpbmRvd3M6IGFueSA9IHt9O1xuICAgIHdpbmRvdyA9IG51bGw7XG4gICAgLy8gd2luZG93TGlzdDogSVdpbmRvd0luZm9bXSA9IFtdO1xuICAgIHJlZ2lvbnMgPSBbbmV3IGdmeC5CdWZmZXJUZXh0dXJlQ29weSgpXTtcbiAgICByZW5kZXJEYXRhOiBhbnk7XG4gICAgcXVldWU6IGFueVtdO1xuICAgIGxvY2sgPSBmYWxzZTtcbiAgICBfcmVnaXN0ZXJOYW1lPzogc3RyaW5nO1xuICAgIGNvbnN0cnVjdG9yKHJlZ2lzdGVyTmFtZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIHNjZW5lOiBhbnkgPSBudWxsKSB7XG4gICAgICAgIHRoaXMucmVuZGVyRGF0YSA9IHtcbiAgICAgICAgICAgIHdpZHRoOiB0aGlzLndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmhlaWdodCxcbiAgICAgICAgICAgIGJ1ZmZlcjogdGhpcy5kYXRhLFxuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5fcmVnaXN0ZXJOYW1lID0gcmVnaXN0ZXJOYW1lO1xuICAgICAgICB0aGlzLm9uTG9hZFNjZW5lKHNjZW5lKTtcbiAgICAgICAgdGhpcy5yZWdpb25zWzBdLnRleEV4dGVudC53aWR0aCA9IHRoaXMud2lkdGg7XG4gICAgICAgIHRoaXMucmVnaW9uc1swXS50ZXhFeHRlbnQuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7XG4gICAgICAgIHRoaXMuY3JlYXRlV2luZG93KCk7XG4gICAgICAgIHRoaXMucXVldWUgPSBbXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVzaXplKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCB3aW5kb3c6IGFueSA9IG51bGwpIHtcbiAgICAgICAgd2luZG93IHx8ICh3aW5kb3cgPSB0aGlzLndpbmRvdyk7XG4gICAgICAgIC8vIG9ubHkgcmVzaXplIHdoZW4gd2luZG93IGlzIHJlbmRlciB3aW5kb3dcbiAgICAgICAgaWYgKCF3aW5kb3cpIHJldHVybjtcbiAgICAgICAgd2lkdGggPSBNYXRoLmZsb29yKHdpZHRoKTtcbiAgICAgICAgaGVpZ2h0ID0gTWF0aC5mbG9vcihoZWlnaHQpO1xuICAgICAgICB0aGlzLnJlbmRlckRhdGEud2lkdGggPSB0aGlzLndpZHRoID0gd2lkdGg7XG4gICAgICAgIHRoaXMucmVuZGVyRGF0YS5oZWlnaHQgPSB0aGlzLmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgdGhpcy5yZWdpb25zWzBdLnRleEV4dGVudC53aWR0aCA9IHdpZHRoO1xuICAgICAgICB0aGlzLnJlZ2lvbnNbMF0udGV4RXh0ZW50LmhlaWdodCA9IGhlaWdodDtcbiAgICAgICAgd2luZG93LnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KTtcbiAgICAgICAgdGhpcy5yZW5kZXJEYXRhLmJ1ZmZlciA9IHRoaXMuZGF0YSA9IG5ldyBVaW50OEFycmF5KHRoaXMud2lkdGggKiB0aGlzLmhlaWdodCAqIDQpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBXQVJOSU5HOiBETydOT1QgVVNFIElUIEJFRk9SRSBEUkFXISEhXG4gICAgICovXG4gICAgcHVibGljIGNsZWFyKCkge1xuICAgICAgICAvLyBoYWNrOiByZXNpemUgd2lkdGggYW5kIGhlaWdodCB3aXRoIDAgd2lsbCBiZSBjbGVhciBidWZmLHJlYWx0aW1lIGNsZWFyIGFsbCBkYXRhXG4gICAgICAgIGlmICghaXNTY2VuZU5hdGl2ZSkge1xuICAgICAgICAgICAgdGhpcy5yZXNpemUoMCwgMCwgdGhpcy53aW5kb3cpOyAvLyDljp/nlJ/lnLrmma/kvJrmiqXplJlcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlc2l6ZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgdGhpcy53aW5kb3cpO1xuICAgIH1cblxuICAgIGNyZWF0ZVdpbmRvdyh1dWlkOiBzdHJpbmcgfCBudWxsID0gbnVsbCkge1xuICAgICAgICBpZiAodXVpZCAmJiB0aGlzLndpbmRvd3NbdXVpZF0pIHtcbiAgICAgICAgICAgIHRoaXMud2luZG93ID0gdGhpcy53aW5kb3dzW3V1aWRdO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJvb3QgPSBjYy5kaXJlY3Rvci5yb290O1xuICAgICAgICBjb25zdCByZW5kZXJQYXNzSW5mbyA9IG5ldyBnZnguUmVuZGVyUGFzc0luZm8oXG4gICAgICAgICAgICBbbmV3IGdmeC5Db2xvckF0dGFjaG1lbnQocm9vdC5tYWluV2luZG93LnN3YXBjaGFpbi5jb2xvclRleHR1cmUuZm9ybWF0KV0sXG4gICAgICAgICAgICBuZXcgZ2Z4LkRlcHRoU3RlbmNpbEF0dGFjaG1lbnQocm9vdC5tYWluV2luZG93LnN3YXBjaGFpbi5kZXB0aFN0ZW5jaWxUZXh0dXJlLmZvcm1hdCksXG4gICAgICAgICk7XG4gICAgICAgIHJlbmRlclBhc3NJbmZvLmNvbG9yQXR0YWNobWVudHNbMF0uYmFycmllciA9IHJvb3QuZGV2aWNlLmdldEdlbmVyYWxCYXJyaWVyKG5ldyBnZnguR2VuZXJhbEJhcnJpZXJJbmZvKDAsIGdmeC5BY2Nlc3NGbGFnQml0LkZSQUdNRU5UX1NIQURFUl9SRUFEX1RFWFRVUkUpKTtcbiAgICAgICAgY29uc3Qgd2luZG93ID0gcm9vdC5jcmVhdGVXaW5kb3coe1xuICAgICAgICAgICAgdGl0bGU6IHRoaXMuX25hbWUsXG4gICAgICAgICAgICB3aWR0aDogdGhpcy53aWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogdGhpcy5oZWlnaHQsXG4gICAgICAgICAgICByZW5kZXJQYXNzSW5mbyxcbiAgICAgICAgICAgIGlzT2Zmc2NyZWVuOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy53aW5kb3cgPSB3aW5kb3c7XG4gICAgICAgIHV1aWQgJiYgKHRoaXMud2luZG93c1t1dWlkXSA9IHdpbmRvdyk7XG4gICAgfVxuXG4gICAgcmVtb3ZlV2luZG93KHV1aWQ6IHN0cmluZykge1xuICAgICAgICBpZiAodXVpZCAmJiB0aGlzLndpbmRvd3NbdXVpZF0pIHtcbiAgICAgICAgICAgIGNjLmRpcmVjdG9yLnJvb3QuZGVzdHJveVdpbmRvdyh0aGlzLndpbmRvd3NbdXVpZF0pO1xuICAgICAgICAgICAgaWYgKHRoaXMud2luZG93c1t1dWlkXSA9PT0gdGhpcy53aW5kb3cpIHRoaXMud2luZG93ID0gbnVsbDtcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLndpbmRvd3NbdXVpZF07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBvbkxvYWRTY2VuZShzY2VuZTogYW55KSB7XG4gICAgICAgIHRoaXMud2luZG93cyA9IHt9O1xuICAgICAgICB0aGlzLnNjZW5lID0gc2NlbmU7XG4gICAgICAgIHRoaXMucmVuZGVyU2NlbmUgPSBzY2VuZS5yZW5kZXJTY2VuZTtcblxuICAgIH1cblxuICAgIHN3aXRjaENhbWVyYXMoY2FtZXJhOiBhbnksIGN1cnJXaW5kb3c6IGFueSkge1xuICAgICAgICBpZiAoY3VycldpbmRvdykge1xuICAgICAgICAgICAgY2FtZXJhLmlzV2luZG93U2l6ZSA9IGZhbHNlO1xuICAgICAgICAgICAgY2FtZXJhLmlzRW5hYmxlID0gdHJ1ZTtcbiAgICAgICAgICAgIGNhbWVyYS5jaGFuZ2VUYXJnZXRXaW5kb3coY3VycldpbmRvdyk7XG4gICAgICAgICAgICBjYy5kaXJlY3Rvci5yb290LnRlbXBXaW5kb3cgPSBjdXJyV2luZG93O1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIG5lZWRJbnZlcnRHRlhBcGkgPSBbXG4gICAgICAgIGdmeC5BUEkuR0xFUzIsXG4gICAgICAgIGdmeC5BUEkuR0xFUzMsXG4gICAgICAgIGdmeC5BUEkuV0VCR0wsXG4gICAgICAgIGdmeC5BUEkuV0VCR0wyLFxuICAgIF07XG5cbiAgICBjb3B5RnJhbWVCdWZmZXIod2luZG93OiBhbnkgPSBudWxsKSB7XG4gICAgICAgIHdpbmRvdyB8fCAod2luZG93ID0gdGhpcy53aW5kb3cpO1xuICAgICAgICBpZiAoIXdpbmRvdyB8fCAhd2luZG93LmZyYW1lYnVmZmVyKSByZXR1cm4gdGhpcy5yZW5kZXJEYXRhO1xuICAgICAgICB0aGlzLmRldmljZS5jb3B5VGV4dHVyZVRvQnVmZmVycyhcbiAgICAgICAgICAgIHdpbmRvdy5mcmFtZWJ1ZmZlci5jb2xvclRleHR1cmVzWzBdLFxuICAgICAgICAgICAgW25ldyBVaW50OEFycmF5KHRoaXMucmVuZGVyRGF0YS5idWZmZXIuYnVmZmVyKV0sXG4gICAgICAgICAgICB0aGlzLnJlZ2lvbnNcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLmZvcm1hdEJ1ZmZlcihcbiAgICAgICAgICAgIHRoaXMucmVuZGVyRGF0YS5idWZmZXIsXG4gICAgICAgICAgICAhdGhpcy5uZWVkSW52ZXJ0R0ZYQXBpLmluY2x1ZGVzKHRoaXMuZGV2aWNlLmdmeEFQSSksXG4gICAgICAgICAgICB0aGlzLmRldmljZS5nZnhBUEkgPT09IGdmeC5BUEkuTUVUQUxcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJEYXRhO1xuICAgIH1cblxuICAgIHN0YXRpYyBpbmRleE9mUkdCQSA9IFswLCAxLCAyLCAzXTsvLyByPT4wIGc9PjEgYj0+MiBhPT4zXG4gICAgc3RhdGljIGluZGV4T2ZCR1JBID0gWzIsIDEsIDAsIDNdOy8vIHI9PjIgZz0+MSBiPT4wIGE9PjNcbiAgICBmb3JtYXRCdWZmZXIoYnVmZmVyOiBVaW50OEFycmF5LCBuZWVkSW52ZXJ0OiBib29sZWFuLCBjb252ZXJzaW9uQkdSQTogYm9vbGVhbikge1xuICAgICAgICBpZiAoIW5lZWRJbnZlcnQpIHJldHVybiBidWZmZXI7XG5cbiAgICAgICAgbGV0IHN0YXJ0SW5kZXgsIGludmVydEluZGV4O1xuICAgICAgICBjb25zdCBWX1VfVmVjNCA9IHsgcjogMCwgZzogMCwgYjogMCwgYTogMCB9O1xuXG4gICAgICAgIGNvbnN0IGluZGV4QXJyID0gY29udmVyc2lvbkJHUkEgPyBQcmV2aWV3QnVmZmVyLmluZGV4T2ZCR1JBIDogUHJldmlld0J1ZmZlci5pbmRleE9mUkdCQTtcblxuICAgICAgICBmb3IgKGxldCB3ID0gMDsgdyA8IHRoaXMucmVuZGVyRGF0YS53aWR0aDsgdysrKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBoID0gMDsgaCA8PSB0aGlzLnJlbmRlckRhdGEuaGVpZ2h0IC8gMjsgaCsrKSB7XG5cbiAgICAgICAgICAgICAgICBzdGFydEluZGV4ID0gKGggKiB0aGlzLnJlbmRlckRhdGEud2lkdGggKyB3KSAqIDQ7XG4gICAgICAgICAgICAgICAgLy8gaW52ZXJ0IGluZGV4XG4gICAgICAgICAgICAgICAgaW52ZXJ0SW5kZXggPSAoKHRoaXMucmVuZGVyRGF0YS5oZWlnaHQgLSBoKSAqIHRoaXMucmVuZGVyRGF0YS53aWR0aCArIHcpICogNDtcblxuICAgICAgICAgICAgICAgIC8vIGZsaXAgWVxuICAgICAgICAgICAgICAgIFZfVV9WZWM0LnIgPSBidWZmZXJbc3RhcnRJbmRleCArIGluZGV4QXJyWzBdXTtcbiAgICAgICAgICAgICAgICBWX1VfVmVjNC5nID0gYnVmZmVyW3N0YXJ0SW5kZXggKyBpbmRleEFyclsxXV07XG4gICAgICAgICAgICAgICAgVl9VX1ZlYzQuYiA9IGJ1ZmZlcltzdGFydEluZGV4ICsgaW5kZXhBcnJbMl1dO1xuICAgICAgICAgICAgICAgIFZfVV9WZWM0LmEgPSBidWZmZXJbc3RhcnRJbmRleCArIGluZGV4QXJyWzNdXTtcblxuICAgICAgICAgICAgICAgIGJ1ZmZlcltzdGFydEluZGV4ICsgMF0gPSBidWZmZXJbaW52ZXJ0SW5kZXggKyBpbmRleEFyclswXV07XG4gICAgICAgICAgICAgICAgYnVmZmVyW3N0YXJ0SW5kZXggKyAxXSA9IGJ1ZmZlcltpbnZlcnRJbmRleCArIGluZGV4QXJyWzFdXTtcbiAgICAgICAgICAgICAgICBidWZmZXJbc3RhcnRJbmRleCArIDJdID0gYnVmZmVyW2ludmVydEluZGV4ICsgaW5kZXhBcnJbMl1dO1xuICAgICAgICAgICAgICAgIGJ1ZmZlcltzdGFydEluZGV4ICsgM10gPSBidWZmZXJbaW52ZXJ0SW5kZXggKyBpbmRleEFyclszXV07XG5cbiAgICAgICAgICAgICAgICBidWZmZXJbaW52ZXJ0SW5kZXggKyAwXSA9IFZfVV9WZWM0LnI7XG4gICAgICAgICAgICAgICAgYnVmZmVyW2ludmVydEluZGV4ICsgMV0gPSBWX1VfVmVjNC5nO1xuICAgICAgICAgICAgICAgIGJ1ZmZlcltpbnZlcnRJbmRleCArIDJdID0gVl9VX1ZlYzQuYjtcbiAgICAgICAgICAgICAgICBidWZmZXJbaW52ZXJ0SW5kZXggKyAzXSA9IFZfVV9WZWM0LmE7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBidWZmZXI7XG4gICAgfVxuXG4gICAgZ2V0SW1hZ2VEYXRhSW5RdWV1ZSh3aWR0aDogbnVtYmVyLCBoZWlnaHQ6IG51bWJlciwgZXZlbnQ6IGFueSkge1xuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICAgICAgICB3aWR0aDogTWF0aC5mbG9vcih3aWR0aCksXG4gICAgICAgICAgICBoZWlnaHQ6IE1hdGguZmxvb3IoaGVpZ2h0KSxcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHtcbiAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5zdGVwKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc3RlcCgpIHtcbiAgICAgICAgaWYgKHRoaXMubG9jaykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubG9jayA9IHRydWU7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLnF1ZXVlLnNoaWZ0KCk7XG4gICAgICAgIGlmICghaXRlbSkge1xuICAgICAgICAgICAgdGhpcy5sb2NrID0gZmFsc2U7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBwYXJhbXMsIGV2ZW50IH0gPSBpdGVtO1xuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5nZXRJbWFnZURhdGEocGFyYW1zLndpZHRoLCBwYXJhbXMuaGVpZ2h0KTtcbiAgICAgICAgZXZlbnQucmVwbHkobnVsbCwgZGF0YSk7XG4gICAgICAgIHRoaXMubG9jayA9IGZhbHNlO1xuICAgICAgICB0aGlzLnN0ZXAoKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRJbWFnZURhdGEod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJlbmRlclNjZW5lKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJEYXRhO1xuICAgICAgICB9XG4gICAgICAgIGNjZS5FbmdpbmUucmVwYWludEluRWRpdE1vZGUoKTtcblxuICAgICAgICBjb25zdCByb290ID0gdGhpcy5yZW5kZXJTY2VuZS5yb290O1xuICAgICAgICBjb25zdCBjdXJyV2luZG93ID0gdGhpcy53aW5kb3c7XG4gICAgICAgIGlmICghY3VycldpbmRvdykge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVuZGVyRGF0YTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBjdXJXaW5kb3dDYW1lcmE6IHJlbmRlcmVyLnNjZW5lLkNhbWVyYSB8IG51bGwgfCB1bmRlZmluZWQgPSBudWxsO1xuICAgICAgICBpZiAocm9vdCkge1xuICAgICAgICAgICAgZm9yIChjb25zdCB3aW5kb3cgb2Ygcm9vdC53aW5kb3dzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5jYW1lcmFzLmxlbmd0aCA+IDAgJiYgd2luZG93ID09PSBjdXJyV2luZG93KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIOWvueS6jnByZXZpZXflj6/ku6XorqTkuLrkuIDkuKp3aW5kb3flr7nlupTkuIDkuKp2aWV3XG4gICAgICAgICAgICAgICAgICAgIGN1cldpbmRvd0NhbWVyYSA9IHdpbmRvdy5jYW1lcmFzWzBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY3VyV2luZG93Q2FtZXJhKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZW5kZXJEYXRhO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbmVlZFJlc2l6ZSA9IHdpZHRoICYmIGhlaWdodCAmJiAod2lkdGggIT09IHRoaXMud2lkdGggfHwgaGVpZ2h0ICE9PSB0aGlzLmhlaWdodCk7XG4gICAgICAgIGlmIChuZWVkUmVzaXplKSB7XG4gICAgICAgICAgICB0aGlzLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0LCBjdXJyV2luZG93KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjdXJXaW5kb3dDYW1lcmEud2lkdGggIT09IHRoaXMud2lkdGggfHwgY3VyV2luZG93Q2FtZXJhLmhlaWdodCAhPT0gdGhpcy5oZWlnaHQpIHtcbiAgICAgICAgICAgIGN1cldpbmRvd0NhbWVyYS5yZXNpemUod2lkdGgsIGhlaWdodCk7XG4gICAgICAgIH1cblxuICAgICAgICBjdXJXaW5kb3dDYW1lcmEudXBkYXRlKHRydWUpO1xuXG4gICAgICAgIC8vIOWPluS4gOW4p+a4suafk+WujOeahOaVsOaNrlxuICAgICAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgICAgICAgIGNjLmRpcmVjdG9yLm9uY2UoY2MuRGlyZWN0b3IuRVZFTlRfQUZURVJfRFJBVywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcy5jb3B5RnJhbWVCdWZmZXIodGhpcy53aW5kb3cpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=