"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Menu = void 0;
const tslib_1 = require("tslib");
const events_1 = tslib_1.__importDefault(require("events"));
const remote_1 = require("@electron/remote");
const utils_1 = require("../utils");
const base_menu_1 = require("./template/base-menu");
const base_1 = require("../base");
class Menu extends events_1.default {
    constructor() {
        super(...arguments);
        this.setTimeoutId = null;
        this.nodeMenuItems = [];
        this.nodeMenuItemDataMap = new Map();
        this.popupCreateMenu = () => {
            // 如果在面板内才弹菜单
            const window = (0, remote_1.getCurrentWindow)();
            const point = remote_1.screen.getCursorScreenPoint();
            if (!(0, utils_1.contains)(point, window.getBounds()))
                return;
            base_1.MessageMgr.Instance.send(base_1.MessageType.ShowCreateNodeWindow);
        };
    }
    static get Instance() {
        if (!this._instance) {
            this._instance = new Menu();
        }
        return this._instance;
    }
    emitMenuItemChange() {
        this.setTimeoutId && clearTimeout(this.setTimeoutId);
        this.setTimeoutId = setTimeout(() => {
            base_1.MessageMgr.Instance.send(base_1.MessageType.CreateMenuChange);
        }, 50);
    }
    addItemPath(path, data) {
        if (!this.nodeMenuItems.includes(path)) {
            this.nodeMenuItems.push(path);
        }
        this.nodeMenuItemDataMap.set(path, data);
        this.emitMenuItemChange();
    }
    removeItemPath(path) {
        const index = this.nodeMenuItems.indexOf(path);
        if (index !== -1) {
            this.nodeMenuItems.splice(index, 1);
            this.nodeMenuItemDataMap.delete(path);
            this.emitMenuItemChange();
        }
    }
    getShaderNodeMenu(onClick) {
        const menuItems = [];
        const menu = (menuPath) => {
            // 解析菜单路径字符串为菜单项数组
            function parseMenuPath(menuPath) {
                return menuPath.split('/').map((label) => ({ label }));
            }
            // 循环迭代方式构建菜单项
            const buildMenuIteratively = (paths, currentMenuItems, baseMenuPath, fullMenuPath) => {
                const label = paths.shift();
                if (!label)
                    return;
                if (!fullMenuPath) {
                    fullMenuPath = label;
                }
                else {
                    fullMenuPath += '/' + label;
                }
                let menuItem = currentMenuItems.find(item => item.label === label);
                if (!menuItem) {
                    menuItem = { label, submenu: [] };
                    currentMenuItems.push(menuItem);
                }
                if (paths.length === 0) {
                    const addOptions = this.nodeMenuItemDataMap.get(baseMenuPath);
                    menuItem.addOptions = addOptions;
                    if (onClick) {
                        delete menuItem.submenu;
                        menuItem.click = () => {
                            onClick(addOptions);
                        };
                    }
                }
                buildMenuIteratively(paths, menuItem.submenu, baseMenuPath, fullMenuPath);
            };
            // 传入菜单路径字符串，构建相应的菜单项
            const menuPathItems = parseMenuPath(menuPath);
            // 使用循环迭代方式构建菜单项
            buildMenuIteratively(menuPath.split('/'), menuItems, menuPath, '');
        };
        this.nodeMenuItems.forEach((menuPath) => menu(menuPath));
        return menuItems;
    }
    popupMenu(event) {
        const menu = (0, base_menu_1.getBaseMenuItem)(event, this.popupCreateMenu);
        Editor.Menu.popup({ menu });
        return true;
    }
}
exports.Menu = Menu;
Menu._instance = null;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2hhZGVyLWdyYXBoL21lbnUvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLDREQUFrQztBQUNsQyw2Q0FBNEQ7QUFJNUQsb0NBQW9DO0FBQ3BDLG9EQUF1RDtBQUN2RCxrQ0FBeUU7QUFNekUsTUFBYSxJQUFLLFNBQVEsZ0JBQVk7SUFBdEM7O1FBV1ksaUJBQVksR0FBMEIsSUFBSSxDQUFDO1FBRTNDLGtCQUFhLEdBQWEsRUFBRSxDQUFDO1FBQzdCLHdCQUFtQixHQUF1QyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBMkU1RSxvQkFBZSxHQUFHLEdBQUcsRUFBRTtZQUNuQixhQUFhO1lBQ2IsTUFBTSxNQUFNLEdBQUcsSUFBQSx5QkFBZ0IsR0FBRSxDQUFDO1lBQ2xDLE1BQU0sS0FBSyxHQUFHLGVBQU0sQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1lBQzVDLElBQUksQ0FBQyxJQUFBLGdCQUFRLEVBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQztnQkFBRSxPQUFPO1lBRWpELGlCQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxrQkFBVyxDQUFDLG9CQUFvQixDQUFDLENBQUM7UUFDL0QsQ0FBQyxDQUFDO0lBQ04sQ0FBQztJQTdGVSxNQUFNLEtBQUssUUFBUTtRQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNqQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7U0FDL0I7UUFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDMUIsQ0FBQztJQU9ELGtCQUFrQjtRQUNkLElBQUksQ0FBQyxZQUFZLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNyRCxJQUFJLENBQUMsWUFBWSxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDaEMsaUJBQVUsQ0FB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QjtZQUNyQixNQUFNLGFBQWEsR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDOUMsZ0JBQWdCO1lBQ2hCLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN2RSxDQUFDLENBQUM7UUFDRixJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDekQsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUF5RDtRQUMvRCxNQUFNLElBQUksR0FBRyxJQUFBLDJCQUFlLEVBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMxRCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDNUIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQzs7QUF2Rkwsb0JBaUdDO0FBL0ZVLGNBQVMsR0FBZ0IsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgZ2V0Q3VycmVudFdpbmRvdywgc2NyZWVuIH0gZnJvbSAnQGVsZWN0cm9uL3JlbW90ZSc7XG5cbmltcG9ydCB0eXBlIHsgQmxvY2tNb3VzZUV2ZW50LCBHcmFwaE1vdXNlRXZlbnQsIExpbmVNb3VzZUV2ZW50IH0gZnJvbSAnLi4vLi4vYmxvY2stZm9yZ2UvZXZlbnQnO1xuXG5pbXBvcnQgeyBjb250YWlucyB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IGdldEJhc2VNZW51SXRlbSB9IGZyb20gJy4vdGVtcGxhdGUvYmFzZS1tZW51JztcbmltcG9ydCB7IE1lc3NhZ2VNZ3IsIE1lc3NhZ2VUeXBlLCBHcmFwaEVkaXRvckFkZE9wdGlvbnMgfSBmcm9tICcuLi9iYXNlJztcblxuZXhwb3J0IGludGVyZmFjZSBNZW51VGVtcGxhdGVJdGVtIGV4dGVuZHMgRWRpdG9yLk1lbnUuTWVudVRlbXBsYXRlSXRlbSB7XG4gICAgYWRkT3B0aW9ucz86IEdyYXBoRWRpdG9yQWRkT3B0aW9ucztcbn1cblxuZXhwb3J0IGNsYXNzIE1lbnUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuXG4gICAgc3RhdGljIF9pbnN0YW5jZTogTWVudSB8IG51bGwgPSBudWxsO1xuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgSW5zdGFuY2UoKTogTWVudSB7XG4gICAgICAgIGlmICghdGhpcy5faW5zdGFuY2UpIHtcbiAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlID0gbmV3IE1lbnUoKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5faW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzZXRUaW1lb3V0SWQ6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cbiAgICBwcml2YXRlIG5vZGVNZW51SXRlbXM6IHN0cmluZ1tdID0gW107XG4gICAgcHJpdmF0ZSBub2RlTWVudUl0ZW1EYXRhTWFwOiBNYXA8c3RyaW5nLCBHcmFwaEVkaXRvckFkZE9wdGlvbnM+ID0gbmV3IE1hcCgpO1xuXG4gICAgZW1pdE1lbnVJdGVtQ2hhbmdlKCkge1xuICAgICAgICB0aGlzLnNldFRpbWVvdXRJZCAmJiBjbGVhclRpbWVvdXQodGhpcy5zZXRUaW1lb3V0SWQpO1xuICAgICAgICB0aGlzLnNldFRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgTWVzc2FnZU1nci5JbnN0YW5jZS5zZW5kKE1lc3NhZ2VUeXBlLkNyZWF0ZU1lbnVDaGFuZ2UpO1xuICAgICAgICB9LCA1MCk7XG4gICAgfVxuXG4gICAgYWRkSXRlbVBhdGgocGF0aDogc3RyaW5nLCBkYXRhOiBHcmFwaEVkaXRvckFkZE9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCF0aGlzLm5vZGVNZW51SXRlbXMuaW5jbHVkZXMocGF0aCkpIHtcbiAgICAgICAgICAgIHRoaXMubm9kZU1lbnVJdGVtcy5wdXNoKHBhdGgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubm9kZU1lbnVJdGVtRGF0YU1hcC5zZXQocGF0aCwgZGF0YSk7XG4gICAgICAgIHRoaXMuZW1pdE1lbnVJdGVtQ2hhbmdlKCk7XG4gICAgfVxuXG4gICAgcmVtb3ZlSXRlbVBhdGgocGF0aDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5ub2RlTWVudUl0ZW1zLmluZGV4T2YocGF0aCk7XG4gICAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgIHRoaXMubm9kZU1lbnVJdGVtcy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICAgICAgdGhpcy5ub2RlTWVudUl0ZW1EYXRhTWFwLmRlbGV0ZShwYXRoKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdE1lbnVJdGVtQ2hhbmdlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRTaGFkZXJOb2RlTWVudShvbkNsaWNrPzogKG9wdGlvbnM6IEdyYXBoRWRpdG9yQWRkT3B0aW9ucykgPT4gdm9pZCkge1xuICAgICAgICBjb25zdCBtZW51SXRlbXM6IE1lbnVUZW1wbGF0ZUl0ZW1bXSA9IFtdO1xuXG4gICAgICAgIGNvbnN0IG1lbnUgPSAobWVudVBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgLy8g6Kej5p6Q6I+c5Y2V6Lev5b6E5a2X56ym5Liy5Li66I+c5Y2V6aG55pWw57uEXG4gICAgICAgICAgICBmdW5jdGlvbiBwYXJzZU1lbnVQYXRoKG1lbnVQYXRoOiBzdHJpbmcpOiBNZW51VGVtcGxhdGVJdGVtW10ge1xuICAgICAgICAgICAgICAgIHJldHVybiBtZW51UGF0aC5zcGxpdCgnLycpLm1hcCgobGFiZWwpID0+ICh7IGxhYmVsIH0pKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIOW+queOr+i/reS7o+aWueW8j+aehOW7uuiPnOWNlemhuVxuICAgICAgICAgICAgY29uc3QgYnVpbGRNZW51SXRlcmF0aXZlbHkgPSAocGF0aHM6IHN0cmluZ1tdLCBjdXJyZW50TWVudUl0ZW1zOiBNZW51VGVtcGxhdGVJdGVtW10sIGJhc2VNZW51UGF0aDogc3RyaW5nLCBmdWxsTWVudVBhdGg6IHN0cmluZyk6IHZvaWQgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gcGF0aHMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICBpZiAoIWxhYmVsKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKCFmdWxsTWVudVBhdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZnVsbE1lbnVQYXRoID0gbGFiZWw7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZnVsbE1lbnVQYXRoICs9ICcvJyArIGxhYmVsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsZXQgbWVudUl0ZW06IE1lbnVUZW1wbGF0ZUl0ZW0gfCB1bmRlZmluZWQgPSBjdXJyZW50TWVudUl0ZW1zLmZpbmQoaXRlbSA9PiBpdGVtLmxhYmVsID09PSBsYWJlbCk7XG4gICAgICAgICAgICAgICAgaWYgKCFtZW51SXRlbSkge1xuICAgICAgICAgICAgICAgICAgICBtZW51SXRlbSA9IHsgbGFiZWwsIHN1Ym1lbnU6IFtdIH07XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRNZW51SXRlbXMucHVzaChtZW51SXRlbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwYXRocy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWRkT3B0aW9ucyA9IHRoaXMubm9kZU1lbnVJdGVtRGF0YU1hcC5nZXQoYmFzZU1lbnVQYXRoKSE7XG4gICAgICAgICAgICAgICAgICAgIG1lbnVJdGVtLmFkZE9wdGlvbnMgPSBhZGRPcHRpb25zO1xuICAgICAgICAgICAgICAgICAgICBpZiAob25DbGljaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG1lbnVJdGVtLnN1Ym1lbnU7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZW51SXRlbS5jbGljayA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrKGFkZE9wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBidWlsZE1lbnVJdGVyYXRpdmVseShwYXRocywgbWVudUl0ZW0uc3VibWVudSEsIGJhc2VNZW51UGF0aCwgZnVsbE1lbnVQYXRoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyDkvKDlhaXoj5zljZXot6/lvoTlrZfnrKbkuLLvvIzmnoTlu7rnm7jlupTnmoToj5zljZXpoblcbiAgICAgICAgICAgIGNvbnN0IG1lbnVQYXRoSXRlbXMgPSBwYXJzZU1lbnVQYXRoKG1lbnVQYXRoKTtcbiAgICAgICAgICAgIC8vIOS9v+eUqOW+queOr+i/reS7o+aWueW8j+aehOW7uuiPnOWNlemhuVxuICAgICAgICAgICAgYnVpbGRNZW51SXRlcmF0aXZlbHkobWVudVBhdGguc3BsaXQoJy8nKSwgbWVudUl0ZW1zLCBtZW51UGF0aCwgJycpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLm5vZGVNZW51SXRlbXMuZm9yRWFjaCgobWVudVBhdGgpID0+IG1lbnUobWVudVBhdGgpKTtcbiAgICAgICAgcmV0dXJuIG1lbnVJdGVtcztcbiAgICB9XG5cbiAgICBwb3B1cE1lbnUoZXZlbnQ6IEJsb2NrTW91c2VFdmVudCB8IEdyYXBoTW91c2VFdmVudCB8IExpbmVNb3VzZUV2ZW50KTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IG1lbnUgPSBnZXRCYXNlTWVudUl0ZW0oZXZlbnQsIHRoaXMucG9wdXBDcmVhdGVNZW51KTtcbiAgICAgICAgRWRpdG9yLk1lbnUucG9wdXAoeyBtZW51IH0pO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwb3B1cENyZWF0ZU1lbnUgPSAoKSA9PiB7XG4gICAgICAgIC8vIOWmguaenOWcqOmdouadv+WGheaJjeW8ueiPnOWNlVxuICAgICAgICBjb25zdCB3aW5kb3cgPSBnZXRDdXJyZW50V2luZG93KCk7XG4gICAgICAgIGNvbnN0IHBvaW50ID0gc2NyZWVuLmdldEN1cnNvclNjcmVlblBvaW50KCk7XG4gICAgICAgIGlmICghY29udGFpbnMocG9pbnQsIHdpbmRvdy5nZXRCb3VuZHMoKSkpIHJldHVybjtcblxuICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLnNlbmQoTWVzc2FnZVR5cGUuU2hvd0NyZWF0ZU5vZGVXaW5kb3cpO1xuICAgIH07XG59XG4iXX0=