"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphAssetMgr = void 0;
const path_1 = require("path");
const fs_extra_1 = require("fs-extra");
const internal_1 = require("./internal");
const global_exports_1 = require("../global-exports");
const utils_1 = require("../utils");
const index_1 = require("./index");
const declare_1 = require("../declare");
/**
 * 用于处理 shader-graph Asset 资源的存储
 */
class GraphAssetMgr {
    constructor() {
        this.assetUuid = '';
        this.assetData = '';
        this.shaderGraphAssetInfo = null;
    }
    static get Instance() {
        if (!this._instance) {
            this._instance = new GraphAssetMgr();
        }
        return this._instance;
    }
    get uuid() {
        return this.assetUuid || '';
    }
    async openAsset() {
        await index_1.GraphConfigMgr.Instance.load();
        const isReady = await index_1.MessageMgr.Instance.checkSceneReady();
        if (isReady) {
            index_1.MaskMgr.Instance.show(internal_1.MaskType.WaitLoad);
            await (0, declare_1.declareGraphBlock)();
            await this.load();
        }
        else {
            index_1.MessageMgr.Instance.setSceneReady(false);
            index_1.MaskMgr.Instance.show(internal_1.MaskType.WaitSceneReady);
        }
    }
    async load(uuid) {
        uuid = uuid || await Editor.Profile.getConfig(global_exports_1.PACKAGE_JSON.name, 'asset-uuid', 'local');
        if (!uuid) {
            index_1.MaskMgr.Instance.show(internal_1.MaskType.NeedCreateNewAsset);
            return false;
        }
        this.assetUuid = uuid;
        this.shaderGraphAssetInfo = await Editor.Message.request('asset-db', 'query-asset-info', uuid);
        if (!this.shaderGraphAssetInfo && index_1.GraphDataMgr.Instance.getGraphAssetData()) {
            index_1.MaskMgr.Instance.show(internal_1.MaskType.AssetMissing);
            return false;
        }
        if (this.shaderGraphAssetInfo) {
            this.assetData = (0, fs_extra_1.readFileSync)(this.shaderGraphAssetInfo.file, 'utf8');
            index_1.GraphDataMgr.Instance.setGraphDataByAsset(this.shaderGraphAssetInfo, this.assetData);
        }
        else {
            this.assetData = '';
        }
        if (!this.assetData) {
            index_1.MaskMgr.Instance.show(internal_1.MaskType.NeedCreateNewAsset);
            return false;
        }
        index_1.MaskMgr.Instance.hide(internal_1.MaskType.AssetMissing);
        index_1.MaskMgr.Instance.hide(internal_1.MaskType.NeedCreateNewAsset);
        index_1.MessageMgr.Instance.send(index_1.MessageType.AssetLoaded);
        return true;
    }
    /**
     * 打开指定 Shader Graph 资源
     */
    async open() {
        try {
            const result = await Editor.Dialog.select({
                title: Editor.I18n.t('shader-graph.messages.titles.open'),
                path: global_exports_1.PROJECT_PATH,
                type: 'file',
                multi: false,
                filters: [{ name: 'Shader Graph', extensions: ['shadergraph'] }],
            });
            const uuid = await (0, utils_1.getAssetUuidByPath)(result.filePaths[0]);
            await Editor.Profile.setConfig(global_exports_1.PACKAGE_JSON.name, 'asset-uuid', uuid, 'local');
            return await this.load(uuid);
        }
        catch (err) {
            console.error(err);
            return false;
        }
    }
    /**
     * 新建 Shader Graph 资源
     */
    async createNew(type) {
        try {
            const result = await Editor.Dialog.save({
                title: Editor.I18n.t('shader-graph.messages.save.title'),
                path: (0, path_1.join)(Editor.Project.path, 'assets', 'New Shader Graph'),
                filters: [{
                        name: 'New Shader Graph',
                        extensions: ['shadergraph'],
                    }],
            });
            const url = (0, utils_1.convertToProjectDbUrl)(result.filePath);
            const defaultShaderGraph = await index_1.GraphDataMgr.createDefaultShaderGraph(type);
            const asset = await this.createAsset(url, defaultShaderGraph);
            if (asset) {
                return await this.load(asset.uuid);
            }
            return false;
        }
        catch (err) {
            console.error(err);
            return false;
        }
    }
    /**
     * 保存
     */
    async save() {
        try {
            if (!this.shaderGraphAssetInfo)
                return false;
            index_1.GraphDataMgr.Instance.syncLastGraphData();
            console.time('save');
            Editor.Message.request('asset-db', 'save-asset', this.shaderGraphAssetInfo.uuid, index_1.GraphDataMgr.Instance.getGraphAssetData()).then(() => {
                console.timeEnd('save');
            });
            index_1.GraphDataMgr.Instance.setDirty(false);
            return true;
        }
        catch (e) {
            console.error(e);
            return false;
        }
    }
    /**
     * 另存为
     */
    async saveAs() {
        try {
            const result = await Editor.Dialog.save({
                title: Editor.I18n.t('shader-graph.messages.save.title'),
                path: (0, path_1.join)(Editor.Project.path, 'assets', this.shaderGraphAssetInfo?.name || global_exports_1.DEFAULT_NAME),
                filters: [{
                        name: 'Shader Graph',
                        extensions: ['shadergraph'],
                    }],
            });
            const url = (0, utils_1.convertToProjectDbUrl)(result.filePath);
            if (!url) {
                console.debug('另存 Shader Graph 资源失败, 保存的 url 为 null');
                return false;
            }
            const asset = await this.createAsset(url, index_1.GraphDataMgr.Instance.getGraphAssetData());
            if (asset) {
                return await this.load(asset.uuid);
            }
            return false;
        }
        catch (e) {
            console.error('保存失败!', e);
            return false;
        }
    }
    /**
     * 检查是否需要保存
     */
    async checkIfSave() {
        if (this.shaderGraphAssetInfo && !(0, fs_extra_1.existsSync)(this.shaderGraphAssetInfo.file)) {
            const result = await Editor.Dialog.warn(Editor.I18n.t('shader-graph.messages.missing_assets.detail'), {
                title: Editor.I18n.t('shader-graph.messages.titles.normal'),
                default: 0,
                cancel: 1,
                buttons: [
                    Editor.I18n.t('shader-graph.buttons.save'),
                    Editor.I18n.t('shader-graph.buttons.unsaved'),
                ],
            });
            if (0 === result.response) {
                // 另存为
                return await this.saveAs();
            }
            return false;
        }
        else {
            const result = await Editor.Dialog.warn(Editor.I18n.t('shader-graph.messages.save.detail'), {
                title: Editor.I18n.t('shader-graph.messages.titles.normal'),
                default: 0,
                cancel: 1,
                buttons: [
                    Editor.I18n.t('shader-graph.buttons.save'),
                    Editor.I18n.t('shader-graph.buttons.unsaved'),
                ],
            });
            if (0 === result.response) {
                // 另存为
                return await this.save();
            }
            return false;
        }
    }
    async createAsset(url, content) {
        try {
            if (!url || !content)
                return;
            // 强制覆盖
            return await Editor.Message.request('asset-db', 'create-asset', url, content, { overwrite: true });
        }
        catch (e) {
            console.error(e);
        }
    }
    assetAdd(uuid, info) {
        if (info && info.importer) {
            index_1.MessageMgr.Instance.callSceneMethod('registerEffects', [uuid]);
        }
    }
    async assetDelete(uuid, info) {
        if (info && info.importer) {
            index_1.MessageMgr.Instance.callSceneMethod('removeEffects', [uuid]);
        }
        if (this.uuid === uuid) {
            await index_1.GraphConfigMgr.Instance.delete(uuid);
            index_1.MaskMgr.Instance.show(internal_1.MaskType.AssetMissing);
        }
    }
    assetChange(uuid, info) {
        if (info && info.importer) {
            index_1.MessageMgr.Instance.callSceneMethod('updateEffect', [uuid]);
        }
        if (this.uuid === uuid && index_1.GraphDataMgr.Instance.graphForge && index_1.GraphDataMgr.Instance.graphData) {
            try {
                // 更新名字
                const newName = (0, utils_1.getName)(info.name);
                const needToRename = index_1.GraphDataMgr.Instance.graphForge.getCurrentGraph().name !== newName;
                const dirty = index_1.GraphDataMgr.Instance.getDirty();
                if (dirty && needToRename) {
                    index_1.MaskMgr.Instance.show(internal_1.MaskType.NeedSaveBeReloadByRename);
                    return;
                }
                if (dirty)
                    return;
                if (needToRename) {
                    this.load();
                    return;
                }
                // const baseData = readFileSync(info.file, 'utf8');
                // const conflictA = this.graphForge.serialize() !== baseData;
                // const conflictB = this.graphForge.serialize(this.graphData) !== baseData;
                //
                // if (conflictA && conflictB) {
                //     MaskMgr.Instance.show(MaskType.AssetChange);
                // }
            }
            catch (e) {
                console.error(e);
            }
        }
    }
}
exports.GraphAssetMgr = GraphAssetMgr;
GraphAssetMgr._instance = null;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGgtYXNzZXQtbWdyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NoYWRlci1ncmFwaC9iYXNlL2dyYXBoLWFzc2V0LW1nci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQkFBNEI7QUFDNUIsdUNBQW9EO0FBSXBELHlDQUFzQztBQUV0QyxzREFBNkU7QUFDN0Usb0NBQThFO0FBQzlFLG1DQUF5RjtBQUN6Rix3Q0FBK0M7QUFFL0M7O0dBRUc7QUFDSCxNQUFhLGFBQWE7SUFBMUI7UUFXWSxjQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ2YsY0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNmLHlCQUFvQixHQUFxQixJQUFJLENBQUM7SUEwUDFELENBQUM7SUFuUVUsTUFBTSxLQUFLLFFBQVE7UUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDakIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLGFBQWEsRUFBRSxDQUFDO1NBQ3hDO1FBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQzFCLENBQUM7SUFNRCxJQUFJLElBQUk7UUFDSixPQUFPLElBQUksQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFFTSxLQUFLLENBQUMsU0FBUztRQUNsQixNQUFNLHNCQUFjLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBRXJDLE1BQU0sT0FBTyxHQUFHLE1BQU0sa0JBQVUsQ0FBQyxRQUFRLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDNUQsSUFBSSxPQUFPLEVBQUU7WUFDVCxlQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxtQkFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3pDLE1BQU0sSUFBQSwyQkFBaUIsR0FBRSxDQUFDO1lBQzFCLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3JCO2FBQU07WUFDSCxrQkFBVSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENB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bkMsTUFBTSxZQUFZLEdBQUcsb0JBQVksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLGVBQWUsRUFBRSxDQUFDLElBQUksS0FBSyxPQUFPLENBQUM7Z0JBRXpGLE1BQU0sS0FBSyxHQUFHLG9CQUFZLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUMvQyxJQUFJLEtBQUssSUFBSSxZQUFZLEVBQUU7b0JBQ3ZCLGVBQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLG1CQUFRLENBQUMsd0JBQXdCLENBQUMsQ0FBQztvQkFDekQsT0FBTztpQkFDVjtnQkFFRCxJQUFJLEtBQUs7b0JBQUUsT0FBTztnQkFFbEIsSUFBSSxZQUFZLEVBQUU7b0JBQ2QsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO29CQUNaLE9BQU87aUJBQ1Y7Z0JBRUQsb0RBQW9EO2dCQUNwRCw4REFBOEQ7Z0JBQzlELDRFQUE0RTtnQkFDNUUsRUFBRTtnQkFDRixnQ0FBZ0M7Z0JBQ2hDLG1EQUFtRDtnQkFDbkQsSUFBSTthQUNQO1lBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNwQjtTQUNKO0lBQ0wsQ0FBQzs7QUF0UUwsc0NBdVFDO0FBclFVLHVCQUFTLEdBQXlCLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGV4aXN0c1N5bmMsIHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzLWV4dHJhJztcblxuaW1wb3J0IHR5cGUgeyBBc3NldEluZm8gfSBmcm9tICdAY29jb3MvY3JlYXRvci10eXBlcy9lZGl0b3IvcGFja2FnZXMvYXNzZXQtZGIvQHR5cGVzL3B1YmxpYyc7XG5cbmltcG9ydCB7IE1hc2tUeXBlIH0gZnJvbSAnLi9pbnRlcm5hbCc7XG5cbmltcG9ydCB7IERFRkFVTFRfTkFNRSwgUEFDS0FHRV9KU09OLCBQUk9KRUNUX1BBVEggfSBmcm9tICcuLi9nbG9iYWwtZXhwb3J0cyc7XG5pbXBvcnQgeyBjb252ZXJ0VG9Qcm9qZWN0RGJVcmwsIGdldEFzc2V0VXVpZEJ5UGF0aCwgZ2V0TmFtZSB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IEdyYXBoQ29uZmlnTWdyLCBHcmFwaERhdGFNZ3IsIE1lc3NhZ2VNZ3IsIE1lc3NhZ2VUeXBlLCBNYXNrTWdyIH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgeyBkZWNsYXJlR3JhcGhCbG9jayB9IGZyb20gJy4uL2RlY2xhcmUnO1xuXG4vKipcbiAqIOeUqOS6juWkhOeQhiBzaGFkZXItZ3JhcGggQXNzZXQg6LWE5rqQ55qE5a2Y5YKoXG4gKi9cbmV4cG9ydCBjbGFzcyBHcmFwaEFzc2V0TWdyIHtcblxuICAgIHN0YXRpYyBfaW5zdGFuY2U6IEdyYXBoQXNzZXRNZ3IgfCBudWxsID0gbnVsbDtcblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0IEluc3RhbmNlKCk6IEdyYXBoQXNzZXRNZ3Ige1xuICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlKSB7XG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZSA9IG5ldyBHcmFwaEFzc2V0TWdyKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2luc3RhbmNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXNzZXRVdWlkID0gJyc7XG4gICAgcHJpdmF0ZSBhc3NldERhdGEgPSAnJztcbiAgICBwcml2YXRlIHNoYWRlckdyYXBoQXNzZXRJbmZvOiBBc3NldEluZm8gfCBudWxsID0gbnVsbDtcblxuICAgIGdldCB1dWlkKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmFzc2V0VXVpZCB8fCAnJztcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgb3BlbkFzc2V0KCkge1xuICAgICAgICBhd2FpdCBHcmFwaENvbmZpZ01nci5JbnN0YW5jZS5sb2FkKCk7XG5cbiAgICAgICAgY29uc3QgaXNSZWFkeSA9IGF3YWl0IE1lc3NhZ2VNZ3IuSW5zdGFuY2UuY2hlY2tTY2VuZVJlYWR5KCk7XG4gICAgICAgIGlmIChpc1JlYWR5KSB7XG4gICAgICAgICAgICBNYXNrTWdyLkluc3RhbmNlLnNob3coTWFza1R5cGUuV2FpdExvYWQpO1xuICAgICAgICAgICAgYXdhaXQgZGVjbGFyZUdyYXBoQmxvY2soKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMubG9hZCgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgTWVzc2FnZU1nci5JbnN0YW5jZS5zZXRTY2VuZVJlYWR5KGZhbHNlKTtcbiAgICAgICAgICAgIE1hc2tNZ3IuSW5zdGFuY2Uuc2hvdyhNYXNrVHlwZS5XYWl0U2NlbmVSZWFkeSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgbG9hZCh1dWlkPzogc3RyaW5nIHwgdW5kZWZpbmVkKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHV1aWQgPSB1dWlkIHx8IGF3YWl0IEVkaXRvci5Qcm9maWxlLmdldENvbmZpZyhQQUNLQUdFX0pTT04ubmFtZSwgJ2Fzc2V0LXV1aWQnLCAnbG9jYWwnKTtcbiAgICAgICAgaWYgKCF1dWlkKSB7XG4gICAgICAgICAgICBNYXNrTWdyLkluc3RhbmNlLnNob3coTWFza1R5cGUuTmVlZENyZWF0ZU5ld0Fzc2V0KTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFzc2V0VXVpZCA9IHV1aWQ7XG4gICAgICAgIHRoaXMuc2hhZGVyR3JhcGhBc3NldEluZm8gPSBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdhc3NldC1kYicsICdxdWVyeS1hc3NldC1pbmZvJywgdXVpZCk7XG4gICAgICAgIGlmICghdGhpcy5zaGFkZXJHcmFwaEFzc2V0SW5mbyAmJiBHcmFwaERhdGFNZ3IuSW5zdGFuY2UuZ2V0R3JhcGhBc3NldERhdGEoKSkge1xuICAgICAgICAgICAgTWFza01nci5JbnN0YW5jZS5zaG93KE1hc2tUeXBlLkFzc2V0TWlzc2luZyk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5zaGFkZXJHcmFwaEFzc2V0SW5mbykge1xuICAgICAgICAgICAgdGhpcy5hc3NldERhdGEgPSByZWFkRmlsZVN5bmModGhpcy5zaGFkZXJHcmFwaEFzc2V0SW5mby5maWxlLCAndXRmOCcpO1xuICAgICAgICAgICAgR3JhcGhEYXRhTWdyLkluc3RhbmNlLnNldEdyYXBoRGF0YUJ5QXNzZXQodGhpcy5zaGFkZXJHcmFwaEFzc2V0SW5mbywgdGhpcy5hc3NldERhdGEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hc3NldERhdGEgPSAnJztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghdGhpcy5hc3NldERhdGEpIHtcbiAgICAgICAgICAgIE1hc2tNZ3IuSW5zdGFuY2Uuc2hvdyhNYXNrVHlwZS5OZWVkQ3JlYXRlTmV3QXNzZXQpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIE1hc2tNZ3IuSW5zdGFuY2UuaGlkZShNYXNrVHlwZS5Bc3NldE1pc3NpbmcpO1xuICAgICAgICBNYXNrTWdyLkluc3RhbmNlLmhpZGUoTWFza1R5cGUuTmVlZENyZWF0ZU5ld0Fzc2V0KTtcbiAgICAgICAgTWVzc2FnZU1nci5JbnN0YW5jZS5zZW5kKE1lc3NhZ2VUeXBlLkFzc2V0TG9hZGVkKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5omT5byA5oyH5a6aIFNoYWRlciBHcmFwaCDotYTmupBcbiAgICAgKi9cbiAgICBwdWJsaWMgYXN5bmMgb3BlbigpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IEVkaXRvci5EaWFsb2cuc2VsZWN0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnc2hhZGVyLWdyYXBoLm1lc3NhZ2VzLnRpdGxlcy5vcGVuJyksXG4gICAgICAgICAgICAgICAgcGF0aDogUFJPSkVDVF9QQVRILFxuICAgICAgICAgICAgICAgIHR5cGU6ICdmaWxlJyxcbiAgICAgICAgICAgICAgICBtdWx0aTogZmFsc2UsXG4gICAgICAgICAgICAgICAgZmlsdGVyczogW3sgbmFtZTogJ1NoYWRlciBHcmFwaCcsIGV4dGVuc2lvbnM6IFsnc2hhZGVyZ3JhcGgnXSB9XSxcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCB1dWlkID0gYXdhaXQgZ2V0QXNzZXRVdWlkQnlQYXRoKHJlc3VsdC5maWxlUGF0aHNbMF0pO1xuICAgICAgICAgICAgYXdhaXQgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKFBBQ0tBR0VfSlNPTi5uYW1lLCAnYXNzZXQtdXVpZCcsIHV1aWQsICdsb2NhbCcpO1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubG9hZCh1dWlkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDmlrDlu7ogU2hhZGVyIEdyYXBoIOi1hOa6kFxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBjcmVhdGVOZXcodHlwZTogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBFZGl0b3IuRGlhbG9nLnNhdmUoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiBFZGl0b3IuSTE4bi50KCdzaGFkZXItZ3JhcGgubWVzc2FnZXMuc2F2ZS50aXRsZScpLFxuICAgICAgICAgICAgICAgIHBhdGg6IGpvaW4oRWRpdG9yLlByb2plY3QucGF0aCwgJ2Fzc2V0cycsICdOZXcgU2hhZGVyIEdyYXBoJyksXG4gICAgICAgICAgICAgICAgZmlsdGVyczogW3tcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ05ldyBTaGFkZXIgR3JhcGgnLFxuICAgICAgICAgICAgICAgICAgICBleHRlbnNpb25zOiBbJ3NoYWRlcmdyYXBoJ10sXG4gICAgICAgICAgICAgICAgfV0sXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgdXJsID0gY29udmVydFRvUHJvamVjdERiVXJsKHJlc3VsdC5maWxlUGF0aCk7XG4gICAgICAgICAgICBjb25zdCBkZWZhdWx0U2hhZGVyR3JhcGggPSBhd2FpdCBHcmFwaERhdGFNZ3IuY3JlYXRlRGVmYXVsdFNoYWRlckdyYXBoKHR5cGUpO1xuICAgICAgICAgICAgY29uc3QgYXNzZXQgPSBhd2FpdCB0aGlzLmNyZWF0ZUFzc2V0KHVybCwgZGVmYXVsdFNoYWRlckdyYXBoKTtcbiAgICAgICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmxvYWQoYXNzZXQudXVpZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5L+d5a2YXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIHNhdmUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuc2hhZGVyR3JhcGhBc3NldEluZm8pIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIEdyYXBoRGF0YU1nci5JbnN0YW5jZS5zeW5jTGFzdEdyYXBoRGF0YSgpO1xuICAgICAgICAgICAgY29uc29sZS50aW1lKCdzYXZlJyk7XG4gICAgICAgICAgICBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdhc3NldC1kYicsICdzYXZlLWFzc2V0JywgdGhpcy5zaGFkZXJHcmFwaEFzc2V0SW5mby51dWlkLCBHcmFwaERhdGFNZ3IuSW5zdGFuY2UuZ2V0R3JhcGhBc3NldERhdGEoKSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS50aW1lRW5kKCdzYXZlJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIEdyYXBoRGF0YU1nci5JbnN0YW5jZS5zZXREaXJ0eShmYWxzZSk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWPpuWtmOS4ulxuICAgICAqL1xuICAgIHB1YmxpYyBhc3luYyBzYXZlQXMoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBFZGl0b3IuRGlhbG9nLnNhdmUoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiBFZGl0b3IuSTE4bi50KCdzaGFkZXItZ3JhcGgubWVzc2FnZXMuc2F2ZS50aXRsZScpLFxuICAgICAgICAgICAgICAgIHBhdGg6IGpvaW4oRWRpdG9yLlByb2plY3QucGF0aCwgJ2Fzc2V0cycsIHRoaXMuc2hhZGVyR3JhcGhBc3NldEluZm8/Lm5hbWUgfHwgREVGQVVMVF9OQU1FKSxcbiAgICAgICAgICAgICAgICBmaWx0ZXJzOiBbe1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnU2hhZGVyIEdyYXBoJyxcbiAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uczogWydzaGFkZXJncmFwaCddLFxuICAgICAgICAgICAgICAgIH1dLFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnN0IHVybCA9IGNvbnZlcnRUb1Byb2plY3REYlVybChyZXN1bHQuZmlsZVBhdGgpO1xuICAgICAgICAgICAgaWYgKCF1cmwpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCflj6blrZggU2hhZGVyIEdyYXBoIOi1hOa6kOWksei0pSwg5L+d5a2Y55qEIHVybCDkuLogbnVsbCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYXNzZXQgPSBhd2FpdCB0aGlzLmNyZWF0ZUFzc2V0KHVybCwgR3JhcGhEYXRhTWdyLkluc3RhbmNlLmdldEdyYXBoQXNzZXREYXRhKCkpO1xuICAgICAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubG9hZChhc3NldC51dWlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcign5L+d5a2Y5aSx6LSlIScsIGUpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog5qOA5p+l5piv5ZCm6ZyA6KaB5L+d5a2YXG4gICAgICovXG4gICAgcHVibGljIGFzeW5jIGNoZWNrSWZTYXZlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAodGhpcy5zaGFkZXJHcmFwaEFzc2V0SW5mbyAmJiAhZXhpc3RzU3luYyh0aGlzLnNoYWRlckdyYXBoQXNzZXRJbmZvLmZpbGUpKSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBFZGl0b3IuRGlhbG9nLndhcm4oRWRpdG9yLkkxOG4udCgnc2hhZGVyLWdyYXBoLm1lc3NhZ2VzLm1pc3NpbmdfYXNzZXRzLmRldGFpbCcpLCB7XG4gICAgICAgICAgICAgICAgdGl0bGU6IEVkaXRvci5JMThuLnQoJ3NoYWRlci1ncmFwaC5tZXNzYWdlcy50aXRsZXMubm9ybWFsJyksXG4gICAgICAgICAgICAgICAgZGVmYXVsdDogMCxcbiAgICAgICAgICAgICAgICBjYW5jZWw6IDEsXG4gICAgICAgICAgICAgICAgYnV0dG9uczogW1xuICAgICAgICAgICAgICAgICAgICBFZGl0b3IuSTE4bi50KCdzaGFkZXItZ3JhcGguYnV0dG9ucy5zYXZlJyksXG4gICAgICAgICAgICAgICAgICAgIEVkaXRvci5JMThuLnQoJ3NoYWRlci1ncmFwaC5idXR0b25zLnVuc2F2ZWQnKSxcbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoMCA9PT0gcmVzdWx0LnJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgLy8g5Y+m5a2Y5Li6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuc2F2ZUFzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBFZGl0b3IuRGlhbG9nLndhcm4oRWRpdG9yLkkxOG4udCgnc2hhZGVyLWdyYXBoLm1lc3NhZ2VzLnNhdmUuZGV0YWlsJyksIHtcbiAgICAgICAgICAgICAgICB0aXRsZTogRWRpdG9yLkkxOG4udCgnc2hhZGVyLWdyYXBoLm1lc3NhZ2VzLnRpdGxlcy5ub3JtYWwnKSxcbiAgICAgICAgICAgICAgICBkZWZhdWx0OiAwLFxuICAgICAgICAgICAgICAgIGNhbmNlbDogMSxcbiAgICAgICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgICAgICAgIEVkaXRvci5JMThuLnQoJ3NoYWRlci1ncmFwaC5idXR0b25zLnNhdmUnKSxcbiAgICAgICAgICAgICAgICAgICAgRWRpdG9yLkkxOG4udCgnc2hhZGVyLWdyYXBoLmJ1dHRvbnMudW5zYXZlZCcpLFxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICgwID09PSByZXN1bHQucmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAvLyDlj6blrZjkuLpcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5zYXZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYXN5bmMgY3JlYXRlQXNzZXQodXJsOiBzdHJpbmcgfCB1bmRlZmluZWQsIGNvbnRlbnQ6IHN0cmluZyB8IHVuZGVmaW5lZCk6IFByb21pc2U8QXNzZXRJbmZvIHwgdW5kZWZpbmVkPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoIXVybCB8fCAhY29udGVudCkgcmV0dXJuO1xuXG4gICAgICAgICAgICAvLyDlvLrliLbopobnm5ZcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBFZGl0b3IuTWVzc2FnZS5yZXF1ZXN0KCdhc3NldC1kYicsICdjcmVhdGUtYXNzZXQnLCB1cmwsIGNvbnRlbnQsIHsgb3ZlcndyaXRlOiB0cnVlIH0pIGFzIEFzc2V0SW5mbztcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhc3NldEFkZCh1dWlkOiBzdHJpbmcsIGluZm86IEFzc2V0SW5mbykge1xuICAgICAgICBpZiAoaW5mbyAmJiBpbmZvLmltcG9ydGVyKSB7XG4gICAgICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLmNhbGxTY2VuZU1ldGhvZCgncmVnaXN0ZXJFZmZlY3RzJywgW3V1aWRdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBhc3NldERlbGV0ZSh1dWlkOiBzdHJpbmcsIGluZm86IEFzc2V0SW5mbykge1xuICAgICAgICBpZiAoaW5mbyAmJiBpbmZvLmltcG9ydGVyKSB7XG4gICAgICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLmNhbGxTY2VuZU1ldGhvZCgncmVtb3ZlRWZmZWN0cycsIFt1dWlkXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMudXVpZCA9PT0gdXVpZCkge1xuICAgICAgICAgICAgYXdhaXQgR3JhcGhDb25maWdNZ3IuSW5zdGFuY2UuZGVsZXRlKHV1aWQpO1xuICAgICAgICAgICAgTWFza01nci5JbnN0YW5jZS5zaG93KE1hc2tUeXBlLkFzc2V0TWlzc2luZyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXNzZXRDaGFuZ2UodXVpZDogc3RyaW5nLCBpbmZvOiBBc3NldEluZm8pIHtcblxuICAgICAgICBpZiAoaW5mbyAmJiBpbmZvLmltcG9ydGVyKSB7XG4gICAgICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLmNhbGxTY2VuZU1ldGhvZCgndXBkYXRlRWZmZWN0JywgW3V1aWRdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLnV1aWQgPT09IHV1aWQgJiYgR3JhcGhEYXRhTWdyLkluc3RhbmNlLmdyYXBoRm9yZ2UgJiYgR3JhcGhEYXRhTWdyLkluc3RhbmNlLmdyYXBoRGF0YSkge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAvLyDmm7TmlrDlkI3lrZdcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdOYW1lID0gZ2V0TmFtZShpbmZvLm5hbWUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5lZWRUb1JlbmFtZSA9IEdyYXBoRGF0YU1nci5JbnN0YW5jZS5ncmFwaEZvcmdlLmdldEN1cnJlbnRHcmFwaCgpLm5hbWUgIT09IG5ld05hbWU7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBkaXJ0eSA9IEdyYXBoRGF0YU1nci5JbnN0YW5jZS5nZXREaXJ0eSgpO1xuICAgICAgICAgICAgICAgIGlmIChkaXJ0eSAmJiBuZWVkVG9SZW5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgTWFza01nci5JbnN0YW5jZS5zaG93KE1hc2tUeXBlLk5lZWRTYXZlQmVSZWxvYWRCeVJlbmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZGlydHkpIHJldHVybjtcblxuICAgICAgICAgICAgICAgIGlmIChuZWVkVG9SZW5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvLyBjb25zdCBiYXNlRGF0YSA9IHJlYWRGaWxlU3luYyhpbmZvLmZpbGUsICd1dGY4Jyk7XG4gICAgICAgICAgICAgICAgLy8gY29uc3QgY29uZmxpY3RBID0gdGhpcy5ncmFwaEZvcmdlLnNlcmlhbGl6ZSgpICE9PSBiYXNlRGF0YTtcbiAgICAgICAgICAgICAgICAvLyBjb25zdCBjb25mbGljdEIgPSB0aGlzLmdyYXBoRm9yZ2Uuc2VyaWFsaXplKHRoaXMuZ3JhcGhEYXRhKSAhPT0gYmFzZURhdGE7XG4gICAgICAgICAgICAgICAgLy9cbiAgICAgICAgICAgICAgICAvLyBpZiAoY29uZmxpY3RBICYmIGNvbmZsaWN0Qikge1xuICAgICAgICAgICAgICAgIC8vICAgICBNYXNrTWdyLkluc3RhbmNlLnNob3coTWFza1R5cGUuQXNzZXRDaGFuZ2UpO1xuICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19