"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphEditorMgr = void 0;
const declare_1 = require("../declare");
const block_forge_1 = require("../../block-forge");
const utils_1 = require("../utils");
const index_1 = require("./index");
/**
 * shader graph 的基础操作，增、删
 */
class GraphEditorMgr extends index_1.BaseMgr {
    constructor() {
        super(...arguments);
        this.clipboardData = [];
        this.lastMousePoint = { x: 0, y: 0 };
        this.shaderGraphPanel = null;
    }
    static get Instance() {
        if (!this._instance) {
            this._instance = new GraphEditorMgr();
        }
        return this._instance;
    }
    get mousePoint() {
        return this.lastMousePoint;
    }
    get mousePointInPanel() {
        return this.convertsMousePoint(this.lastMousePoint.x, this.lastMousePoint.y);
    }
    convertsMousePoint(x, y) {
        const rect = this.shaderGraphPanel.getBoundingClientRect();
        return {
            x: x - rect.x,
            y: y - rect.y,
        };
    }
    addMousePointerListener(shaderGraphPanel) {
        this.shaderGraphPanel = shaderGraphPanel;
        document.body.addEventListener('mousemove', (event) => {
            this.lastMousePoint = { x: event.clientX, y: event.clientY };
        });
    }
    /**
     * 剪切板是否为空
     */
    get clipboardIsNull() {
        return this.clipboardData.length === 0;
    }
    add(options) {
        options = JSON.parse(JSON.stringify(options));
        const blockTemplate = (0, declare_1.getBlockTemplateByType)(options.type);
        const data = blockTemplate && blockTemplate.data;
        if (!data)
            return;
        if (!options.details.outputPins || options.details.outputPins.length === 0) {
            options.details.outputPins = data.details.outputPins || [];
        }
        if (!options.details.inputPins || options.details.inputPins.length === 0) {
            options.details.inputPins = data.details.inputPins || [];
        }
        let position = { x: options.x || 0, y: options.y || 0 };
        if (options.x === undefined && options.y === undefined) {
            position = this.graphForge.convertCoordinate(this.mousePointInPanel);
        }
        else if (!options.dontConvertPos) {
            position = this.graphForge.convertCoordinate(position);
        }
        this.graphForge.addBlock({
            type: options.type,
            position: position,
            details: options.details,
        }, options.uuid);
        index_1.MessageMgr.Instance.send(index_1.MessageType.Dirty);
    }
    deleteLinesByDuplicateOutput(lines, line) {
        Object.keys(lines).forEach(key => {
            const otherLine = lines[key];
            if (otherLine.output.node === line.output.node &&
                otherLine.output.param === line.output.param) {
                this.graphForge.removeLine(key);
            }
        });
    }
    async delete(options = []) {
        const list = (0, utils_1.mergeGraphEditorOtherOptions)(options, this.getSelectedItems());
        this.graphForge?.startRecording();
        for (const item of list) {
            if (item.blockData) {
                const data = item.blockData;
                if (this.isMaster(data.type))
                    continue;
                await this.graphForge?.removeBlock(item.uuid);
                if (data.details.inputPins) {
                    await this.removeRegisterMenuByInputPins(data.details.inputPins);
                }
            }
        }
        for (const item of list) {
            if (item.lineData) {
                await this.graphForge?.removeLine(item.uuid);
            }
        }
        this.graphForge?.stopRecording();
        index_1.MessageMgr.Instance.send(index_1.MessageType.Dirty);
    }
    cut(options = []) {
        const list = (0, utils_1.mergeGraphEditorOtherOptions)(options, this.getSelectedItems());
        if (list.length > 0) {
            this.clipboardData = [];
            for (const item of list) {
                if (item.lineData)
                    continue;
                const data = item.blockData;
                if (!data)
                    continue;
                if (this.isMaster(data.type))
                    continue;
                this.graphForge.removeBlock(item.uuid);
                if (data.details.inputPins) {
                    this.removeRegisterMenuByInputPins(data.details.inputPins);
                }
                this.clipboardData.push(item);
            }
        }
    }
    copy(options = []) {
        const list = (0, utils_1.mergeGraphEditorOtherOptions)(options, this.getSelectedItems());
        if (list.length > 0) {
            this.clipboardData = [];
            for (const item of list) {
                if (item.lineData)
                    continue;
                const data = item.blockData;
                if (!data)
                    continue;
                if (this.isMaster(data.type))
                    continue;
                this.clipboardData.push(JSON.parse(JSON.stringify(item)));
            }
        }
    }
    paste() {
        const mousePoint = this.graphForge.convertCoordinate({
            x: this.mousePointInPanel.x,
            y: this.mousePointInPanel.y,
        });
        this.usePaste(mousePoint, this.clipboardData);
        index_1.MessageMgr.Instance.send(index_1.MessageType.Dirty);
    }
    undo() {
        this.graphForge?.undo();
    }
    redo() {
        this.graphForge?.redo();
    }
    usePaste(mousePoint, list) {
        const offsetPoint = (0, utils_1.getOffsetPointByMousePoint)(list, mousePoint);
        const blockIDMap = new Map();
        list.forEach((item) => {
            const newBlockID = (0, block_forge_1.generateUUID)();
            const data = JSON.parse(JSON.stringify(item.blockData));
            data.position.x += offsetPoint.x;
            data.position.y += offsetPoint.y;
            this.graphForge.addBlock(data, newBlockID);
            blockIDMap.set(item.uuid, newBlockID);
        });
        const blockMap = index_1.ForgeMgr.Instance.getBlockMap();
        // 为了用于去重
        const noDuplicatesArray = [];
        const newLines = [];
        list.forEach((item) => {
            const block = blockMap[item.uuid];
            block.getOutputPinsList().forEach((pin) => {
                pin.connectPins.forEach((connectPin) => {
                    // 如果拷贝输出的 block 没有包含在选中的 block 中就不需要添加 line
                    const outputNode = blockIDMap.get(connectPin.block.uuid);
                    if (!outputNode)
                        return;
                    const newLineInfo = {
                        type: 'curve',
                        input: {
                            node: blockIDMap.get(pin.block.uuid) || pin.block.uuid,
                            param: pin.desc.tag,
                        },
                        output: {
                            node: blockIDMap.get(connectPin.block.uuid) || connectPin.block.uuid,
                            param: connectPin.desc.tag,
                        },
                        details: {},
                    };
                    const tag = newLineInfo.input.node + newLineInfo.input.param +
                        newLineInfo.output.node + newLineInfo.output.param;
                    if (!noDuplicatesArray.includes(tag)) {
                        noDuplicatesArray.push(tag);
                        newLines.push(newLineInfo);
                    }
                });
            });
            block.getInputPinsList().forEach((pin) => {
                pin.connectPins.forEach((connectPin) => {
                    const newLineInfo = {
                        type: 'curve',
                        input: {
                            node: blockIDMap.get(connectPin.block.uuid) || connectPin.block.uuid,
                            param: connectPin.desc.tag,
                        },
                        output: {
                            node: blockIDMap.get(pin.block.uuid) || pin.block.uuid,
                            param: pin.desc.tag,
                        },
                        details: {},
                    };
                    const tag = newLineInfo.input.node + newLineInfo.input.param +
                        newLineInfo.output.node + newLineInfo.output.param;
                    if (!noDuplicatesArray.includes(tag)) {
                        noDuplicatesArray.push(tag);
                        newLines.push(newLineInfo);
                    }
                });
            });
        });
        // TODO 这里是 hack 如果不加 500 线条会无法添加
        setTimeout(() => {
            newLines.forEach((line) => {
                this.graphForge.addLine(line);
            });
        }, 500);
    }
    duplicate(options = []) {
        const list = (0, utils_1.mergeGraphEditorOtherOptions)(options, this.getSelectedItems()).filter((item) => item.blockData !== null);
        const mousePoint = this.graphForge.convertCoordinate({
            x: this.mousePointInPanel.x,
            y: this.mousePointInPanel.y,
        });
        this.usePaste(mousePoint, list);
        index_1.MessageMgr.Instance.send(index_1.MessageType.Dirty);
    }
    zoomToFit() {
        this.graphForge.zoomToFit();
    }
    /**
     * 重置，回原点
     */
    reset() {
        this.graphForge.setGraphInfo({
            scale: 1,
            offset: { x: 0, y: 0 },
        });
    }
    isMaster(type) {
        return (0, declare_1.getBlockTemplateByType)(type)?.isMaster || false;
    }
    /**
     * 获取当前选择的对象列表
     */
    getSelectedItems() {
        const list = [];
        this.graphForge.getSelectedLineList().forEach((item) => {
            list.push({
                uuid: item.id,
                lineData: item.target,
            });
        });
        this.graphForge.getSelectedBlockList().forEach((item) => {
            list.push({
                uuid: item.id,
                blockData: item.target,
            });
        });
        return list;
    }
    removeRegisterMenuByInputPins(inputPinDataList) {
        inputPinDataList.forEach((pin) => {
            if (pin.details.registerEnumType) {
                (0, block_forge_1.removeDynamicEnumToType)(pin.details.registerEnumType, pin.value);
            }
        });
    }
}
exports.GraphEditorMgr = GraphEditorMgr;
GraphEditorMgr._instance = null;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGgtZWRpdG9yLW1nci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaGFkZXItZ3JhcGgvYmFzZS9ncmFwaC1lZGl0b3ItbWdyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUlBLHdDQUFvRDtBQUNwRCxtREFBK0U7QUFDL0Usb0NBR2tCO0FBRWxCLG1DQUFxRTtBQUdyRTs7R0FFRztBQUNILE1BQWEsY0FBZSxTQUFRLGVBQU87SUFBM0M7O1FBVVksa0JBQWEsR0FBOEIsRUFBRSxDQUFDO1FBRTlDLG1CQUFjLEdBQTZCLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFTbEUscUJBQWdCLEdBQXVCLElBQUksQ0FBQztJQTBSaEQsQ0FBQztJQTVTVSxNQUFNLEtBQUssUUFBUTtRQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNqQixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksY0FBYyxFQUFFLENBQUM7U0FDekM7UUFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7SUFDMUIsQ0FBQztJQUtELElBQVcsVUFBVTtRQUNqQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQVcsaUJBQWlCO1FBQ3hCLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakYsQ0FBQztJQUdELGtCQUFrQixDQUFDLENBQVMsRUFBRSxDQUFTO1FBQ25DLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxnQkFBaUIsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzVELE9BQU87WUFDSCxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQ2IsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztTQUNo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SUFBSSxDQUFDLE1BQWtCO2FBQ3BDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQW9CLEVBQUUsRUFBRTtZQUNwRSxJQUFJLENBQUMsSUFBSSxDQUFDO2dCQUNOLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDYixTQUFTLEVBQUUsSUFBSSxDQUFDLE1BQW1CO2FBQ3RDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVPLDZCQUE2QixDQUFDLGdCQUEyQjtRQUM3RCxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFZLEVBQUUsRUFBRTtZQUN0QyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQzlCLElBQUEscUNBQXVCLEVBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDcEU7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7O0FBOVNMLHdDQStTQztBQTdTVSx3QkFBUyxHQUEwQixJQUFJLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEJsb2NrRGF0YSwgSVBpbkRlc2NyaXB0aW9uLCBMaW5lRGF0YSwgUGluRGF0YSB9IGZyb20gJy4uLy4uL2Jsb2NrLWZvcmdlL2ludGVyZmFjZSc7XG5pbXBvcnQgdHlwZSB7IFNlbGVjdExpbmVJbmZvLCBTZWxlY3ROb2RlSW5mbyB9IGZyb20gJ0BpdGhhcmJvcnMvdWktZ3JhcGgvZGlzdC9pbnRlcmZhY2UnO1xuaW1wb3J0IHR5cGUgeyBJTm9kZURldGFpbHMsIFByb3BlcnR5RGF0YSB9IGZyb20gJy4uL2ludGVyZmFjZSc7XG5cbmltcG9ydCB7IGdldEJsb2NrVGVtcGxhdGVCeVR5cGUgfSBmcm9tICcuLi9kZWNsYXJlJztcbmltcG9ydCB7IGdlbmVyYXRlVVVJRCwgUGluLCByZW1vdmVEeW5hbWljRW51bVRvVHlwZSB9IGZyb20gJy4uLy4uL2Jsb2NrLWZvcmdlJztcbmltcG9ydCB7XG4gICAgZ2V0T2Zmc2V0UG9pbnRCeU1vdXNlUG9pbnQsXG4gICAgbWVyZ2VHcmFwaEVkaXRvck90aGVyT3B0aW9ucyxcbn0gZnJvbSAnLi4vdXRpbHMnO1xuXG5pbXBvcnQgeyBCYXNlTWdyLCBGb3JnZU1nciwgTWVzc2FnZU1nciwgTWVzc2FnZVR5cGUgfSBmcm9tICcuL2luZGV4JztcbmltcG9ydCB7IEdyYXBoRWRpdG9yQWRkT3B0aW9ucywgR3JhcGhFZGl0b3JPdGhlck9wdGlvbnMgfSBmcm9tICcuL2ludGVybmFsJztcblxuLyoqXG4gKiBzaGFkZXIgZ3JhcGgg55qE5Z+656GA5pON5L2c77yM5aKe44CB5YigXG4gKi9cbmV4cG9ydCBjbGFzcyBHcmFwaEVkaXRvck1nciBleHRlbmRzIEJhc2VNZ3Ige1xuXG4gICAgc3RhdGljIF9pbnN0YW5jZTogR3JhcGhFZGl0b3JNZ3IgfCBudWxsID0gbnVsbDtcbiAgICBwdWJsaWMgc3RhdGljIGdldCBJbnN0YW5jZSgpOiBHcmFwaEVkaXRvck1nciB7XG4gICAgICAgIGlmICghdGhpcy5faW5zdGFuY2UpIHtcbiAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlID0gbmV3IEdyYXBoRWRpdG9yTWdyKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2luc3RhbmNlO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xpcGJvYXJkRGF0YTogR3JhcGhFZGl0b3JPdGhlck9wdGlvbnNbXSA9IFtdO1xuXG4gICAgcHJpdmF0ZSBsYXN0TW91c2VQb2ludDogeyB4OiBudW1iZXI7IHk6IG51bWJlciB9ID0geyB4OiAwLCB5OiAwIH07XG4gICAgcHVibGljIGdldCBtb3VzZVBvaW50KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5sYXN0TW91c2VQb2ludDtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IG1vdXNlUG9pbnRJblBhbmVsKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb252ZXJ0c01vdXNlUG9pbnQodGhpcy5sYXN0TW91c2VQb2ludC54LCB0aGlzLmxhc3RNb3VzZVBvaW50LnkpO1xuICAgIH1cblxuICAgIHNoYWRlckdyYXBoUGFuZWw6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG4gICAgY29udmVydHNNb3VzZVBvaW50KHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gICAgICAgIGNvbnN0IHJlY3QgPSB0aGlzLnNoYWRlckdyYXBoUGFuZWwhLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgeDogeCAtIHJlY3QueCxcbiAgICAgICAgICAgIHk6IHkgLSByZWN0LnksXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIGFkZE1vdXNlUG9pbnRlckxpc3RlbmVyKHNoYWRlckdyYXBoUGFuZWw6IEhUTUxFbGVtZW50KSB7XG4gICAgICAgIHRoaXMuc2hhZGVyR3JhcGhQYW5lbCA9IHNoYWRlckdyYXBoUGFuZWw7XG4gICAgICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxhc3RNb3VzZVBvaW50ID0geyB4OiBldmVudC5jbGllbnRYLCB5OiBldmVudC5jbGllbnRZIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOWJquWIh+adv+aYr+WQpuS4uuepulxuICAgICAqL1xuICAgIHB1YmxpYyBnZXQgY2xpcGJvYXJkSXNOdWxsKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jbGlwYm9hcmREYXRhLmxlbmd0aCA9PT0gMDtcbiAgICB9XG4gICAgcHVibGljIGFkZChvcHRpb25zOiBHcmFwaEVkaXRvckFkZE9wdGlvbnMpIHtcbiAgICAgICAgb3B0aW9ucyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob3B0aW9ucykpO1xuXG4gICAgICAgIGNvbnN0IGJsb2NrVGVtcGxhdGUgPSBnZXRCbG9ja1RlbXBsYXRlQnlUeXBlKG9wdGlvbnMudHlwZSk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBibG9ja1RlbXBsYXRlICYmIGJsb2NrVGVtcGxhdGUuZGF0YTtcblxuICAgICAgICBpZiAoIWRhdGEpIHJldHVybjtcblxuICAgICAgICBpZiAoIW9wdGlvbnMuZGV0YWlscy5vdXRwdXRQaW5zIHx8IG9wdGlvbnMuZGV0YWlscy5vdXRwdXRQaW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgb3B0aW9ucy5kZXRhaWxzLm91dHB1dFBpbnMgPSBkYXRhLmRldGFpbHMub3V0cHV0UGlucyB8fCBbXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIW9wdGlvbnMuZGV0YWlscy5pbnB1dFBpbnMgfHwgb3B0aW9ucy5kZXRhaWxzLmlucHV0UGlucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIG9wdGlvbnMuZGV0YWlscy5pbnB1dFBpbnMgPSBkYXRhLmRldGFpbHMuaW5wdXRQaW5zIHx8IFtdO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IHBvc2l0aW9uID0geyB4OiBvcHRpb25zLnggfHwgMCwgeTogb3B0aW9ucy55IHx8IDAgfTtcbiAgICAgICAgaWYgKG9wdGlvbnMueCA9PT0gdW5kZWZpbmVkICYmIG9wdGlvbnMueSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBwb3NpdGlvbiA9IHRoaXMuZ3JhcGhGb3JnZS5jb252ZXJ0Q29vcmRpbmF0ZSh0aGlzLm1vdXNlUG9pbnRJblBhbmVsKTtcbiAgICAgICAgfSBlbHNlIGlmICghb3B0aW9ucy5kb250Q29udmVydFBvcykge1xuICAgICAgICAgICAgcG9zaXRpb24gPSB0aGlzLmdyYXBoRm9yZ2UuY29udmVydENvb3JkaW5hdGUocG9zaXRpb24pO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5ncmFwaEZvcmdlLmFkZEJsb2NrKHtcbiAgICAgICAgICAgIHR5cGU6IG9wdGlvbnMudHlwZSxcbiAgICAgICAgICAgIHBvc2l0aW9uOiBwb3NpdGlvbixcbiAgICAgICAgICAgIGRldGFpbHM6IG9wdGlvbnMuZGV0YWlscyxcbiAgICAgICAgfSwgb3B0aW9ucy51dWlkKTtcblxuICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLnNlbmQoTWVzc2FnZVR5cGUuRGlydHkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBkZWxldGVMaW5lc0J5RHVwbGljYXRlT3V0cHV0KGxpbmVzOiB7IFtrZXk6IHN0cmluZ106IExpbmVEYXRhIH0sIGxpbmU6IExpbmVEYXRhKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKGxpbmVzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvdGhlckxpbmUgPSBsaW5lc1trZXldO1xuICAgICAgICAgICAgaWYgKG90aGVyTGluZS5vdXRwdXQubm9kZSA9PT0gbGluZS5vdXRwdXQubm9kZSAmJlxuICAgICAgICAgICAgICAgIG90aGVyTGluZS5vdXRwdXQucGFyYW0gPT09IGxpbmUub3V0cHV0LnBhcmFtKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5ncmFwaEZvcmdlLnJlbW92ZUxpbmUoa2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIGRlbGV0ZShvcHRpb25zOiBHcmFwaEVkaXRvck90aGVyT3B0aW9uc1tdID0gW10pIHtcbiAgICAgICAgY29uc3QgbGlzdCA9IG1lcmdlR3JhcGhFZGl0b3JPdGhlck9wdGlvbnMob3B0aW9ucywgdGhpcy5nZXRTZWxlY3RlZEl0ZW1zKCkpO1xuXG4gICAgICAgIHRoaXMuZ3JhcGhGb3JnZT8uc3RhcnRSZWNvcmRpbmcoKTtcblxuICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgbGlzdCkge1xuICAgICAgICAgICAgaWYgKGl0ZW0uYmxvY2tEYXRhKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGl0ZW0uYmxvY2tEYXRhITtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc01hc3RlcihkYXRhLnR5cGUpKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZ3JhcGhGb3JnZT8ucmVtb3ZlQmxvY2soaXRlbS51dWlkKTtcblxuICAgICAgICAgICAgICAgIGlmIChkYXRhLmRldGFpbHMuaW5wdXRQaW5zKSB7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVtb3ZlUmVnaXN0ZXJNZW51QnlJbnB1dFBpbnMoZGF0YS5kZXRhaWxzLmlucHV0UGlucyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBsaXN0KSB7XG4gICAgICAgICAgICBpZiAoaXRlbS5saW5lRGF0YSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuZ3JhcGhGb3JnZT8ucmVtb3ZlTGluZShpdGVtLnV1aWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZ3JhcGhGb3JnZT8uc3RvcFJlY29yZGluZygpO1xuICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLnNlbmQoTWVzc2FnZVR5cGUuRGlydHkpO1xuICAgIH1cblxuICAgIHB1YmxpYyBjdXQob3B0aW9uczogR3JhcGhFZGl0b3JPdGhlck9wdGlvbnNbXSA9IFtdKSB7XG4gICAgICAgIGNvbnN0IGxpc3QgPSBtZXJnZUdyYXBoRWRpdG9yT3RoZXJPcHRpb25zKG9wdGlvbnMsIHRoaXMuZ2V0U2VsZWN0ZWRJdGVtcygpKTtcblxuICAgICAgICBpZiAobGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmNsaXBib2FyZERhdGEgPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBsaXN0KSB7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0ubGluZURhdGEpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGl0ZW0uYmxvY2tEYXRhO1xuICAgICAgICAgICAgICAgIGlmICghZGF0YSkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc01hc3RlcihkYXRhLnR5cGUpKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZ3JhcGhGb3JnZS5yZW1vdmVCbG9jayhpdGVtLnV1aWQpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuZGV0YWlscy5pbnB1dFBpbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVSZWdpc3Rlck1lbnVCeUlucHV0UGlucyhkYXRhLmRldGFpbHMuaW5wdXRQaW5zKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5jbGlwYm9hcmREYXRhLnB1c2goaXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcHVibGljIGNvcHkob3B0aW9uczogR3JhcGhFZGl0b3JPdGhlck9wdGlvbnNbXSA9IFtdKSB7XG4gICAgICAgIGNvbnN0IGxpc3QgPSBtZXJnZUdyYXBoRWRpdG9yT3RoZXJPcHRpb25zKG9wdGlvbnMsIHRoaXMuZ2V0U2VsZWN0ZWRJdGVtcygpKTtcblxuICAgICAgICBpZiAobGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmNsaXBib2FyZERhdGEgPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBsaXN0KSB7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0ubGluZURhdGEpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IGl0ZW0uYmxvY2tEYXRhO1xuICAgICAgICAgICAgICAgIGlmICghZGF0YSkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc01hc3RlcihkYXRhLnR5cGUpKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgIHRoaXMuY2xpcGJvYXJkRGF0YS5wdXNoKEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoaXRlbSkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBwdWJsaWMgcGFzdGUoKSB7XG4gICAgICAgIGNvbnN0IG1vdXNlUG9pbnQgPSB0aGlzLmdyYXBoRm9yZ2UuY29udmVydENvb3JkaW5hdGUoe1xuICAgICAgICAgICAgeDogdGhpcy5tb3VzZVBvaW50SW5QYW5lbC54LFxuICAgICAgICAgICAgeTogdGhpcy5tb3VzZVBvaW50SW5QYW5lbC55LFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy51c2VQYXN0ZShtb3VzZVBvaW50LCB0aGlzLmNsaXBib2FyZERhdGEpO1xuXG4gICAgICAgIE1lc3NhZ2VNZ3IuSW5zdGFuY2Uuc2VuZChNZXNzYWdlVHlwZS5EaXJ0eSk7XG4gICAgfVxuXG4gICAgcHVibGljIHVuZG8oKSB7XG4gICAgICAgIHRoaXMuZ3JhcGhGb3JnZT8udW5kbygpO1xuICAgIH1cblxuICAgIHB1YmxpYyByZWRvKCkge1xuICAgICAgICB0aGlzLmdyYXBoRm9yZ2U/LnJlZG8oKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHVzZVBhc3RlKG1vdXNlUG9pbnQ6IHsgeDogbnVtYmVyOyB5OiBudW1iZXIgfSwgbGlzdDogR3JhcGhFZGl0b3JPdGhlck9wdGlvbnNbXSkge1xuICAgICAgICBjb25zdCBvZmZzZXRQb2ludCA9IGdldE9mZnNldFBvaW50QnlNb3VzZVBvaW50KGxpc3QsIG1vdXNlUG9pbnQpO1xuXG4gICAgICAgIGNvbnN0IGJsb2NrSURNYXA6IE1hcDxzdHJpbmcsIHN0cmluZz4gPSBuZXcgTWFwKCk7XG4gICAgICAgIGxpc3QuZm9yRWFjaCgoaXRlbTogR3JhcGhFZGl0b3JPdGhlck9wdGlvbnMpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5ld0Jsb2NrSUQgPSBnZW5lcmF0ZVVVSUQoKTtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGl0ZW0uYmxvY2tEYXRhKSk7XG4gICAgICAgICAgICBkYXRhLnBvc2l0aW9uLnggKz0gb2Zmc2V0UG9pbnQueDtcbiAgICAgICAgICAgIGRhdGEucG9zaXRpb24ueSArPSBvZmZzZXRQb2ludC55O1xuICAgICAgICAgICAgdGhpcy5ncmFwaEZvcmdlLmFkZEJsb2NrKGRhdGEsIG5ld0Jsb2NrSUQpO1xuICAgICAgICAgICAgYmxvY2tJRE1hcC5zZXQoaXRlbS51dWlkLCBuZXdCbG9ja0lEKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgYmxvY2tNYXAgPSBGb3JnZU1nci5JbnN0YW5jZS5nZXRCbG9ja01hcCgpO1xuXG4gICAgICAgIC8vIOS4uuS6hueUqOS6juWOu+mHjVxuICAgICAgICBjb25zdCBub0R1cGxpY2F0ZXNBcnJheTogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3QgbmV3TGluZXM6IExpbmVEYXRhW10gPSBbXTtcbiAgICAgICAgbGlzdC5mb3JFYWNoKChpdGVtOiBHcmFwaEVkaXRvck90aGVyT3B0aW9ucykgPT4ge1xuICAgICAgICAgICAgY29uc3QgYmxvY2sgPSBibG9ja01hcFtpdGVtLnV1aWRdO1xuICAgICAgICAgICAgYmxvY2suZ2V0T3V0cHV0UGluc0xpc3QoKS5mb3JFYWNoKChwaW46IFBpbikgPT4ge1xuICAgICAgICAgICAgICAgIHBpbi5jb25uZWN0UGlucy5mb3JFYWNoKChjb25uZWN0UGluOiBQaW4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8g5aaC5p6c5ou36LSd6L6T5Ye655qEIGJsb2NrIOayoeacieWMheWQq+WcqOmAieS4reeahCBibG9jayDkuK3lsLHkuI3pnIDopoHmt7vliqAgbGluZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXROb2RlID0gYmxvY2tJRE1hcC5nZXQoY29ubmVjdFBpbi5ibG9jay51dWlkKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFvdXRwdXROb2RlKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3TGluZUluZm86IExpbmVEYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2N1cnZlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogYmxvY2tJRE1hcC5nZXQocGluLmJsb2NrLnV1aWQpIHx8IHBpbi5ibG9jay51dWlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtOiBwaW4uZGVzYy50YWcsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogYmxvY2tJRE1hcC5nZXQoY29ubmVjdFBpbi5ibG9jay51dWlkKSB8fCBjb25uZWN0UGluLmJsb2NrLnV1aWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW06IGNvbm5lY3RQaW4uZGVzYy50YWcsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsczoge30sXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhZyA9IG5ld0xpbmVJbmZvLmlucHV0Lm5vZGUgKyBuZXdMaW5lSW5mby5pbnB1dC5wYXJhbSArXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdMaW5lSW5mby5vdXRwdXQubm9kZSArIG5ld0xpbmVJbmZvLm91dHB1dC5wYXJhbTtcblxuICAgICAgICAgICAgICAgICAgICBpZiAoIW5vRHVwbGljYXRlc0FycmF5LmluY2x1ZGVzKHRhZykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vRHVwbGljYXRlc0FycmF5LnB1c2godGFnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0xpbmVzLnB1c2gobmV3TGluZUluZm8pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJsb2NrLmdldElucHV0UGluc0xpc3QoKS5mb3JFYWNoKChwaW46IFBpbikgPT4ge1xuICAgICAgICAgICAgICAgIHBpbi5jb25uZWN0UGlucy5mb3JFYWNoKChjb25uZWN0UGluOiBQaW4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3TGluZUluZm86IExpbmVEYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2N1cnZlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogYmxvY2tJRE1hcC5nZXQoY29ubmVjdFBpbi5ibG9jay51dWlkKSB8fCBjb25uZWN0UGluLmJsb2NrLnV1aWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW06IGNvbm5lY3RQaW4uZGVzYy50YWcsXG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogYmxvY2tJRE1hcC5nZXQocGluLmJsb2NrLnV1aWQpIHx8IHBpbi5ibG9jay51dWlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtOiBwaW4uZGVzYy50YWcsXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxzOiB7fSxcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFnID0gbmV3TGluZUluZm8uaW5wdXQubm9kZSArIG5ld0xpbmVJbmZvLmlucHV0LnBhcmFtICtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0xpbmVJbmZvLm91dHB1dC5ub2RlICsgbmV3TGluZUluZm8ub3V0cHV0LnBhcmFtO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmICghbm9EdXBsaWNhdGVzQXJyYXkuaW5jbHVkZXModGFnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbm9EdXBsaWNhdGVzQXJyYXkucHVzaCh0YWcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3TGluZXMucHVzaChuZXdMaW5lSW5mbyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBUT0RPIOi/memHjOaYryBoYWNrIOWmguaenOS4jeWKoCA1MDAg57q/5p2h5Lya5peg5rOV5re75YqgXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgbmV3TGluZXMuZm9yRWFjaCgobGluZTogTGluZURhdGEpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmdyYXBoRm9yZ2UuYWRkTGluZShsaW5lKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCA1MDApO1xuICAgIH1cblxuICAgIHB1YmxpYyBkdXBsaWNhdGUob3B0aW9uczogR3JhcGhFZGl0b3JPdGhlck9wdGlvbnNbXSA9IFtdKSB7XG4gICAgICAgIGNvbnN0IGxpc3QgPSBtZXJnZUdyYXBoRWRpdG9yT3RoZXJPcHRpb25zKG9wdGlvbnMsIHRoaXMuZ2V0U2VsZWN0ZWRJdGVtcygpKS5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0uYmxvY2tEYXRhICE9PSBudWxsKTtcbiAgICAgICAgY29uc3QgbW91c2VQb2ludCA9IHRoaXMuZ3JhcGhGb3JnZS5jb252ZXJ0Q29vcmRpbmF0ZSh7XG4gICAgICAgICAgICB4OiB0aGlzLm1vdXNlUG9pbnRJblBhbmVsLngsXG4gICAgICAgICAgICB5OiB0aGlzLm1vdXNlUG9pbnRJblBhbmVsLnksXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnVzZVBhc3RlKG1vdXNlUG9pbnQsIGxpc3QpO1xuICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLnNlbmQoTWVzc2FnZVR5cGUuRGlydHkpO1xuICAgIH1cblxuICAgIHB1YmxpYyB6b29tVG9GaXQoKSB7XG4gICAgICAgIHRoaXMuZ3JhcGhGb3JnZS56b29tVG9GaXQoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDph43nva7vvIzlm57ljp/ngrlcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVzZXQoKSB7XG4gICAgICAgIHRoaXMuZ3JhcGhGb3JnZS5zZXRHcmFwaEluZm8oe1xuICAgICAgICAgICAgc2NhbGU6IDEsXG4gICAgICAgICAgICBvZmZzZXQ6IHsgeDogMCwgeTogMH0sXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgaXNNYXN0ZXIodHlwZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBnZXRCbG9ja1RlbXBsYXRlQnlUeXBlKHR5cGUpPy5pc01hc3RlciB8fCBmYWxzZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDojrflj5blvZPliY3pgInmi6nnmoTlr7nosaHliJfooahcbiAgICAgKi9cbiAgICBwcml2YXRlIGdldFNlbGVjdGVkSXRlbXMoKSB7XG4gICAgICAgIGNvbnN0IGxpc3Q6IEdyYXBoRWRpdG9yT3RoZXJPcHRpb25zW10gPSBbXTtcbiAgICAgICAgdGhpcy5ncmFwaEZvcmdlLmdldFNlbGVjdGVkTGluZUxpc3QoKS5mb3JFYWNoKChpdGVtOiBTZWxlY3RMaW5lSW5mbykgPT4ge1xuICAgICAgICAgICAgbGlzdC5wdXNoKHtcbiAgICAgICAgICAgICAgICB1dWlkOiBpdGVtLmlkLFxuICAgICAgICAgICAgICAgIGxpbmVEYXRhOiBpdGVtLnRhcmdldCBhcyBMaW5lRGF0YSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5ncmFwaEZvcmdlLmdldFNlbGVjdGVkQmxvY2tMaXN0KCkuZm9yRWFjaCgoaXRlbTogU2VsZWN0Tm9kZUluZm8pID0+IHtcbiAgICAgICAgICAgIGxpc3QucHVzaCh7XG4gICAgICAgICAgICAgICAgdXVpZDogaXRlbS5pZCxcbiAgICAgICAgICAgICAgICBibG9ja0RhdGE6IGl0ZW0udGFyZ2V0IGFzIEJsb2NrRGF0YSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGxpc3Q7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW1vdmVSZWdpc3Rlck1lbnVCeUlucHV0UGlucyhpbnB1dFBpbkRhdGFMaXN0OiBQaW5EYXRhW10pIHtcbiAgICAgICAgaW5wdXRQaW5EYXRhTGlzdC5mb3JFYWNoKChwaW46IFBpbkRhdGEpID0+IHtcbiAgICAgICAgICAgIGlmIChwaW4uZGV0YWlscy5yZWdpc3RlckVudW1UeXBlKSB7XG4gICAgICAgICAgICAgICAgcmVtb3ZlRHluYW1pY0VudW1Ub1R5cGUocGluLmRldGFpbHMucmVnaXN0ZXJFbnVtVHlwZSwgcGluLnZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19