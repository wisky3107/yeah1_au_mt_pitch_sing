"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphDataMgr = void 0;
const tslib_1 = require("tslib");
const js_yaml_1 = tslib_1.__importDefault(require("js-yaml"));
const lodash_1 = require("lodash");
const declare_1 = require("../declare");
const block_forge_1 = require("../../block-forge");
const index_1 = require("./index");
const utils_1 = require("../utils");
/**
 * 用于处理 shader-graph 数据
 */
class GraphDataMgr extends index_1.BaseMgr {
    constructor() {
        super(...arguments);
        /**
         * 表示是否设置 Graph
         * @private
         */
        this._dirty = false;
        this.graphData = null;
        /**
         * 存储面板一些主要配置
         * 例如缩放，偏移
         * @private
         */
        this.graphConfig = undefined;
    }
    static get Instance() {
        if (!this._instance) {
            this._instance = new GraphDataMgr();
        }
        return this._instance;
    }
    static async createDefaultShaderGraph(type = 'SurfaceMasterNode', graphType = 'Graph', graphName = 'New Shader Graph') {
        switch (type) {
            case 'Surface':
                type = 'SurfaceMasterNode';
                break;
            case 'Unlit':
                type = 'UnlitMasterNode';
                break;
        }
        const graphGraphData = {
            type: graphType,
            name: graphName,
            nodes: {},
            graphs: {},
            lines: {},
            details: {
                properties: [],
            },
        };
        const blockData = await (0, declare_1.getBlockDataByType)(type);
        if (!blockData) {
            console.log(`create default shader graph failed, MasterNode: ${type}`);
        }
        else {
            blockData.position = { x: 347, y: -280 };
            graphGraphData.nodes[(0, block_forge_1.generateUUID)()] = blockData;
        }
        return js_yaml_1.default.dump(graphGraphData);
    }
    setDirty(val, type) {
        this._dirty = val;
        index_1.MessageMgr.Instance.send(index_1.MessageType.DirtyChanged, val, type);
    }
    getDirty() {
        return this._dirty;
    }
    release() {
        if (this.onDirtyDebounce) {
            this.graphForge.removeEventListener('dirty', this.onDirtyDebounce);
            this.graphForge.removeEventListener('undo', this.onDirtyDebounce);
            this.graphForge.removeEventListener('redo', this.onDirtyDebounce);
            index_1.MessageMgr.Instance.register(index_1.MessageType.Dirty, this.onDirtyDebounce);
        }
        this.onEnterGraphBind && this.graphForge.removeEventListener('enter-graph', this.onEnterGraphBind);
        this.onAssetLoadedBind && index_1.MessageMgr.Instance.unregister(index_1.MessageType.AssetLoaded, this.onAssetLoadedBind);
    }
    setGraphForge(forge) {
        super.setGraphForge(forge);
        this.onDirtyDebounce = (0, lodash_1.debounce)(this.onDirty.bind(this), 100);
        forge.addEventListener('dirty', this.onDirtyDebounce);
        forge.addEventListener('undo', this.onDirtyDebounce);
        forge.addEventListener('redo', this.onDirtyDebounce);
        this.onEnterGraphBind = this.onEnterGraph.bind(this);
        forge.addEventListener('enter-graph', this.onEnterGraphBind);
        this.onAssetLoadedBind = this.onAssetLoaded.bind(this);
        index_1.MessageMgr.Instance.register(index_1.MessageType.AssetLoaded, this.onAssetLoadedBind);
        index_1.MessageMgr.Instance.register(index_1.MessageType.Dirty, this.onDirtyDebounce);
    }
    reset() {
        this.setDirty(false);
    }
    onAssetLoaded() {
        this.reset();
        this.reload();
    }
    onDirty(event) {
        if (!this.graphForge)
            return;
        index_1.GraphConfigMgr.Instance.autoSave().then(() => { });
        const customEvent = event;
        this.setDirty(true, customEvent && customEvent.detail?.dirtyType);
    }
    onEnterGraph() {
        if (!this.graphForge)
            return;
        this.graphData = this.graphForge.getCurrentGraph();
        index_1.MessageMgr.Instance.send(index_1.MessageType.EnterGraph);
    }
    async restore() {
        if (this.lastGraphData) {
            this.setGraphDataToForge(this.lastGraphData);
        }
        this.graphData = this.graphForge.getCurrentGraph();
        this.lastGraphData = JSON.parse(JSON.stringify(this.graphData));
        this.setDirty(false);
        index_1.MessageMgr.Instance.send(index_1.MessageType.Restore);
    }
    setGraphDataByAsset(assetInfo, asset) {
        if (!this.graphForge)
            return;
        if (asset) {
            this.graphData = this.validateGraphData(assetInfo, this.graphForge.deserialize(asset));
        }
        else {
            console.warn('reload failed, graph data asset is null.');
            return;
        }
    }
    async reload() {
        if (!this.graphForge || !this.graphData)
            return;
        this.lastGraphData = JSON.parse(JSON.stringify(this.graphData));
        this.setGraphDataToForge(this.graphData);
        await index_1.GraphConfigMgr.Instance.sync();
        index_1.MaskMgr.Instance.hideAll();
        index_1.MessageMgr.Instance.send(index_1.MessageType.SetGraphDataToForge);
    }
    syncLastGraphData() {
        this.lastGraphData = JSON.parse(JSON.stringify(this.graphData));
    }
    /**
     * 存储到 Asset 的字符串数据
     */
    getGraphAssetData() {
        if (!this.graphForge)
            return '';
        return this.graphForge.serialize();
    }
    /**
     * 还原成原始节点
     * @private
     */
    reduceToBaseNode(property) {
        const graphData = this.getCurrentGraphData();
        for (const nodeID in graphData.nodes) {
            const node = graphData.nodes[nodeID];
            const details = node && node.details;
            if (!details)
                continue;
            if (details && details.propertyID === property.id) {
                details.title = property.name;
                details.outputPins = property.outputPins;
                // 重置
                const block = (0, declare_1.getBlockTemplateByType)(details.baseType);
                node.type = details.baseType;
                const inputPins = [];
                block?.data.details.inputPins?.forEach((pin, index) => {
                    const rawPinData = details.inputPins?.[index];
                    if (rawPinData) {
                        pin.value = rawPinData.value;
                    }
                    inputPins.push(pin);
                });
                node.details.inputPins = inputPins;
                const outputPins = [];
                block?.data.details.outputPins?.forEach((pin, index) => {
                    const rawPinData = details.outputPins?.[index];
                    if (rawPinData) {
                        pin.value = rawPinData.value;
                    }
                    outputPins.push(pin);
                });
                node.details.outputPins = outputPins;
            }
        }
        this.setGraphDataToForge(graphData);
    }
    /**
     * 验证数据
     * @private
     */
    validateGraphData(assetInfo, graphData) {
        let dirty = false;
        const newName = (0, utils_1.getName)(assetInfo.path);
        if (graphData.name !== newName) {
            graphData.name = newName;
            dirty = true;
        }
        for (const uuid in graphData.nodes) {
            const block = graphData.nodes[uuid];
            const blockTemplate = (0, declare_1.getBlockTemplateByType)(block.type);
            if (blockTemplate) {
                // 1.新增 slot 需要补全数据
                const inputPins = block.details.inputPins;
                if (inputPins && blockTemplate.data.details.inputPins) {
                    blockTemplate.data.details.inputPins.forEach((pin, index) => {
                        const inputPinData = inputPins[index];
                        if (!inputPinData) {
                            inputPins[index] = pin;
                            dirty = true;
                        }
                    });
                }
            }
        }
        // 初始化
        if (!graphData.details.properties) {
            graphData.details.properties = [];
        }
        if (dirty && this.graphForge) {
            Editor.Message.request('asset-db', 'save-asset', assetInfo.uuid, this.graphForge.serialize(graphData));
        }
        return graphData;
    }
}
exports.GraphDataMgr = GraphDataMgr;
GraphDataMgr._instance = null;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGgtZGF0YS1tZ3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2hhZGVyLWdyYXBoL2Jhc2UvZ3JhcGgtZGF0YS1tZ3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLDhEQUEyQjtBQUMzQixtQ0FBa0M7QUFNbEMsd0NBQXdFO0FBQ3hFLG1EQUF3RTtBQUV4RSxtQ0FBa0c7QUFFbEcsb0NBQW1DO0FBRW5DOztHQUVHO0FBQ0gsTUFBYSxZQUFhLFNBQVEsZUFBTztJQUF6Qzs7UUF5Q0k7OztXQUdHO1FBQ08sV0FBTSxHQUFHLEtBQUssQ0FBQztRQUlsQixjQUFTLEdBQXFCLElBQUksQ0FBQztRQUUxQzs7OztXQUlHO1FBQ0ssZ0JBQVcsR0FBNkIsU0FBUyxDQUFDO0lBZ005RCxDQUFDO0lBcFBVLE1BQU0sS0FBSyxRQUFRO1FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztTQUN2QztRQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBRU0sTUFBTSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLEdBQUcsbUJBQW1CLEVBQUUsU0FBUyxHQUFHLE9BQU8sRUFBRSxTQUFTLEdBQUcsa0JBQWtCO1FBQ3hILFFBQVEsSUFBSSxFQUFFO1lBQ1YsS0FBSyxTQUFTO2dCQUNWLElBQUksR0FBRyxtQkFBbUIsQ0FBQztnQkFDM0IsTUFBTTtZQUNWLEtBQUssT0FBTztnQkFDUixJQUFJLEdBQUcsaUJBQWlCLENBQUM7Z0JBQ3pCLE1BQU07U0FDYjtRQUVELE1BQU0sY0FBYyxHQUFjO1lBQzlCLElBQUksRUFBRSxTQUFTO1lBQ2YsSUFBSSxFQUFFLFNBQVM7WUFDZixLQUFLLEVBQUUsRUFBRTtZQUNULE1BQU0sRUFBRSxFQUFFO1lBQ1YsS0FBSyxFQUFFLEVBQUU7WUFDVCxPQUFPLEVB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UEwsb0NBd1BDO0FBdFBVLHNCQUFTLEdBQXdCLElBQUksQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB5YW1sIGZyb20gJ2pzLXlhbWwnO1xuaW1wb3J0IHsgZGVib3VuY2UgfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgdHlwZSB7IEdyYXBoRGF0YSwgUGluRGF0YSwgQmxvY2tEYXRhIH0gZnJvbSAnLi4vLi4vYmxvY2stZm9yZ2UvaW50ZXJmYWNlJztcbmltcG9ydCB0eXBlIHsgUHJvcGVydHlEYXRhIH0gZnJvbSAnLi4vaW50ZXJmYWNlJztcbmltcG9ydCB0eXBlIHsgQmxvY2tUZW1wbGF0ZURhdGEgfSBmcm9tICcuLi9pbnRlcm5hbCc7XG5cbmltcG9ydCB7IGdldEJsb2NrRGF0YUJ5VHlwZSwgZ2V0QmxvY2tUZW1wbGF0ZUJ5VHlwZSB9IGZyb20gJy4uL2RlY2xhcmUnO1xuaW1wb3J0IHsgZ2VuZXJhdGVVVUlELCBIVE1MR3JhcGhGb3JnZUVsZW1lbnQgfSBmcm9tICcuLi8uLi9ibG9jay1mb3JnZSc7XG5cbmltcG9ydCB7IEJhc2VNZ3IsIE1lc3NhZ2VNZ3IsIE1lc3NhZ2VUeXBlLCBNYXNrTWdyLCBHcmFwaENvbmZpZ01nciwgSUdyYXBoQ29uZmlnIH0gZnJvbSAnLi9pbmRleCc7XG5pbXBvcnQgeyBBc3NldEluZm8gfSBmcm9tICdAY29jb3MvY3JlYXRvci10eXBlcy9lZGl0b3IvcGFja2FnZXMvYXNzZXQtZGIvQHR5cGVzL3B1YmxpYyc7XG5pbXBvcnQgeyBnZXROYW1lIH0gZnJvbSAnLi4vdXRpbHMnO1xuXG4vKipcbiAqIOeUqOS6juWkhOeQhiBzaGFkZXItZ3JhcGgg5pWw5o2uXG4gKi9cbmV4cG9ydCBjbGFzcyBHcmFwaERhdGFNZ3IgZXh0ZW5kcyBCYXNlTWdyIHtcblxuICAgIHN0YXRpYyBfaW5zdGFuY2U6IEdyYXBoRGF0YU1nciB8IG51bGwgPSBudWxsO1xuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgSW5zdGFuY2UoKTogR3JhcGhEYXRhTWdyIHtcbiAgICAgICAgaWYgKCF0aGlzLl9pbnN0YW5jZSkge1xuICAgICAgICAgICAgdGhpcy5faW5zdGFuY2UgPSBuZXcgR3JhcGhEYXRhTWdyKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2luc3RhbmNlO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgYXN5bmMgY3JlYXRlRGVmYXVsdFNoYWRlckdyYXBoKHR5cGUgPSAnU3VyZmFjZU1hc3Rlck5vZGUnLCBncmFwaFR5cGUgPSAnR3JhcGgnLCBncmFwaE5hbWUgPSAnTmV3IFNoYWRlciBHcmFwaCcpIHtcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdTdXJmYWNlJzpcbiAgICAgICAgICAgICAgICB0eXBlID0gJ1N1cmZhY2VNYXN0ZXJOb2RlJztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ1VubGl0JzpcbiAgICAgICAgICAgICAgICB0eXBlID0gJ1VubGl0TWFzdGVyTm9kZSc7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBncmFwaEdyYXBoRGF0YTogR3JhcGhEYXRhID0ge1xuICAgICAgICAgICAgdHlwZTogZ3JhcGhUeXBlLFxuICAgICAgICAgICAgbmFtZTogZ3JhcGhOYW1lLFxuICAgICAgICAgICAgbm9kZXM6IHt9LFxuICAgICAgICAgICAgZ3JhcGhzOiB7fSxcbiAgICAgICAgICAgIGxpbmVzOiB7fSxcbiAgICAgICAgICAgIGRldGFpbHM6IHtcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzOiBbXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGJsb2NrRGF0YSA9IGF3YWl0IGdldEJsb2NrRGF0YUJ5VHlwZSh0eXBlKTtcbiAgICAgICAgaWYgKCFibG9ja0RhdGEpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBjcmVhdGUgZGVmYXVsdCBzaGFkZXIgZ3JhcGggZmFpbGVkLCBNYXN0ZXJOb2RlOiAke3R5cGV9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBibG9ja0RhdGEucG9zaXRpb24gPSB7IHg6IDM0NywgeTogLTI4MCB9O1xuICAgICAgICAgICAgZ3JhcGhHcmFwaERhdGEubm9kZXNbZ2VuZXJhdGVVVUlEKCldID0gYmxvY2tEYXRhO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB5YW1sLmR1bXAoZ3JhcGhHcmFwaERhdGEpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOihqOekuuaYr+WQpuiuvue9riBHcmFwaFxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJvdGVjdGVkIF9kaXJ0eSA9IGZhbHNlO1xuXG4gICAgLy8g5Zu+5pWw5o2uXG4gICAgcHJvdGVjdGVkIGxhc3RHcmFwaERhdGE6IEdyYXBoRGF0YSB8IHVuZGVmaW5lZDtcbiAgICBwdWJsaWMgZ3JhcGhEYXRhOiBHcmFwaERhdGEgfCBudWxsID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIOWtmOWCqOmdouadv+S4gOS6m+S4u+imgemFjee9rlxuICAgICAqIOS+i+Wmgue8qeaUvu+8jOWBj+enu1xuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBncmFwaENvbmZpZzogSUdyYXBoQ29uZmlnIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuXG4gICAgcHVibGljIHNldERpcnR5KHZhbDogYm9vbGVhbiwgdHlwZT86IHN0cmluZykge1xuICAgICAgICB0aGlzLl9kaXJ0eSA9IHZhbDtcbiAgICAgICAgTWVzc2FnZU1nci5JbnN0YW5jZS5zZW5kKE1lc3NhZ2VUeXBlLkRpcnR5Q2hhbmdlZCwgdmFsLCB0eXBlKTtcbiAgICB9XG4gICAgcHVibGljIGdldERpcnR5KCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZGlydHk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkFzc2V0TG9hZGVkQmluZD86ICh1dWlkOiBzdHJpbmcpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSBvbkRpcnR5RGVib3VuY2U/OiAoZXZlbnQ6IEV2ZW50KSA9PiB2b2lkO1xuICAgIHByaXZhdGUgb25FbnRlckdyYXBoQmluZD86ICgpID0+IHZvaWQ7XG5cbiAgICByZWxlYXNlKCkge1xuICAgICAgICBpZiAodGhpcy5vbkRpcnR5RGVib3VuY2UpIHtcbiAgICAgICAgICAgIHRoaXMuZ3JhcGhGb3JnZS5yZW1vdmVFdmVudExpc3RlbmVyKCdkaXJ0eScsIHRoaXMub25EaXJ0eURlYm91bmNlKTtcbiAgICAgICAgICAgIHRoaXMuZ3JhcGhGb3JnZS5yZW1vdmVFdmVudExpc3RlbmVyKCd1bmRvJywgdGhpcy5vbkRpcnR5RGVib3VuY2UpO1xuICAgICAgICAgICAgdGhpcy5ncmFwaEZvcmdlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3JlZG8nLCB0aGlzLm9uRGlydHlEZWJvdW5jZSk7XG4gICAgICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLnJlZ2lzdGVyKE1lc3NhZ2VUeXBlLkRpcnR5LCB0aGlzLm9uRGlydHlEZWJvdW5jZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5vbkVudGVyR3JhcGhCaW5kICYmIHRoaXMuZ3JhcGhGb3JnZS5yZW1vdmVFdmVudExpc3RlbmVyKCdlbnRlci1ncmFwaCcsIHRoaXMub25FbnRlckdyYXBoQmluZCk7XG4gICAgICAgIHRoaXMub25Bc3NldExvYWRlZEJpbmQgJiYgTWVzc2FnZU1nci5JbnN0YW5jZS51bnJlZ2lzdGVyKE1lc3NhZ2VUeXBlLkFzc2V0TG9hZGVkLCB0aGlzLm9uQXNzZXRMb2FkZWRCaW5kKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0R3JhcGhGb3JnZShmb3JnZTogSFRNTEdyYXBoRm9yZ2VFbGVtZW50KSB7XG4gICAgICAgIHN1cGVyLnNldEdyYXBoRm9yZ2UoZm9yZ2UpO1xuICAgICAgICB0aGlzLm9uRGlydHlEZWJvdW5jZSA9IGRlYm91bmNlKHRoaXMub25EaXJ0eS5iaW5kKHRoaXMpLCAxMDApO1xuICAgICAgICBmb3JnZS5hZGRFdmVudExpc3RlbmVyKCdkaXJ0eScsIHRoaXMub25EaXJ0eURlYm91bmNlKTtcbiAgICAgICAgZm9yZ2UuYWRkRXZlbnRMaXN0ZW5lcigndW5kbycsIHRoaXMub25EaXJ0eURlYm91bmNlKTtcbiAgICAgICAgZm9yZ2UuYWRkRXZlbnRMaXN0ZW5lcigncmVkbycsIHRoaXMub25EaXJ0eURlYm91bmNlKTtcblxuICAgICAgICB0aGlzLm9uRW50ZXJHcmFwaEJpbmQgPSB0aGlzLm9uRW50ZXJHcmFwaC5iaW5kKHRoaXMpO1xuICAgICAgICBmb3JnZS5hZGRFdmVudExpc3RlbmVyKCdlbnRlci1ncmFwaCcsIHRoaXMub25FbnRlckdyYXBoQmluZCk7XG5cbiAgICAgICAgdGhpcy5vbkFzc2V0TG9hZGVkQmluZCA9IHRoaXMub25Bc3NldExvYWRlZC5iaW5kKHRoaXMpO1xuICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLnJlZ2lzdGVyKE1lc3NhZ2VUeXBlLkFzc2V0TG9hZGVkLCB0aGlzLm9uQXNzZXRMb2FkZWRCaW5kKTtcbiAgICAgICAgTWVzc2FnZU1nci5JbnN0YW5jZS5yZWdpc3RlcihNZXNzYWdlVHlwZS5EaXJ0eSwgdGhpcy5vbkRpcnR5RGVib3VuY2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVzZXQoKSB7XG4gICAgICAgIHRoaXMuc2V0RGlydHkoZmFsc2UpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25Bc3NldExvYWRlZCgpIHtcbiAgICAgICAgdGhpcy5yZXNldCgpO1xuICAgICAgICB0aGlzLnJlbG9hZCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25EaXJ0eShldmVudDogRXZlbnQpIHtcbiAgICAgICAgaWYgKCF0aGlzLmdyYXBoRm9yZ2UpIHJldHVybjtcblxuICAgICAgICBHcmFwaENvbmZpZ01nci5JbnN0YW5jZS5hdXRvU2F2ZSgpLnRoZW4oKCkgPT4ge30pO1xuICAgICAgICBjb25zdCBjdXN0b21FdmVudCA9IGV2ZW50IGFzIEN1c3RvbUV2ZW50O1xuICAgICAgICB0aGlzLnNldERpcnR5KHRydWUsIGN1c3RvbUV2ZW50ICYmIGN1c3RvbUV2ZW50LmRldGFpbD8uZGlydHlUeXBlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25FbnRlckdyYXBoKCkge1xuICAgICAgICBpZiAoIXRoaXMuZ3JhcGhGb3JnZSkgcmV0dXJuO1xuXG4gICAgICAgIHRoaXMuZ3JhcGhEYXRhID0gdGhpcy5ncmFwaEZvcmdlLmdldEN1cnJlbnRHcmFwaCgpO1xuICAgICAgICBNZXNzYWdlTWdyLkluc3RhbmNlLnNlbmQoTWVzc2FnZVR5cGUuRW50ZXJHcmFwaCk7XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlc3RvcmUoKSB7XG4gICAgICAgIGlmICh0aGlzLmxhc3RHcmFwaERhdGEpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0R3JhcGhEYXRhVG9Gb3JnZSh0aGlzLmxhc3RHcmFwaERhdGEpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZ3JhcGhEYXRhID0gdGhpcy5ncmFwaEZvcmdlLmdldEN1cnJlbnRHcmFwaCgpO1xuICAgICAgICB0aGlzLmxhc3RHcmFwaERhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuZ3JhcGhEYXRhKSk7XG5cbiAgICAgICAgdGhpcy5zZXREaXJ0eShmYWxzZSk7XG5cbiAgICAgICAgTWVzc2FnZU1nci5JbnN0YW5jZS5zZW5kKE1lc3NhZ2VUeXBlLlJlc3RvcmUpO1xuICAgIH1cblxuICAgIHB1YmxpYyBzZXRHcmFwaERhdGFCeUFzc2V0KGFzc2V0SW5mbzogQXNzZXRJbmZvLCBhc3NldDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5ncmFwaEZvcmdlKSByZXR1cm47XG5cbiAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgICB0aGlzLmdyYXBoRGF0YSA9IHRoaXMudmFsaWRhdGVHcmFwaERhdGEoYXNzZXRJbmZvLCB0aGlzLmdyYXBoRm9yZ2UuZGVzZXJpYWxpemUoYXNzZXQpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybigncmVsb2FkIGZhaWxlZCwgZ3JhcGggZGF0YSBhc3NldCBpcyBudWxsLicpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIGFzeW5jIHJlbG9hZCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmdyYXBoRm9yZ2UgfHwgIXRoaXMuZ3JhcGhEYXRhKSByZXR1cm47XG5cbiAgICAgICAgdGhpcy5sYXN0R3JhcGhEYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmdyYXBoRGF0YSkpO1xuICAgICAgICB0aGlzLnNldEdyYXBoRGF0YVRvRm9yZ2UodGhpcy5ncmFwaERhdGEpO1xuXG4gICAgICAgIGF3YWl0IEdyYXBoQ29uZmlnTWdyLkluc3RhbmNlLnN5bmMoKTtcbiAgICAgICAgTWFza01nci5JbnN0YW5jZS5oaWRlQWxsKCk7XG4gICAgICAgIE1lc3NhZ2VNZ3IuSW5zdGFuY2Uuc2VuZChNZXNzYWdlVHlwZS5TZXRHcmFwaERhdGFUb0ZvcmdlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3luY0xhc3RHcmFwaERhdGEoKSB7XG4gICAgICAgIHRoaXMubGFzdEdyYXBoRGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5ncmFwaERhdGEpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDlrZjlgqjliLAgQXNzZXQg55qE5a2X56ym5Liy5pWw5o2uXG4gICAgICovXG4gICAgcHVibGljIGdldEdyYXBoQXNzZXREYXRhKCk6IHN0cmluZyB7XG4gICAgICAgIGlmICghdGhpcy5ncmFwaEZvcmdlKSByZXR1cm4gJyc7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuZ3JhcGhGb3JnZS5zZXJpYWxpemUoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDov5jljp/miJDljp/lp4voioLngrlcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHB1YmxpYyByZWR1Y2VUb0Jhc2VOb2RlKHByb3BlcnR5OiBQcm9wZXJ0eURhdGEpIHtcbiAgICAgICAgY29uc3QgZ3JhcGhEYXRhID0gdGhpcy5nZXRDdXJyZW50R3JhcGhEYXRhKCk7XG4gICAgICAgIGZvciAoY29uc3Qgbm9kZUlEIGluIGdyYXBoRGF0YS5ub2Rlcykge1xuICAgICAgICAgICAgY29uc3Qgbm9kZTogQmxvY2tEYXRhID0gZ3JhcGhEYXRhLm5vZGVzW25vZGVJRF07XG4gICAgICAgICAgICBjb25zdCBkZXRhaWxzID0gbm9kZSAmJiBub2RlLmRldGFpbHM7XG4gICAgICAgICAgICBpZiAoIWRldGFpbHMpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICBpZiAoZGV0YWlscyAmJiBkZXRhaWxzLnByb3BlcnR5SUQgPT09IHByb3BlcnR5LmlkKSB7XG4gICAgICAgICAgICAgICAgZGV0YWlscy50aXRsZSA9IHByb3BlcnR5Lm5hbWU7XG4gICAgICAgICAgICAgICAgZGV0YWlscy5vdXRwdXRQaW5zID0gcHJvcGVydHkub3V0cHV0UGlucztcbiAgICAgICAgICAgICAgICAvLyDph43nva5cbiAgICAgICAgICAgICAgICBjb25zdCBibG9jayA9IGdldEJsb2NrVGVtcGxhdGVCeVR5cGUoZGV0YWlscy5iYXNlVHlwZSk7XG4gICAgICAgICAgICAgICAgbm9kZS50eXBlID0gZGV0YWlscy5iYXNlVHlwZTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0UGluczogUGluRGF0YVtdID0gW107XG4gICAgICAgICAgICAgICAgYmxvY2s/LmRhdGEuZGV0YWlscy5pbnB1dFBpbnM/LmZvckVhY2goKHBpbjogUGluRGF0YSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCByYXdQaW5EYXRhID0gZGV0YWlscy5pbnB1dFBpbnM/LltpbmRleF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChyYXdQaW5EYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaW4udmFsdWUgPSByYXdQaW5EYXRhLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlucHV0UGlucy5wdXNoKHBpbik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbm9kZS5kZXRhaWxzLmlucHV0UGlucyA9IGlucHV0UGlucztcblxuICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dFBpbnM6IFBpbkRhdGFbXSA9IFtdO1xuICAgICAgICAgICAgICAgIGJsb2NrPy5kYXRhLmRldGFpbHMub3V0cHV0UGlucz8uZm9yRWFjaCgocGluOiBQaW5EYXRhLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJhd1BpbkRhdGEgPSBkZXRhaWxzLm91dHB1dFBpbnM/LltpbmRleF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChyYXdQaW5EYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaW4udmFsdWUgPSByYXdQaW5EYXRhLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG91dHB1dFBpbnMucHVzaChwaW4pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIG5vZGUuZGV0YWlscy5vdXRwdXRQaW5zID0gb3V0cHV0UGlucztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldEdyYXBoRGF0YVRvRm9yZ2UoZ3JhcGhEYXRhKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDpqozor4HmlbDmja5cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByb3RlY3RlZCB2YWxpZGF0ZUdyYXBoRGF0YShhc3NldEluZm86IEFzc2V0SW5mbywgZ3JhcGhEYXRhOiBHcmFwaERhdGEpIHtcbiAgICAgICAgbGV0IGRpcnR5ID0gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgbmV3TmFtZSA9IGdldE5hbWUoYXNzZXRJbmZvLnBhdGgpO1xuICAgICAgICBpZiAoZ3JhcGhEYXRhLm5hbWUgIT09IG5ld05hbWUpIHtcbiAgICAgICAgICAgIGdyYXBoRGF0YS5uYW1lID0gbmV3TmFtZTtcbiAgICAgICAgICAgIGRpcnR5ID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAoY29uc3QgdXVpZCBpbiBncmFwaERhdGEubm9kZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGJsb2NrOiBCbG9ja0RhdGEgPSBncmFwaERhdGEubm9kZXNbdXVpZF07XG4gICAgICAgICAgICBjb25zdCBibG9ja1RlbXBsYXRlOiBCbG9ja1RlbXBsYXRlRGF0YSB8IHVuZGVmaW5lZCA9IGdldEJsb2NrVGVtcGxhdGVCeVR5cGUoYmxvY2sudHlwZSk7XG4gICAgICAgICAgICBpZiAoYmxvY2tUZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIC8vIDEu5paw5aKeIHNsb3Qg6ZyA6KaB6KGl5YWo5pWw5o2uXG4gICAgICAgICAgICAgICAgY29uc3QgaW5wdXRQaW5zID0gYmxvY2suZGV0YWlscy5pbnB1dFBpbnM7XG4gICAgICAgICAgICAgICAgaWYgKGlucHV0UGlucyAmJiBibG9ja1RlbXBsYXRlLmRhdGEuZGV0YWlscy5pbnB1dFBpbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgYmxvY2tUZW1wbGF0ZS5kYXRhLmRldGFpbHMuaW5wdXRQaW5zLmZvckVhY2goKHBpbjogUGluRGF0YSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXRQaW5EYXRhOiBQaW5EYXRhIHwgdW5kZWZpbmVkID0gaW5wdXRQaW5zW2luZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW5wdXRQaW5EYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRQaW5zW2luZGV4XSA9IHBpbjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJ0eSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyDliJ3lp4vljJZcbiAgICAgICAgaWYgKCFncmFwaERhdGEuZGV0YWlscy5wcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgICBncmFwaERhdGEuZGV0YWlscy5wcm9wZXJ0aWVzID0gW107XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRpcnR5ICYmIHRoaXMuZ3JhcGhGb3JnZSkge1xuICAgICAgICAgICAgRWRpdG9yLk1lc3NhZ2UucmVxdWVzdCgnYXNzZXQtZGInLCAnc2F2ZS1hc3NldCcsIGFzc2V0SW5mby51dWlkLCB0aGlzLmdyYXBoRm9yZ2Uuc2VyaWFsaXplKGdyYXBoRGF0YSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBncmFwaERhdGE7XG4gICAgfVxufVxuXG4iXX0=