"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphConfigMgr = void 0;
const lodash_1 = require("lodash");
const global_exports_1 = require("../global-exports");
const base_mgr_1 = require("./base-mgr");
const float_window_1 = require("../../panels/shader-graph/components/float-window");
const CONFIG_KEY = 'shader-graph.graph-configs';
/**
 * 用于处理 shader-graph 配置存储
 */
class GraphConfigMgr extends base_mgr_1.BaseMgr {
    constructor() {
        super(...arguments);
        this.uuid = '';
        this.floatWindows = {};
        this.graphConfigs = {};
    }
    static get Instance() {
        if (!this._instance) {
            this._instance = new GraphConfigMgr();
        }
        return this._instance;
    }
    getFloatingWindowConfig(name, floatWindowConfig) {
        const { top, left, right, bottom, width, height } = this.floatWindows[name].style;
        const show = (this.floatWindows[name].getAttribute('hidden') === null);
        floatWindowConfig = floatWindowConfig || {};
        if (!floatWindowConfig.position) {
            floatWindowConfig.position = {};
        }
        if (left) {
            floatWindowConfig.position.left = left;
        }
        else {
            delete floatWindowConfig.position.left;
        }
        if (right) {
            floatWindowConfig.position.right = right;
        }
        else {
            delete floatWindowConfig.position.right;
        }
        if (top) {
            floatWindowConfig.position.top = top;
        }
        else {
            delete floatWindowConfig.position.top;
        }
        if (bottom) {
            floatWindowConfig.position.bottom = bottom;
        }
        else {
            delete floatWindowConfig.position.bottom;
        }
        if (Object.keys(floatWindowConfig.position).length === 0) {
            delete floatWindowConfig.position;
        }
        floatWindowConfig.show = show;
        floatWindowConfig.width = width;
        floatWindowConfig.height = height;
        return floatWindowConfig;
    }
    getConfig(uuid) {
        return this.graphConfigs[uuid || this.uuid] || { offset: { x: 0, y: 0 }, scale: 1, floatWindows: {} };
    }
    async load() {
        this.uuid = await Editor.Profile.getConfig(global_exports_1.PACKAGE_JSON.name, 'asset-uuid', 'local');
        this.graphConfigs = await Editor.Profile.getConfig(global_exports_1.PACKAGE_JSON.name, CONFIG_KEY, 'local') || {};
        console.debug('load config: ', this.uuid, this.graphConfigs);
    }
    async delete(uuid) {
        delete this.graphConfigs[uuid || this.uuid];
        await Editor.Profile.setConfig(global_exports_1.PACKAGE_JSON.name, CONFIG_KEY, this.graphConfigs, 'local');
    }
    async sync() {
        this.graphForge.setGraphInfo(await this.getConfig());
    }
    async autoSave(assetUuid) {
        const uuid = assetUuid || this.uuid;
        const graphConfig = this.getConfig(uuid);
        const graphInfo = this.graphForge.getGraphInfo();
        graphConfig.scale = graphInfo.scale;
        graphConfig.offset = graphInfo.offset;
        for (const name in this.floatWindows) {
            const config = (0, float_window_1.getFloatWindowConfigByName)(name);
            if (!config?.dontSave) {
                graphConfig.floatWindows[name] = this.getFloatingWindowConfig(name, graphConfig.floatWindows[name]);
            }
            if (graphConfig.floatWindows[name] && 0 === Object.keys(graphConfig.floatWindows[name]).length) {
                delete graphConfig.floatWindows[name];
            }
        }
        this.graphConfigs[uuid] = graphConfig;
        console.debug('Auto save config: ', uuid, this.graphConfigs);
        await Editor.Profile.setConfig(global_exports_1.PACKAGE_JSON.name, CONFIG_KEY, this.graphConfigs, 'local');
    }
    getFloatingWindowConfigByName(name) {
        return this.getConfig().floatWindows[name];
    }
    async saveDetails(name, details) {
        const graphConfig = this.getConfig();
        graphConfig.floatWindows[name] = (0, lodash_1.merge)({}, graphConfig.floatWindows[name], details);
        this.graphConfigs[this.uuid] = graphConfig;
        await Editor.Profile.setConfig(global_exports_1.PACKAGE_NAME, CONFIG_KEY, this.graphConfigs, 'local');
    }
    addFloatWindow(name, floatWindow) {
        this.floatWindows[name] = floatWindow;
    }
}
exports.GraphConfigMgr = GraphConfigMgr;
GraphConfigMgr._instance = null;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhcGgtY29uZmlnLW1nci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zaGFkZXItZ3JhcGgvYmFzZS9ncmFwaC1jb25maWctbWdyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUErQjtBQUcvQixzREFBK0Q7QUFDL0QseUNBQXFDO0FBQ3JDLG9GQUErRjtBQUUvRixNQUFNLFVBQVUsR0FBRyw0QkFBNEIsQ0FBQztBQUVoRDs7R0FFRztBQUNILE1BQWEsY0FBZSxTQUFRLGtCQUFPO0lBQTNDOztRQVdZLFNBQUksR0FBRyxFQUFFLENBQUM7UUFDVixpQkFBWSxHQUFtQyxFQUFFLENBQUM7UUFDbEQsaUJBQVksR0FBa0IsRUFBRSxDQUFDO0lBbUc3QyxDQUFDO0lBNUdVLE1BQU0sS0FBSyxRQUFRO1FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztTQUN6QztRQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBTVMsdUJBQXVCLENBQUMsSUFBWSxFQUFFLGlCQUFxQztRQUNqRixNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNsRixNQUFNLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBRXZFLGlCQUFpQixHQUFHLGlCQUFpQixJQUFJLEVBQUUsQ0FBQztRQUM1QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxFQUFFO1lBQzdCLGlCQUFpQixDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7U0FD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LFdBQVcsQ0FBQyxJQUFZLEVBQUUsT0FBOEI7UUFDakUsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3JDLFdBQVcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBQSxjQUFLLEVBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDcEYsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDO1FBQzNDLE1BQU0sTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsNkJBQVksRUFBRSxVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBRU0sY0FBYyxDQUFDLElBQVksRUFBRSxXQUF3QjtRQUN4RCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLFdBQVcsQ0FBQztJQUMxQyxDQUFDOztBQS9HTCx3Q0FnSEM7QUE5R1Usd0JBQVMsR0FBMEIsSUFBSSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWVyZ2UgfSBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBJRmxvYXRXaW5kb3dDb25maWcsIElHcmFwaENvbmZpZ3MgfSBmcm9tICcuL2ludGVybmFsJztcbmltcG9ydCB7IFBBQ0tBR0VfSlNPTiwgUEFDS0FHRV9OQU1FIH0gZnJvbSAnLi4vZ2xvYmFsLWV4cG9ydHMnO1xuaW1wb3J0IHsgQmFzZU1nciB9IGZyb20gJy4vYmFzZS1tZ3InO1xuaW1wb3J0IHsgZ2V0RmxvYXRXaW5kb3dDb25maWdCeU5hbWUgfSBmcm9tICcuLi8uLi9wYW5lbHMvc2hhZGVyLWdyYXBoL2NvbXBvbmVudHMvZmxvYXQtd2luZG93JztcblxuY29uc3QgQ09ORklHX0tFWSA9ICdzaGFkZXItZ3JhcGguZ3JhcGgtY29uZmlncyc7XG5cbi8qKlxuICog55So5LqO5aSE55CGIHNoYWRlci1ncmFwaCDphY3nva7lrZjlgqhcbiAqL1xuZXhwb3J0IGNsYXNzIEdyYXBoQ29uZmlnTWdyIGV4dGVuZHMgQmFzZU1nciB7XG5cbiAgICBzdGF0aWMgX2luc3RhbmNlOiBHcmFwaENvbmZpZ01nciB8IG51bGwgPSBudWxsO1xuXG4gICAgcHVibGljIHN0YXRpYyBnZXQgSW5zdGFuY2UoKTogR3JhcGhDb25maWdNZ3Ige1xuICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlKSB7XG4gICAgICAgICAgICB0aGlzLl9pbnN0YW5jZSA9IG5ldyBHcmFwaENvbmZpZ01ncigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHV1aWQgPSAnJztcbiAgICBwcml2YXRlIGZsb2F0V2luZG93czogeyBba2V5OiBzdHJpbmddOiBIVE1MRWxlbWVudCB9ID0ge307XG4gICAgcHJpdmF0ZSBncmFwaENvbmZpZ3M6IElHcmFwaENvbmZpZ3MgPSB7fTtcblxuICAgIHByb3RlY3RlZCBnZXRGbG9hdGluZ1dpbmRvd0NvbmZpZyhuYW1lOiBzdHJpbmcsIGZsb2F0V2luZG93Q29uZmlnOiBJRmxvYXRXaW5kb3dDb25maWcpOiBJRmxvYXRXaW5kb3dDb25maWcge1xuICAgICAgICBjb25zdCB7IHRvcCwgbGVmdCwgcmlnaHQsIGJvdHRvbSwgd2lkdGgsIGhlaWdodCB9ID0gdGhpcy5mbG9hdFdpbmRvd3NbbmFtZV0uc3R5bGU7XG4gICAgICAgIGNvbnN0IHNob3cgPSAodGhpcy5mbG9hdFdpbmRvd3NbbmFtZV0uZ2V0QXR0cmlidXRlKCdoaWRkZW4nKSA9PT0gbnVsbCk7XG5cbiAgICAgICAgZmxvYXRXaW5kb3dDb25maWcgPSBmbG9hdFdpbmRvd0NvbmZpZyB8fCB7fTtcbiAgICAgICAgaWYgKCFmbG9hdFdpbmRvd0NvbmZpZy5wb3NpdGlvbikge1xuICAgICAgICAgICAgZmxvYXRXaW5kb3dDb25maWcucG9zaXRpb24gPSB7fTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChsZWZ0KSB7XG4gICAgICAgICAgICBmbG9hdFdpbmRvd0NvbmZpZy5wb3NpdGlvbi5sZWZ0ID0gbGVmdDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRlbGV0ZSBmbG9hdFdpbmRvd0NvbmZpZy5wb3NpdGlvbi5sZWZ0O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHJpZ2h0KSB7XG4gICAgICAgICAgICBmbG9hdFdpbmRvd0NvbmZpZy5wb3NpdGlvbi5yaWdodCA9IHJpZ2h0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVsZXRlIGZsb2F0V2luZG93Q29uZmlnLnBvc2l0aW9uLnJpZ2h0O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRvcCkge1xuICAgICAgICAgICAgZmxvYXRXaW5kb3dDb25maWcucG9zaXRpb24udG9wID0gdG9wO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVsZXRlIGZsb2F0V2luZG93Q29uZmlnLnBvc2l0aW9uLnRvcDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChib3R0b20pIHtcbiAgICAgICAgICAgIGZsb2F0V2luZG93Q29uZmlnLnBvc2l0aW9uLmJvdHRvbSA9IGJvdHRvbTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGRlbGV0ZSBmbG9hdFdpbmRvd0NvbmZpZy5wb3NpdGlvbi5ib3R0b207XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoT2JqZWN0LmtleXMoZmxvYXRXaW5kb3dDb25maWcucG9zaXRpb24pLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgZGVsZXRlIGZsb2F0V2luZG93Q29uZmlnLnBvc2l0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgZmxvYXRXaW5kb3dDb25maWcuc2hvdyA9IHNob3c7XG4gICAgICAgIGZsb2F0V2luZG93Q29uZmlnLndpZHRoID0gd2lkdGg7XG4gICAgICAgIGZsb2F0V2luZG93Q29uZmlnLmhlaWdodCA9IGhlaWdodDtcblxuICAgICAgICByZXR1cm4gZmxvYXRXaW5kb3dDb25maWc7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIGdldENvbmZpZyh1dWlkPzogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdyYXBoQ29uZmlnc1t1dWlkIHx8IHRoaXMudXVpZF0gfHwgeyBvZmZzZXQ6IHsgeDogMCwgeTogMCB9LCBzY2FsZTogMSwgZmxvYXRXaW5kb3dzOiB7fSB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBsb2FkKCkge1xuICAgICAgICB0aGlzLnV1aWQgPSBhd2FpdCBFZGl0b3IuUHJvZmlsZS5nZXRDb25maWcoUEFDS0FHRV9KU09OLm5hbWUsICdhc3NldC11dWlkJywgJ2xvY2FsJyk7XG4gICAgICAgIHRoaXMuZ3JhcGhDb25maWdzID0gYXdhaXQgRWRpdG9yLlByb2ZpbGUuZ2V0Q29uZmlnKFBBQ0tBR0VfSlNPTi5uYW1lLCBDT05GSUdfS0VZLCAnbG9jYWwnKSB8fCB7fTtcbiAgICAgICAgY29uc29sZS5kZWJ1ZygnbG9hZCBjb25maWc6ICcsIHRoaXMudXVpZCwgdGhpcy5ncmFwaENvbmZpZ3MpO1xuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBkZWxldGUodXVpZD86IHN0cmluZykge1xuICAgICAgICBkZWxldGUgdGhpcy5ncmFwaENvbmZpZ3NbdXVpZCB8fCB0aGlzLnV1aWRdO1xuICAgICAgICBhd2FpdCBFZGl0b3IuUHJvZmlsZS5zZXRDb25maWcoUEFDS0FHRV9KU09OLm5hbWUsIENPTkZJR19LRVksIHRoaXMuZ3JhcGhDb25maWdzLCAnbG9jYWwnKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgc3luYygpIHtcbiAgICAgICAgdGhpcy5ncmFwaEZvcmdlLnNldEdyYXBoSW5mbyhhd2FpdCB0aGlzLmdldENvbmZpZygpKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgYXV0b1NhdmUoYXNzZXRVdWlkPzogc3RyaW5nICkge1xuICAgICAgICBjb25zdCB1dWlkID0gYXNzZXRVdWlkIHx8IHRoaXMudXVpZDtcbiAgICAgICAgY29uc3QgZ3JhcGhDb25maWcgPSB0aGlzLmdldENvbmZpZyh1dWlkKTtcbiAgICAgICAgY29uc3QgZ3JhcGhJbmZvID0gdGhpcy5ncmFwaEZvcmdlLmdldEdyYXBoSW5mbygpO1xuICAgICAgICBncmFwaENvbmZpZy5zY2FsZSA9IGdyYXBoSW5mby5zY2FsZTtcbiAgICAgICAgZ3JhcGhDb25maWcub2Zmc2V0ID0gZ3JhcGhJbmZvLm9mZnNldDtcbiAgICAgICAgZm9yIChjb25zdCBuYW1lIGluIHRoaXMuZmxvYXRXaW5kb3dzKSB7XG4gICAgICAgICAgICBjb25zdCBjb25maWcgPSBnZXRGbG9hdFdpbmRvd0NvbmZpZ0J5TmFtZShuYW1lKTtcbiAgICAgICAgICAgIGlmICghY29uZmlnPy5kb250U2F2ZSkge1xuICAgICAgICAgICAgICAgIGdyYXBoQ29uZmlnLmZsb2F0V2luZG93c1tuYW1lXSA9IHRoaXMuZ2V0RmxvYXRpbmdXaW5kb3dDb25maWcobmFtZSwgZ3JhcGhDb25maWcuZmxvYXRXaW5kb3dzW25hbWVdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChncmFwaENvbmZpZy5mbG9hdFdpbmRvd3NbbmFtZV0gJiYgMCA9PT0gT2JqZWN0LmtleXMoZ3JhcGhDb25maWcuZmxvYXRXaW5kb3dzW25hbWVdKS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBkZWxldGUgZ3JhcGhDb25maWcuZmxvYXRXaW5kb3dzW25hbWVdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuZ3JhcGhDb25maWdzW3V1aWRdID0gZ3JhcGhDb25maWc7XG4gICAgICAgIGNvbnNvbGUuZGVidWcoJ0F1dG8gc2F2ZSBjb25maWc6ICcsIHV1aWQsIHRoaXMuZ3JhcGhDb25maWdzKTtcbiAgICAgICAgYXdhaXQgRWRpdG9yLlByb2ZpbGUuc2V0Q29uZmlnKFBBQ0tBR0VfSlNPTi5uYW1lLCBDT05GSUdfS0VZLCB0aGlzLmdyYXBoQ29uZmlncywgJ2xvY2FsJyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldEZsb2F0aW5nV2luZG93Q29uZmlnQnlOYW1lKG5hbWU6IHN0cmluZyk6IElGbG9hdFdpbmRvd0NvbmZpZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldENvbmZpZygpLmZsb2F0V2luZG93c1tuYW1lXTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgc2F2ZURldGFpbHMobmFtZTogc3RyaW5nLCBkZXRhaWxzOiB7IFtrZXk6IHN0cmluZ106IGFueX0pIHtcbiAgICAgICAgY29uc3QgZ3JhcGhDb25maWcgPSB0aGlzLmdldENvbmZpZygpO1xuICAgICAgICBncmFwaENvbmZpZy5mbG9hdFdpbmRvd3NbbmFtZV0gPSBtZXJnZSh7fSwgZ3JhcGhDb25maWcuZmxvYXRXaW5kb3dzW25hbWVdLCBkZXRhaWxzKTtcbiAgICAgICAgdGhpcy5ncmFwaENvbmZpZ3NbdGhpcy51dWlkXSA9IGdyYXBoQ29uZmlnO1xuICAgICAgICBhd2FpdCBFZGl0b3IuUHJvZmlsZS5zZXRDb25maWcoUEFDS0FHRV9OQU1FLCBDT05GSUdfS0VZLCB0aGlzLmdyYXBoQ29uZmlncywgJ2xvY2FsJyk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZEZsb2F0V2luZG93KG5hbWU6IHN0cmluZywgZmxvYXRXaW5kb3c6IEhUTUxFbGVtZW50KSB7XG4gICAgICAgIHRoaXMuZmxvYXRXaW5kb3dzW25hbWVdID0gZmxvYXRXaW5kb3c7XG4gICAgfVxufVxuIl19