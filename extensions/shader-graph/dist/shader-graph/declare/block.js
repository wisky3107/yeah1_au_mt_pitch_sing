"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.declareShaderNodeBlock = exports.registerDynamicEnum = exports.createPin = exports.createPinTag = exports.pinMap = exports.normalBlockCacheMap = void 0;
const block_forge_1 = require("../../block-forge");
const utils_1 = require("../utils");
exports.normalBlockCacheMap = new Map();
exports.pinMap = new Map();
function createPinTag(blockType, slotTag, slot) {
    return (0, utils_1.generatePinID)(slotTag, blockType, slot.type, slot.display);
}
exports.createPinTag = createPinTag;
function createPin(blockType, slotTag, slot, details) {
    const tag = createPinTag(blockType, slotTag, slot);
    const pinDescription = {
        tag: tag,
        dataType: slot.type,
        value: slot.default,
        name: slot.display,
        hidePin: slotTag === 'prop',
        details: {},
    };
    const pinData = {
        dataType: pinDescription.dataType,
        value: pinDescription.value,
        details: details || {},
    };
    if (slot.type === 'enum' && slot.enum) {
        // 注册枚举
        const type = slot.enum._name || `${blockType}_${slot.display}`;
        (0, block_forge_1.declareEnum)(type, slot.enum);
        pinData.value = slot.default;
        pinDescription.details.type = type;
    }
    else if (slot.type === 'dynamicEnum' && slot.registerEnum) {
        (0, block_forge_1.declareEnum)(slot.registerEnum.type, {});
        pinData.value = '';
        pinDescription.details.type = slot.registerEnum.type;
        pinDescription.details.defaultValue = slot.default;
    }
    if ('registerEnumType' in slot) {
        pinDescription.details.registerEnumType = slot.registerEnumType;
    }
    // 用于判断连线
    if ('connectType' in slot) {
        pinDescription.details.connectType = slot.connectType;
    }
    return {
        tag: tag,
        data: pinData,
        description: pinDescription,
    };
}
exports.createPin = createPin;
function createBlockByNodeDefine(nodeDefine) {
    const description = {
        type: nodeDefine.type,
        title: nodeDefine.details?.title || '',
        inputPins: [],
        outputPins: [],
        style: {
            headerColor: '#227F9B80',
        },
    };
    if (nodeDefine.details?.style !== undefined) {
        // 合并 style，已 dump 的 style 为主
        description.style = { ...description.style, ...nodeDefine.details?.style };
    }
    const blockData = {
        type: nodeDefine.type,
        position: { x: 0, y: 0 },
        details: {
            inputPins: [],
            outputPins: [],
        },
    };
    return {
        isMaster: nodeDefine.details?.master,
        details: nodeDefine.details,
        type: blockData.type,
        data: blockData,
        description: description,
    };
}
/**
 * 注册到动态枚举中，如果 value 重复就递增 1
 * 例如 test test_1
 * @param pinData
 * @param pinDesc
 */
function registerDynamicEnum(pinData, pinDesc) {
    let value = pinData.value;
    let index = 1;
    let done = false;
    while (!done) {
        done = (0, block_forge_1.declareDynamicEnumToType)({
            type: pinDesc.details.registerEnumType,
            name: value,
        });
        if (!done) {
            value = pinData.value + `_${index}`;
            index++;
        }
    }
    return value;
}
exports.registerDynamicEnum = registerDynamicEnum;
function createDynamicInputPins(blockDesc, details) {
    if (details.inputPinDescriptions) {
        return details.inputPinDescriptions.map((desc, index) => {
            const pinData = details.inputPins[index];
            if (desc.details.registerEnumType) {
                pinData.details.registerEnumType = desc.details.registerEnumType;
                pinData.value = registerDynamicEnum(pinData, desc);
            }
            return desc;
        });
    }
    else {
        return blockDesc.inputPins.map((desc, index) => {
            const newDesc = JSON.parse(JSON.stringify(desc));
            const pinData = details.inputPins[index];
            if (pinData) {
                if (newDesc.dataType === 'any') {
                    newDesc.dataType = pinData.dataType;
                    newDesc.value = pinData.value;
                }
                if (desc.details.registerEnumType) {
                    pinData.details.registerEnumType = desc.details.registerEnumType;
                    pinData.value = registerDynamicEnum(pinData, desc);
                }
            }
            return newDesc;
        });
    }
}
function createDynamicOutputPins(blockDesc, details) {
    if (details.outputPinDescriptions) {
        return details.outputPinDescriptions;
    }
    return blockDesc.outputPins.map((desc, index) => {
        const newDesc = JSON.parse(JSON.stringify(desc));
        const pinData = details.outputPins[index];
        if (pinData && newDesc.dataType === 'any') {
            newDesc.dataType = pinData.dataType;
            newDesc.value = pinData.value;
        }
        return newDesc;
    });
}
function declareShaderNodeBlock(shaderNodeMap) {
    // 清空缓存
    exports.normalBlockCacheMap.clear();
    exports.pinMap.clear();
    for (const [blockType, item] of shaderNodeMap) {
        const inputPins = [];
        const inputPinDescriptions = [];
        item.node.inputs?.forEach((slot) => {
            const pin = createPin(blockType, 'input', slot);
            inputPins.push(pin.data);
            inputPinDescriptions.push(pin.description);
            exports.pinMap.set(pin.tag, pin);
        });
        item.node.props?.forEach((slot) => {
            const pin = createPin(blockType, 'prop', slot);
            inputPins.push(pin.data);
            inputPinDescriptions.push(pin.description);
            exports.pinMap.set(pin.tag, pin);
        });
        const outputPins = [];
        const outputPinDescriptions = [];
        item.node.outputs?.forEach((slot) => {
            const pin = createPin(blockType, 'out', slot);
            outputPins.push(pin.data);
            outputPinDescriptions.push(pin.description);
            exports.pinMap.set(pin.tag, pin);
        });
        const block = createBlockByNodeDefine(item);
        block.data.details.inputPins = inputPins;
        block.data.details.outputPins = outputPins;
        block.description.inputPins = inputPinDescriptions;
        block.description.outputPins = outputPinDescriptions;
        block.description.createDynamicInputPins = createDynamicInputPins;
        block.description.createDynamicOutputPins = createDynamicOutputPins;
        exports.normalBlockCacheMap.set(block.type, block);
        // 注册
        (0, block_forge_1.declareBlock)(block.description);
    }
}
exports.declareShaderNodeBlock = declareShaderNodeBlock;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc2hhZGVyLWdyYXBoL2RlY2xhcmUvYmxvY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBSUEsbURBQXdGO0FBQ3hGLG9DQUF5QztBQUk1QixRQUFBLG1CQUFtQixHQUFtQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBRWhFLFFBQUEsTUFBTSxHQUFpRSxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBRTlGLFNBQWdCLFlBQVksQ0FBQyxTQUFpQixFQUFFLE9BQWdCLEVBQUUsSUFBZ0I7SUFDOUUsT0FBTyxJQUFBLHFCQUFhLEVBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0RSxDQUFDO0FBRkQsb0NBRUM7QUFDRCxTQUFnQixTQUFTLENBQUMsU0FBaUIsRUFBRSxPQUFnQixFQUFFLElBQWdCLEVBQUUsT0FBZ0M7SUFDN0csTUFBTSxHQUFHLEdBQUcsWUFBWSxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDbkQsTUFBTSxjQUFjLEdBQW9CO1FBQ3BDLEdBQUcsRUFBRSxHQUFHO1FBQ1IsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJO1FBQ25CLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTztRQUNuQixJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU87UUFDbEIsT0FBTyxFQUFFLE9BQU8sS0FBSyxNQUFNO1FBQzNCLE9BQU8sRUFBRSxFQUFFO0tBQ2QsQ0FBQztJQUNGLE1BQU0sT0FBTyxHQUFZO1FBQ3JCLFFBQVEsRUFBRSxjQUFjLENBQUMsUUFBUTtRQUNqQyxLQUFLLEVBQUUsY0FBYyxDQUFDLEtBQUs7UUFDM0IsT0FBTyxFQUFFLE9BQU8sSUFBSSxFQUFFO0tBQ3pCLENBQUM7SUFFRixJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssTUFBTSxJQUFJLElBQUksQ0FB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IHR5cGUgeyBCbG9ja1RlbXBsYXRlRGF0YSB9IGZyb20gJy4uL2ludGVybmFsJztcbmltcG9ydCB0eXBlIHsgQmxvY2tEYXRhLCBJQmxvY2tEZXNjcmlwdGlvbiwgSVBpbkRlc2NyaXB0aW9uLCBQaW5EYXRhIH0gZnJvbSAnLi4vLi4vYmxvY2stZm9yZ2UvaW50ZXJmYWNlJztcbmltcG9ydCB0eXBlIHsgUHJvcGVydHlEZWZpbmUsIE5vZGVEZWZpbmUsIFNsb3REZWZpbmUgfSBmcm9tICcuLi8uLi8uLi9AdHlwZXMvc2hhZGVyLW5vZGUtdHlwZSc7XG5cbmltcG9ydCB7IGRlY2xhcmVCbG9jaywgZGVjbGFyZUVudW0sIGRlY2xhcmVEeW5hbWljRW51bVRvVHlwZSB9IGZyb20gJy4uLy4uL2Jsb2NrLWZvcmdlJztcbmltcG9ydCB7IGdlbmVyYXRlUGluSUQgfSBmcm9tICcuLi91dGlscyc7XG5cbnR5cGUgU2xvdFRhZyA9ICdpbnB1dCcgfCAnb3V0JyB8ICdwcm9wJztcblxuZXhwb3J0IGNvbnN0IG5vcm1hbEJsb2NrQ2FjaGVNYXA6IE1hcDxzdHJpbmcsIEJsb2NrVGVtcGxhdGVEYXRhPiA9IG5ldyBNYXAoKTtcblxuZXhwb3J0IGNvbnN0IHBpbk1hcDogTWFwPHN0cmluZywgeyBkYXRhOiBQaW5EYXRhLCBkZXNjcmlwdGlvbjogSVBpbkRlc2NyaXB0aW9uIH0+ID0gbmV3IE1hcCgpO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUGluVGFnKGJsb2NrVHlwZTogc3RyaW5nLCBzbG90VGFnOiBTbG90VGFnLCBzbG90OiBTbG90RGVmaW5lKSB7XG4gICAgcmV0dXJuIGdlbmVyYXRlUGluSUQoc2xvdFRhZywgYmxvY2tUeXBlLCBzbG90LnR5cGUsIHNsb3QuZGlzcGxheSk7XG59XG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUGluKGJsb2NrVHlwZTogc3RyaW5nLCBzbG90VGFnOiBTbG90VGFnLCBzbG90OiBTbG90RGVmaW5lLCBkZXRhaWxzPzogeyBba2V5OiBzdHJpbmddOiBhbnkgfSkge1xuICAgIGNvbnN0IHRhZyA9IGNyZWF0ZVBpblRhZyhibG9ja1R5cGUsIHNsb3RUYWcsIHNsb3QpO1xuICAgIGNvbnN0IHBpbkRlc2NyaXB0aW9uOiBJUGluRGVzY3JpcHRpb24gPSB7XG4gICAgICAgIHRhZzogdGFnLFxuICAgICAgICBkYXRhVHlwZTogc2xvdC50eXBlLFxuICAgICAgICB2YWx1ZTogc2xvdC5kZWZhdWx0LFxuICAgICAgICBuYW1lOiBzbG90LmRpc3BsYXksXG4gICAgICAgIGhpZGVQaW46IHNsb3RUYWcgPT09ICdwcm9wJyxcbiAgICAgICAgZGV0YWlsczoge30sXG4gICAgfTtcbiAgICBjb25zdCBwaW5EYXRhOiBQaW5EYXRhID0ge1xuICAgICAgICBkYXRhVHlwZTogcGluRGVzY3JpcHRpb24uZGF0YVR5cGUsXG4gICAgICAgIHZhbHVlOiBwaW5EZXNjcmlwdGlvbi52YWx1ZSxcbiAgICAgICAgZGV0YWlsczogZGV0YWlscyB8fCB7fSxcbiAgICB9O1xuXG4gICAgaWYgKHNsb3QudHlwZSA9PT0gJ2VudW0nICYmIHNsb3QuZW51bSkge1xuICAgICAgICAvLyDms6jlhozmnprkuL5cbiAgICAgICAgY29uc3QgdHlwZSA9IHNsb3QuZW51bS5fbmFtZSB8fCBgJHtibG9ja1R5cGV9XyR7c2xvdC5kaXNwbGF5fWA7XG4gICAgICAgIGRlY2xhcmVFbnVtKHR5cGUsIHNsb3QuZW51bSk7XG4gICAgICAgIHBpbkRhdGEudmFsdWUgPSBzbG90LmRlZmF1bHQ7XG4gICAgICAgIHBpbkRlc2NyaXB0aW9uLmRldGFpbHMudHlwZSA9IHR5cGU7XG4gICAgfSBlbHNlIGlmIChzbG90LnR5cGUgPT09ICdkeW5hbWljRW51bScgJiYgc2xvdC5yZWdpc3RlckVudW0pIHtcbiAgICAgICAgZGVjbGFyZUVudW0oc2xvdC5yZWdpc3RlckVudW0udHlwZSwge30pO1xuICAgICAgICBwaW5EYXRhLnZhbHVlID0gJyc7XG4gICAgICAgIHBpbkRlc2NyaXB0aW9uLmRldGFpbHMudHlwZSA9IHNsb3QucmVnaXN0ZXJFbnVtLnR5cGU7XG4gICAgICAgIHBpbkRlc2NyaXB0aW9uLmRldGFpbHMuZGVmYXVsdFZhbHVlID0gc2xvdC5kZWZhdWx0O1xuICAgIH1cblxuICAgIGlmICgncmVnaXN0ZXJFbnVtVHlwZScgaW4gc2xvdCkge1xuICAgICAgICBwaW5EZXNjcmlwdGlvbi5kZXRhaWxzLnJlZ2lzdGVyRW51bVR5cGUgPSBzbG90LnJlZ2lzdGVyRW51bVR5cGU7XG4gICAgfVxuXG4gICAgLy8g55So5LqO5Yik5pat6L+e57q/XG4gICAgaWYgKCdjb25uZWN0VHlwZScgaW4gc2xvdCkge1xuICAgICAgICBwaW5EZXNjcmlwdGlvbi5kZXRhaWxzLmNvbm5lY3RUeXBlID0gc2xvdC5jb25uZWN0VHlwZTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgICB0YWc6IHRhZyxcbiAgICAgICAgZGF0YTogcGluRGF0YSxcbiAgICAgICAgZGVzY3JpcHRpb246IHBpbkRlc2NyaXB0aW9uLFxuICAgIH07XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUJsb2NrQnlOb2RlRGVmaW5lKG5vZGVEZWZpbmU6IE5vZGVEZWZpbmUpIHtcbiAgICBjb25zdCBkZXNjcmlwdGlvbjogSUJsb2NrRGVzY3JpcHRpb24gPSB7XG4gICAgICAgIHR5cGU6IG5vZGVEZWZpbmUudHlwZSxcbiAgICAgICAgdGl0bGU6IG5vZGVEZWZpbmUuZGV0YWlscz8udGl0bGUgfHwgJycsXG4gICAgICAgIGlucHV0UGluczogW10sXG4gICAgICAgIG91dHB1dFBpbnM6IFtdLFxuICAgICAgICBzdHlsZToge1xuICAgICAgICAgICAgaGVhZGVyQ29sb3I6ICcjMjI3RjlCODAnLFxuICAgICAgICB9LFxuICAgIH07XG5cbiAgICBpZiAobm9kZURlZmluZS5kZXRhaWxzPy5zdHlsZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIC8vIOWQiOW5tiBzdHlsZe+8jOW3siBkdW1wIOeahCBzdHlsZSDkuLrkuLtcbiAgICAgICAgZGVzY3JpcHRpb24uc3R5bGUgPSB7IC4uLmRlc2NyaXB0aW9uLnN0eWxlLCAuLi5ub2RlRGVmaW5lLmRldGFpbHM/LnN0eWxlIH07XG4gICAgfVxuXG4gICAgY29uc3QgYmxvY2tEYXRhOiBCbG9ja0RhdGEgPSB7XG4gICAgICAgIHR5cGU6IG5vZGVEZWZpbmUudHlwZSxcbiAgICAgICAgcG9zaXRpb246IHsgeDogMCwgeTogMCB9LFxuICAgICAgICBkZXRhaWxzOiB7XG4gICAgICAgICAgICBpbnB1dFBpbnM6IFtdLFxuICAgICAgICAgICAgb3V0cHV0UGluczogW10sXG4gICAgICAgIH0sXG4gICAgfTtcbiAgICByZXR1cm4ge1xuICAgICAgICBpc01hc3Rlcjogbm9kZURlZmluZS5kZXRhaWxzPy5tYXN0ZXIsXG4gICAgICAgIGRldGFpbHM6IG5vZGVEZWZpbmUuZGV0YWlscyxcbiAgICAgICAgdHlwZTogYmxvY2tEYXRhLnR5cGUsXG4gICAgICAgIGRhdGE6IGJsb2NrRGF0YSxcbiAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLFxuICAgIH07XG59XG5cbi8qKlxuICog5rOo5YaM5Yiw5Yqo5oCB5p6a5Li+5Lit77yM5aaC5p6cIHZhbHVlIOmHjeWkjeWwsemAkuWiniAxXG4gKiDkvovlpoIgdGVzdCB0ZXN0XzFcbiAqIEBwYXJhbSBwaW5EYXRhXG4gKiBAcGFyYW0gcGluRGVzY1xuICovXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJEeW5hbWljRW51bShwaW5EYXRhOiBQaW5EYXRhLCBwaW5EZXNjOiBJUGluRGVzY3JpcHRpb24pIHtcbiAgICBsZXQgdmFsdWUgPSBwaW5EYXRhLnZhbHVlO1xuICAgIGxldCBpbmRleCA9IDE7XG4gICAgbGV0IGRvbmUgPSBmYWxzZTtcbiAgICB3aGlsZSAoIWRvbmUpIHtcbiAgICAgICAgZG9uZSA9IGRlY2xhcmVEeW5hbWljRW51bVRvVHlwZSh7XG4gICAgICAgICAgICB0eXBlOiBwaW5EZXNjLmRldGFpbHMucmVnaXN0ZXJFbnVtVHlwZSxcbiAgICAgICAgICAgIG5hbWU6IHZhbHVlLFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFkb25lKSB7XG4gICAgICAgICAgICB2YWx1ZSA9IHBpbkRhdGEudmFsdWUgKyBgXyR7aW5kZXh9YDtcbiAgICAgICAgICAgIGluZGV4Kys7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHZhbHVlO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVEeW5hbWljSW5wdXRQaW5zKGJsb2NrRGVzYzogSUJsb2NrRGVzY3JpcHRpb24sIGRldGFpbHM6IHtcbiAgICBpbnB1dFBpbnM6IFBpbkRhdGFbXTtcbiAgICBpbnB1dFBpbkRlc2NyaXB0aW9ucz86IElQaW5EZXNjcmlwdGlvbltdO1xuICAgIFtrZXk6IHN0cmluZ106IGFueVxufSk6IElQaW5EZXNjcmlwdGlvbltdIHtcbiAgICBpZiAoZGV0YWlscy5pbnB1dFBpbkRlc2NyaXB0aW9ucykge1xuICAgICAgICByZXR1cm4gZGV0YWlscy5pbnB1dFBpbkRlc2NyaXB0aW9ucy5tYXAoKGRlc2M6IElQaW5EZXNjcmlwdGlvbiwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgICAgY29uc3QgcGluRGF0YSA9IGRldGFpbHMuaW5wdXRQaW5zW2luZGV4XTtcbiAgICAgICAgICAgIGlmIChkZXNjLmRldGFpbHMucmVnaXN0ZXJFbnVtVHlwZSkge1xuICAgICAgICAgICAgICAgIHBpbkRhdGEuZGV0YWlscy5yZWdpc3RlckVudW1UeXBlID0gZGVzYy5kZXRhaWxzLnJlZ2lzdGVyRW51bVR5cGU7XG4gICAgICAgICAgICAgICAgcGluRGF0YS52YWx1ZSA9IHJlZ2lzdGVyRHluYW1pY0VudW0ocGluRGF0YSwgZGVzYyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZGVzYztcbiAgICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGJsb2NrRGVzYy5pbnB1dFBpbnMubWFwKChkZXNjOiBJUGluRGVzY3JpcHRpb24sIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG5ld0Rlc2MgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGRlc2MpKTtcbiAgICAgICAgICAgIGNvbnN0IHBpbkRhdGEgPSBkZXRhaWxzLmlucHV0UGluc1tpbmRleF07XG4gICAgICAgICAgICBpZiAocGluRGF0YSkge1xuICAgICAgICAgICAgICAgIGlmIChuZXdEZXNjLmRhdGFUeXBlID09PSAnYW55Jykge1xuICAgICAgICAgICAgICAgICAgICBuZXdEZXNjLmRhdGFUeXBlID0gcGluRGF0YS5kYXRhVHlwZTtcbiAgICAgICAgICAgICAgICAgICAgbmV3RGVzYy52YWx1ZSA9IHBpbkRhdGEudmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkZXNjLmRldGFpbHMucmVnaXN0ZXJFbnVtVHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBwaW5EYXRhLmRldGFpbHMucmVnaXN0ZXJFbnVtVHlwZSA9IGRlc2MuZGV0YWlscy5yZWdpc3RlckVudW1UeXBlO1xuICAgICAgICAgICAgICAgICAgICBwaW5EYXRhLnZhbHVlID0gcmVnaXN0ZXJEeW5hbWljRW51bShwaW5EYXRhLCBkZXNjKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbmV3RGVzYztcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVEeW5hbWljT3V0cHV0UGlucyhibG9ja0Rlc2M6IElCbG9ja0Rlc2NyaXB0aW9uLCBkZXRhaWxzOiB7XG4gICAgb3V0cHV0UGluczogUGluRGF0YVtdO1xuICAgIG91dHB1dFBpbkRlc2NyaXB0aW9uczogSVBpbkRlc2NyaXB0aW9uW107XG4gICAgW2tleTogc3RyaW5nXTogYW55O1xufSk6IElQaW5EZXNjcmlwdGlvbltdIHtcbiAgICBpZiAoZGV0YWlscy5vdXRwdXRQaW5EZXNjcmlwdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIGRldGFpbHMub3V0cHV0UGluRGVzY3JpcHRpb25zO1xuICAgIH1cbiAgICByZXR1cm4gYmxvY2tEZXNjLm91dHB1dFBpbnMubWFwKChkZXNjOiBJUGluRGVzY3JpcHRpb24sIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgY29uc3QgbmV3RGVzYyA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZGVzYykpO1xuICAgICAgICBjb25zdCBwaW5EYXRhID0gZGV0YWlscy5vdXRwdXRQaW5zW2luZGV4XTtcbiAgICAgICAgaWYgKHBpbkRhdGEgJiYgbmV3RGVzYy5kYXRhVHlwZSA9PT0gJ2FueScpIHtcbiAgICAgICAgICAgIG5ld0Rlc2MuZGF0YVR5cGUgPSBwaW5EYXRhLmRhdGFUeXBlO1xuICAgICAgICAgICAgbmV3RGVzYy52YWx1ZSA9IHBpbkRhdGEudmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ld0Rlc2M7XG4gICAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZWNsYXJlU2hhZGVyTm9kZUJsb2NrKHNoYWRlck5vZGVNYXA6IE1hcDxzdHJpbmcsIE5vZGVEZWZpbmU+KSB7XG4gICAgLy8g5riF56m657yT5a2YXG4gICAgbm9ybWFsQmxvY2tDYWNoZU1hcC5jbGVhcigpO1xuICAgIHBpbk1hcC5jbGVhcigpO1xuICAgIGZvciAoY29uc3QgW2Jsb2NrVHlwZSwgaXRlbV0gb2Ygc2hhZGVyTm9kZU1hcCkge1xuICAgICAgICBjb25zdCBpbnB1dFBpbnM6IFBpbkRhdGFbXSA9IFtdO1xuICAgICAgICBjb25zdCBpbnB1dFBpbkRlc2NyaXB0aW9uczogSVBpbkRlc2NyaXB0aW9uW10gPSBbXTtcbiAgICAgICAgaXRlbS5ub2RlLmlucHV0cz8uZm9yRWFjaCgoc2xvdDogU2xvdERlZmluZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcGluID0gY3JlYXRlUGluKGJsb2NrVHlwZSwgJ2lucHV0Jywgc2xvdCk7XG4gICAgICAgICAgICBpbnB1dFBpbnMucHVzaChwaW4uZGF0YSk7XG4gICAgICAgICAgICBpbnB1dFBpbkRlc2NyaXB0aW9ucy5wdXNoKHBpbi5kZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICAgIHBpbk1hcC5zZXQocGluLnRhZywgcGluKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXRlbS5ub2RlLnByb3BzPy5mb3JFYWNoKChzbG90OiBTbG90RGVmaW5lKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwaW4gPSBjcmVhdGVQaW4oYmxvY2tUeXBlLCAncHJvcCcsIHNsb3QpO1xuXG4gICAgICAgICAgICBpbnB1dFBpbnMucHVzaChwaW4uZGF0YSk7XG4gICAgICAgICAgICBpbnB1dFBpbkRlc2NyaXB0aW9ucy5wdXNoKHBpbi5kZXNjcmlwdGlvbik7XG5cbiAgICAgICAgICAgIHBpbk1hcC5zZXQocGluLnRhZywgcGluKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgb3V0cHV0UGluczogUGluRGF0YVtdID0gW107XG4gICAgICAgIGNvbnN0IG91dHB1dFBpbkRlc2NyaXB0aW9uczogSVBpbkRlc2NyaXB0aW9uW10gPSBbXTtcbiAgICAgICAgaXRlbS5ub2RlLm91dHB1dHM/LmZvckVhY2goKHNsb3Q6IFNsb3REZWZpbmUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBpbiA9IGNyZWF0ZVBpbihibG9ja1R5cGUsICdvdXQnLCBzbG90KTtcbiAgICAgICAgICAgIG91dHB1dFBpbnMucHVzaChwaW4uZGF0YSk7XG4gICAgICAgICAgICBvdXRwdXRQaW5EZXNjcmlwdGlvbnMucHVzaChwaW4uZGVzY3JpcHRpb24pO1xuXG4gICAgICAgICAgICBwaW5NYXAuc2V0KHBpbi50YWcsIHBpbik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGJsb2NrID0gY3JlYXRlQmxvY2tCeU5vZGVEZWZpbmUoaXRlbSk7XG4gICAgICAgIGJsb2NrLmRhdGEuZGV0YWlscy5pbnB1dFBpbnMgPSBpbnB1dFBpbnM7XG4gICAgICAgIGJsb2NrLmRhdGEuZGV0YWlscy5vdXRwdXRQaW5zID0gb3V0cHV0UGlucztcbiAgICAgICAgYmxvY2suZGVzY3JpcHRpb24uaW5wdXRQaW5zID0gaW5wdXRQaW5EZXNjcmlwdGlvbnM7XG4gICAgICAgIGJsb2NrLmRlc2NyaXB0aW9uLm91dHB1dFBpbnMgPSBvdXRwdXRQaW5EZXNjcmlwdGlvbnM7XG4gICAgICAgIGJsb2NrLmRlc2NyaXB0aW9uLmNyZWF0ZUR5bmFtaWNJbnB1dFBpbnMgPSBjcmVhdGVEeW5hbWljSW5wdXRQaW5zO1xuICAgICAgICBibG9jay5kZXNjcmlwdGlvbi5jcmVhdGVEeW5hbWljT3V0cHV0UGlucyA9IGNyZWF0ZUR5bmFtaWNPdXRwdXRQaW5zO1xuICAgICAgICBub3JtYWxCbG9ja0NhY2hlTWFwLnNldChibG9jay50eXBlLCBibG9jayk7XG4gICAgICAgIC8vIOazqOWGjFxuICAgICAgICBkZWNsYXJlQmxvY2soYmxvY2suZGVzY3JpcHRpb24pO1xuICAgIH1cbn1cbiJdfQ==