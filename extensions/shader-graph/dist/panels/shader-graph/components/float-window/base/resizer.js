"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.adjustWindowPosition = exports.useResizer = void 0;
const const_1 = require("./const");
const RESIZER_TAG = [
    'top',
    'left',
    'right',
    'bottom',
    'top-left',
    'top-right',
    'bottom-left',
    'bottom-right',
];
const hasResizerEvent = false;
/**
 * 添加缩放器
 * @param options
 */
function useResizer(options) {
    const { $window, config } = options;
    if (!config.events.resizer) {
        RESIZER_TAG.forEach((tag) => {
            const element = $window.querySelector(tag);
            if (element) {
                element.remove();
            }
        });
        return;
    }
    // 检查是否注册过，如果注册过就跳过
    for (const tag of RESIZER_TAG) {
        if ($window.querySelector(tag)) {
            return;
        }
    }
    const minSize = (0, const_1.getMinSize)();
    RESIZER_TAG.forEach((tag) => {
        const element = document.createElement('div');
        element.setAttribute('id', tag);
        element.setAttribute('class', tag);
        element.addEventListener('mousedown', onDragStartFrameEvent, false);
        $window.appendChild(element);
    });
    const parentElement = $window.parentElement;
    let aspectRatio = 1;
    function onDragStartFrameEvent(event) {
        const windowRect = {
            left: $window.offsetLeft,
            top: $window.offsetTop,
            width: $window.offsetWidth,
            height: $window.offsetHeight,
        };
        // 鼠标点击时候的坐标
        const mouseDown = {
            x: event.clientX,
            y: event.clientY,
        };
        const dragTarget = event.target;
        aspectRatio = windowRect.width / windowRect.height;
        let lastLeft = -1;
        let lastTop = -1;
        let lastWidth = -1;
        let lastHeight = -1;
        let newLeft = -1;
        let newWidth = -1;
        let newTop = -1;
        let newHeight = -1;
        const minX = 0;
        const minY = 0;
        const maxX = parentElement.offsetWidth + parentElement.offsetLeft - windowRect.width;
        const maxY = parentElement.offsetHeight - parentElement.offsetTop - windowRect.height;
        function moveTop(deltaY) {
            newTop = windowRect.top - deltaY;
            newHeight = windowRect.height + deltaY;
            newHeight = Math.max(newHeight, minSize.height);
            newHeight = Math.min(newHeight, windowRect.top + windowRect.height);
            newTop = Math.min(newTop, windowRect.top + windowRect.height - minSize.height);
            newTop = Math.max(newTop, minX);
            if (newHeight <= minSize.width) {
                newTop = lastTop;
                newHeight = lastHeight;
            }
            lastTop = newTop;
            lastHeight = newHeight;
        }
        const parentElementOffsetHeight = parentElement.offsetHeight;
        function moveBottom(deltaY) {
            newHeight = windowRect.height - deltaY;
            newHeight = Math.max(minSize.height, newHeight);
            const offsetTop = parentElement.offsetTop;
            newHeight = Math.min(newHeight, Math.abs(parentElementOffsetHeight - offsetTop - windowRect.top));
        }
        function moveLeft(deltaX) {
            newLeft = windowRect.left - deltaX;
            newWidth = windowRect.width + deltaX;
            newWidth = Math.max(newWidth, minSize.width);
            newWidth = Math.min(newWidth, windowRect.left + windowRect.width);
            newLeft = Math.min(newLeft, windowRect.left + windowRect.width - minSize.width);
            newLeft = Math.max(newLeft, 0);
            if (newWidth <= minSize.width) {
                newLeft = lastLeft;
                newWidth = lastWidth;
            }
            lastLeft = newLeft;
            lastWidth = newWidth;
        }
        function moveRight(deltaX) {
            newWidth = windowRect.width - deltaX;
            newWidth = Math.max(minSize.width, newWidth);
            newWidth = Math.min(newWidth, Math.abs(windowRect.left - (parentElement.offsetLeft + parentElement.offsetWidth)));
        }
        function drag(event) {
            const deltaX = (mouseDown.x - event.clientX);
            const deltaY = (mouseDown.y - event.clientY);
            switch (dragTarget.id) {
                case 'top-left':
                    moveTop(deltaY);
                    moveLeft(deltaX);
                    break;
                case 'top-right':
                    moveTop(deltaY);
                    moveRight(deltaX);
                    break;
                case 'bottom-left':
                    moveBottom(deltaY);
                    moveLeft(deltaX);
                    break;
                case 'bottom-right':
                    moveBottom(deltaY);
                    moveRight(deltaX);
                    break;
                case 'top':
                    moveTop(deltaY);
                    break;
                case 'bottom':
                    moveBottom(deltaY);
                    break;
                case 'left':
                    moveLeft(deltaX);
                    break;
                case 'right':
                    moveRight(deltaX);
                    break;
            }
            if (config.events.enableAspectRatio) {
                if (newHeight !== -1) {
                    newWidth = newHeight * aspectRatio;
                }
                if (newWidth !== -1) {
                    newHeight = newWidth; //newWidth / aspectRatio;
                }
            }
            if (newWidth !== -1) {
                const minWidth = parseFloat(config.base.minWidth);
                newWidth = newWidth <= minWidth ? minWidth : newWidth;
            }
            if (newHeight !== -1) {
                const minHeight = parseFloat(config.base.minHeight);
                newHeight = newHeight <= minHeight ? minHeight : newHeight;
            }
            if (newTop !== -1)
                $window.style.top = `${newTop}px`;
            if (newHeight !== -1)
                $window.style.height = `${newHeight}px`;
            if (newLeft !== -1)
                $window.style.left = `${newLeft}px`;
            if (newWidth !== -1)
                $window.style.width = `${newWidth}px`;
            if (newTop !== -1 || newHeight !== -1 || newLeft !== -1 || newWidth !== -1) {
                options.onChange && options.onChange($window.style);
            }
        }
        function dragEnd() {
            document.removeEventListener('mousemove', drag, true);
            document.removeEventListener('mouseup', dragEnd, true);
        }
        document.addEventListener('mousemove', drag, true);
        document.addEventListener('mouseup', dragEnd, true);
    }
}
exports.useResizer = useResizer;
/**
 * 窗口 resize 时，重新矫正坐标，保证在画板内
 */
function adjustWindowPosition($window, limitedAreaElement) {
    const limitedAreaSection = limitedAreaElement.shadowRoot.querySelector('section');
    const limitedAreaSectionRect = {
        left: limitedAreaSection.clientLeft,
        right: limitedAreaSection.clientLeft + limitedAreaSection.clientWidth,
        top: limitedAreaSection.clientTop,
        bottom: limitedAreaSection.clientTop + limitedAreaSection.clientHeight,
    };
    const left = parseFloat($window.style.left) || undefined;
    if (left !== undefined && (left < limitedAreaSectionRect.left ||
        left > (limitedAreaSectionRect.right - $window.offsetWidth))) {
        const newLeft = Math.min(Math.max(left, limitedAreaSectionRect.left), limitedAreaSectionRect.right - $window.offsetWidth);
        $window.style.left = newLeft + 'px';
    }
    const top = parseFloat($window.style.top) || undefined;
    if (top !== undefined && (top < limitedAreaSectionRect.top ||
        top > limitedAreaSectionRect.bottom - $window.offsetHeight)) {
        // 校正位置，确保窗口在父节点区域内
        let newTop = Math.min(Math.max(top, limitedAreaSectionRect.top), limitedAreaSectionRect.bottom - $window.offsetHeight);
        const minTop = limitedAreaElement.shadowRoot.querySelector('header').offsetHeight;
        newTop = Math.max(minTop, newTop);
        $window.style.top = newTop + 'px';
    }
}
exports.adjustWindowPosition = adjustWindowPosition;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzaXplci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3NyYy9wYW5lbHMvc2hhZGVyLWdyYXBoL2NvbXBvbmVudHMvZmxvYXQtd2luZG93L2Jhc2UvcmVzaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBcUM7QUFHckMsTUFBTSxXQUFXLEdBQUc7SUFDaEIsS0FBSztJQUNMLE1BQU07SUFDTixPQUFPO0lBQ1AsUUFBUTtJQUNSLFVBQVU7SUFDVixXQUFXO0lBQ1gsYUFBYTtJQUNiLGNBQWM7Q0FDakIsQ0FBQztBQVdGLE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQztBQUU5Qjs7O0dBR0c7QUFDSCxTQUFnQixVQUFVLENBQUMsT0FBd0I7SUFDL0MsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFDcEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO1FBQ3hCLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRTtZQUNoQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzNDLElBQUksT0FBTyxFQUFFO2dCQUNULE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUNwQjtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTztLQUNWO0lBRUQsbUJBQW1CO0lBQ25CLEtBQUssTUFBTSxHQUFHLElBQUksV0FBVyxFQUFFO1FBQzNCLElBQUksT0FBTyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUM1QixPQUFPO1NBQ1Y7S0FDSjtJQUVELE1BQU0sT0FBTyxHQUFHLElBQUEsa0JBQVUsR0FBRSxDQUFDO0lBQzdCLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFXLEVBQUUsRUFBRTtRQUNoQyxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFD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QUNuQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLHNCQUFzQixDQUFDLEdBQUcsQ0FBQyxFQUFFLHNCQUFzQixDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDeEgsTUFBTSxNQUFNLEdBQUcsa0JBQWtCLENBQUMsVUFBVyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUUsQ0FBQyxZQUFZLENBQUM7UUFDcEYsTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ2xDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLE1BQU0sR0FBRyxJQUFJLENBQUM7S0FDckM7QUFDTCxDQUFDO0FBNUJELG9EQTRCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldE1pblNpemUgfSBmcm9tICcuL2NvbnN0JztcbmltcG9ydCB7IEZsb2F0V2luZG93Q29uZmlnIH0gZnJvbSAnLi4vaW50ZXJuYWwnO1xuXG5jb25zdCBSRVNJWkVSX1RBRyA9IFtcbiAgICAndG9wJyxcbiAgICAnbGVmdCcsXG4gICAgJ3JpZ2h0JyxcbiAgICAnYm90dG9tJyxcbiAgICAndG9wLWxlZnQnLFxuICAgICd0b3AtcmlnaHQnLFxuICAgICdib3R0b20tbGVmdCcsXG4gICAgJ2JvdHRvbS1yaWdodCcsXG5dO1xuXG5leHBvcnQgaW50ZXJmYWNlIElSZXNpemVyT3B0aW9ucyB7XG4gICAgLy8g5b2T5YmN56qX5Y+jXG4gICAgJHdpbmRvdzogSFRNTERpdkVsZW1lbnQ7XG4gICAgLy8g6YWN572uXG4gICAgY29uZmlnOiBGbG9hdFdpbmRvd0NvbmZpZztcbiAgICAvLyDmlbDmja7lj5jljJbmmK/op6blj5HnmoTkuovku7ZcbiAgICBvbkNoYW5nZT86IChzdHlsZTogQ1NTU3R5bGVEZWNsYXJhdGlvbikgPT4gdm9pZDtcbn1cblxuY29uc3QgaGFzUmVzaXplckV2ZW50ID0gZmFsc2U7XG5cbi8qKlxuICog5re75Yqg57yp5pS+5ZmoXG4gKiBAcGFyYW0gb3B0aW9uc1xuICovXG5leHBvcnQgZnVuY3Rpb24gdXNlUmVzaXplcihvcHRpb25zOiBJUmVzaXplck9wdGlvbnMpIHtcbiAgICBjb25zdCB7ICR3aW5kb3csIGNvbmZpZyB9ID0gb3B0aW9ucztcbiAgICBpZiAoIWNvbmZpZy5ldmVudHMucmVzaXplcikge1xuICAgICAgICBSRVNJWkVSX1RBRy5mb3JFYWNoKCh0YWc6IHN0cmluZykgPT4ge1xuICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9ICR3aW5kb3cucXVlcnlTZWxlY3Rvcih0YWcpO1xuICAgICAgICAgICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICBlbGVtZW50LnJlbW92ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIOajgOafpeaYr+WQpuazqOWGjOi/h++8jOWmguaenOazqOWGjOi/h+Wwsei3s+i/h1xuICAgIGZvciAoY29uc3QgdGFnIG9mIFJFU0laRVJfVEFHKSB7XG4gICAgICAgIGlmICgkd2luZG93LnF1ZXJ5U2VsZWN0b3IodGFnKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbWluU2l6ZSA9IGdldE1pblNpemUoKTtcbiAgICBSRVNJWkVSX1RBRy5mb3JFYWNoKCh0YWc6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdpZCcsIHRhZyk7XG4gICAgICAgIGVsZW1lbnQuc2V0QXR0cmlidXRlKCdjbGFzcycsIHRhZyk7XG4gICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgb25EcmFnU3RhcnRGcmFtZUV2ZW50LCBmYWxzZSk7XG4gICAgICAgICR3aW5kb3cuYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBwYXJlbnRFbGVtZW50ID0gJHdpbmRvdy5wYXJlbnRFbGVtZW50ITtcblxuICAgIGxldCBhc3BlY3RSYXRpbyA9IDE7XG4gICAgZnVuY3Rpb24gb25EcmFnU3RhcnRGcmFtZUV2ZW50KGV2ZW50OiBNb3VzZUV2ZW50KSB7XG5cbiAgICAgICAgY29uc3Qgd2luZG93UmVjdCA9IHtcbiAgICAgICAgICAgIGxlZnQ6ICR3aW5kb3cub2Zmc2V0TGVmdCxcbiAgICAgICAgICAgIHRvcDogJHdpbmRvdy5vZmZzZXRUb3AsXG4gICAgICAgICAgICB3aWR0aDogJHdpbmRvdy5vZmZzZXRXaWR0aCxcbiAgICAgICAgICAgIGhlaWdodDogJHdpbmRvdy5vZmZzZXRIZWlnaHQsXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8g6byg5qCH54K55Ye75pe25YCZ55qE5Z2Q5qCHXG4gICAgICAgIGNvbnN0IG1vdXNlRG93biA9IHtcbiAgICAgICAgICAgIHg6IGV2ZW50LmNsaWVudFgsXG4gICAgICAgICAgICB5OiBldmVudC5jbGllbnRZLFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IGRyYWdUYXJnZXQgPSBldmVudC50YXJnZXQgYXMgSFRNTEVsZW1lbnQ7XG5cbiAgICAgICAgYXNwZWN0UmF0aW8gPSB3aW5kb3dSZWN0LndpZHRoIC8gd2luZG93UmVjdC5oZWlnaHQ7XG5cbiAgICAgICAgbGV0IGxhc3RMZWZ0ID0gLTE7XG4gICAgICAgIGxldCBsYXN0VG9wID0gLTE7XG4gICAgICAgIGxldCBsYXN0V2lkdGggPSAtMTtcbiAgICAgICAgbGV0IGxhc3RIZWlnaHQgPSAtMTtcbiAgICAgICAgbGV0IG5ld0xlZnQgPSAtMTtcbiAgICAgICAgbGV0IG5ld1dpZHRoID0gLTE7XG4gICAgICAgIGxldCBuZXdUb3AgPSAtMTtcbiAgICAgICAgbGV0IG5ld0hlaWdodCA9IC0xO1xuXG4gICAgICAgIGNvbnN0IG1pblggPSAwO1xuICAgICAgICBjb25zdCBtaW5ZID0gMDtcbiAgICAgICAgY29uc3QgbWF4WCA9IHBhcmVudEVsZW1lbnQub2Zmc2V0V2lkdGggKyBwYXJlbnRFbGVtZW50Lm9mZnNldExlZnQgLSB3aW5kb3dSZWN0LndpZHRoO1xuICAgICAgICBjb25zdCBtYXhZID0gcGFyZW50RWxlbWVudC5vZmZzZXRIZWlnaHQgLSBwYXJlbnRFbGVtZW50Lm9mZnNldFRvcCAtIHdpbmRvd1JlY3QuaGVpZ2h0O1xuXG4gICAgICAgIGZ1bmN0aW9uIG1vdmVUb3AoZGVsdGFZOiBudW1iZXIpIHtcbiAgICAgICAgICAgIG5ld1RvcCA9IHdpbmRvd1JlY3QudG9wIC0gZGVsdGFZO1xuICAgICAgICAgICAgbmV3SGVpZ2h0ID0gd2luZG93UmVjdC5oZWlnaHQgKyBkZWx0YVk7XG5cbiAgICAgICAgICAgIG5ld0hlaWdodCA9IE1hdGgubWF4KG5ld0hlaWdodCwgbWluU2l6ZS5oZWlnaHQpO1xuICAgICAgICAgICAgbmV3SGVpZ2h0ID0gTWF0aC5taW4obmV3SGVpZ2h0LCB3aW5kb3dSZWN0LnRvcCArIHdpbmRvd1JlY3QuaGVpZ2h0KTtcblxuICAgICAgICAgICAgbmV3VG9wID0gTWF0aC5taW4obmV3VG9wLCB3aW5kb3dSZWN0LnRvcCArIHdpbmRvd1JlY3QuaGVpZ2h0IC0gbWluU2l6ZS5oZWlnaHQpO1xuICAgICAgICAgICAgbmV3VG9wID0gTWF0aC5tYXgobmV3VG9wLCBtaW5YKTtcblxuICAgICAgICAgICAgaWYgKG5ld0hlaWdodCA8PSBtaW5TaXplLndpZHRoKSB7XG4gICAgICAgICAgICAgICAgbmV3VG9wID0gbGFzdFRvcDtcbiAgICAgICAgICAgICAgICBuZXdIZWlnaHQgPSBsYXN0SGVpZ2h0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGFzdFRvcCA9IG5ld1RvcDtcbiAgICAgICAgICAgIGxhc3RIZWlnaHQgPSBuZXdIZWlnaHQ7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXJlbnRFbGVtZW50T2Zmc2V0SGVpZ2h0ID0gcGFyZW50RWxlbWVudC5vZmZzZXRIZWlnaHQ7XG5cbiAgICAgICAgZnVuY3Rpb24gbW92ZUJvdHRvbShkZWx0YVk6IG51bWJlcikge1xuICAgICAgICAgICAgbmV3SGVpZ2h0ID0gd2luZG93UmVjdC5oZWlnaHQgLSBkZWx0YVk7XG4gICAgICAgICAgICBuZXdIZWlnaHQgPSBNYXRoLm1heChtaW5TaXplLmhlaWdodCwgbmV3SGVpZ2h0KTtcbiAgICAgICAgICAgIGNvbnN0IG9mZnNldFRvcCA9IHBhcmVudEVsZW1lbnQub2Zmc2V0VG9wO1xuICAgICAgICAgICAgbmV3SGVpZ2h0ID0gTWF0aC5taW4obmV3SGVpZ2h0LCBNYXRoLmFicyhwYXJlbnRFbGVtZW50T2Zmc2V0SGVpZ2h0IC0gb2Zmc2V0VG9wIC0gd2luZG93UmVjdC50b3ApKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIG1vdmVMZWZ0KGRlbHRhWDogbnVtYmVyKSB7XG4gICAgICAgICAgICBuZXdMZWZ0ID0gd2luZG93UmVjdC5sZWZ0IC0gZGVsdGFYO1xuICAgICAgICAgICAgbmV3V2lkdGggPSB3aW5kb3dSZWN0LndpZHRoICsgZGVsdGFYO1xuXG4gICAgICAgICAgICBuZXdXaWR0aCA9IE1hdGgubWF4KG5ld1dpZHRoLCBtaW5TaXplLndpZHRoKTtcbiAgICAgICAgICAgIG5ld1dpZHRoID0gTWF0aC5taW4obmV3V2lkdGgsIHdpbmRvd1JlY3QubGVmdCArIHdpbmRvd1JlY3Qud2lkdGgpO1xuXG4gICAgICAgICAgICBuZXdMZWZ0ID0gTWF0aC5taW4obmV3TGVmdCwgd2luZG93UmVjdC5sZWZ0ICsgd2luZG93UmVjdC53aWR0aCAtIG1pblNpemUud2lkdGgpO1xuICAgICAgICAgICAgbmV3TGVmdCA9IE1hdGgubWF4KG5ld0xlZnQsIDApO1xuICAgICAgICAgICAgaWYgKG5ld1dpZHRoIDw9IG1pblNpemUud2lkdGgpIHtcbiAgICAgICAgICAgICAgICBuZXdMZWZ0ID0gbGFzdExlZnQ7XG4gICAgICAgICAgICAgICAgbmV3V2lkdGggPSBsYXN0V2lkdGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsYXN0TGVmdCA9IG5ld0xlZnQ7XG4gICAgICAgICAgICBsYXN0V2lkdGggPSBuZXdXaWR0aDtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIG1vdmVSaWdodChkZWx0YVg6IG51bWJlcikge1xuICAgICAgICAgICAgbmV3V2lkdGggPSB3aW5kb3dSZWN0LndpZHRoIC0gZGVsdGFYO1xuICAgICAgICAgICAgbmV3V2lkdGggPSBNYXRoLm1heChtaW5TaXplLndpZHRoLCBuZXdXaWR0aCk7XG4gICAgICAgICAgICBuZXdXaWR0aCA9IE1hdGgubWluKG5ld1dpZHRoLCBNYXRoLmFicyh3aW5kb3dSZWN0LmxlZnQgLSAocGFyZW50RWxlbWVudC5vZmZzZXRMZWZ0ICsgcGFyZW50RWxlbWVudC5vZmZzZXRXaWR0aCkpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGRyYWcoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcbiAgICAgICAgICAgIGNvbnN0IGRlbHRhWCA9IChtb3VzZURvd24ueCAtIGV2ZW50LmNsaWVudFgpO1xuICAgICAgICAgICAgY29uc3QgZGVsdGFZID0gKG1vdXNlRG93bi55IC0gZXZlbnQuY2xpZW50WSk7XG5cbiAgICAgICAgICAgIHN3aXRjaCAoZHJhZ1RhcmdldC5pZCkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ3RvcC1sZWZ0JzpcbiAgICAgICAgICAgICAgICAgICAgbW92ZVRvcChkZWx0YVkpO1xuICAgICAgICAgICAgICAgICAgICBtb3ZlTGVmdChkZWx0YVgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICd0b3AtcmlnaHQnOlxuICAgICAgICAgICAgICAgICAgICBtb3ZlVG9wKGRlbHRhWSk7XG4gICAgICAgICAgICAgICAgICAgIG1vdmVSaWdodChkZWx0YVgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdib3R0b20tbGVmdCc6XG4gICAgICAgICAgICAgICAgICAgIG1vdmVCb3R0b20oZGVsdGFZKTtcbiAgICAgICAgICAgICAgICAgICAgbW92ZUxlZnQoZGVsdGFYKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnYm90dG9tLXJpZ2h0JzpcbiAgICAgICAgICAgICAgICAgICAgbW92ZUJvdHRvbShkZWx0YVkpO1xuICAgICAgICAgICAgICAgICAgICBtb3ZlUmlnaHQoZGVsdGFYKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAndG9wJzpcbiAgICAgICAgICAgICAgICAgICAgbW92ZVRvcChkZWx0YVkpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdib3R0b20nOlxuICAgICAgICAgICAgICAgICAgICBtb3ZlQm90dG9tKGRlbHRhWSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2xlZnQnOlxuICAgICAgICAgICAgICAgICAgICBtb3ZlTGVmdChkZWx0YVgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdyaWdodCc6XG4gICAgICAgICAgICAgICAgICAgIG1vdmVSaWdodChkZWx0YVgpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbmZpZy5ldmVudHMuZW5hYmxlQXNwZWN0UmF0aW8pIHtcblxuICAgICAgICAgICAgICAgIGlmIChuZXdIZWlnaHQgIT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld1dpZHRoID0gbmV3SGVpZ2h0ICogYXNwZWN0UmF0aW87XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChuZXdXaWR0aCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3SGVpZ2h0ID0gbmV3V2lkdGg7IC8vbmV3V2lkdGggLyBhc3BlY3RSYXRpbztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChuZXdXaWR0aCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtaW5XaWR0aCA9IHBhcnNlRmxvYXQoY29uZmlnLmJhc2UubWluV2lkdGgpO1xuICAgICAgICAgICAgICAgIG5ld1dpZHRoID0gbmV3V2lkdGggPD0gbWluV2lkdGggPyBtaW5XaWR0aCA6IG5ld1dpZHRoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG5ld0hlaWdodCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtaW5IZWlnaHQgPSBwYXJzZUZsb2F0KGNvbmZpZy5iYXNlLm1pbkhlaWdodCk7XG4gICAgICAgICAgICAgICAgbmV3SGVpZ2h0ID0gbmV3SGVpZ2h0IDw9IG1pbkhlaWdodCA/IG1pbkhlaWdodCA6IG5ld0hlaWdodDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG5ld1RvcCAhPT0gLTEpICR3aW5kb3cuc3R5bGUudG9wID0gYCR7bmV3VG9wfXB4YDtcbiAgICAgICAgICAgIGlmIChuZXdIZWlnaHQgIT09IC0xKSAkd2luZG93LnN0eWxlLmhlaWdodCA9IGAke25ld0hlaWdodH1weGA7XG4gICAgICAgICAgICBpZiAobmV3TGVmdCAhPT0gLTEpICR3aW5kb3cuc3R5bGUubGVmdCA9IGAke25ld0xlZnR9cHhgO1xuICAgICAgICAgICAgaWYgKG5ld1dpZHRoICE9PSAtMSkgJHdpbmRvdy5zdHlsZS53aWR0aCA9IGAke25ld1dpZHRofXB4YDtcblxuICAgICAgICAgICAgaWYgKG5ld1RvcCAhPT0gLTEgfHwgbmV3SGVpZ2h0ICE9PSAtMSB8fCBuZXdMZWZ0ICE9PSAtMSB8fCBuZXdXaWR0aCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLm9uQ2hhbmdlICYmIG9wdGlvbnMub25DaGFuZ2UoJHdpbmRvdy5zdHlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBkcmFnRW5kKCkge1xuICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgZHJhZywgdHJ1ZSk7XG4gICAgICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgZHJhZ0VuZCwgdHJ1ZSk7XG4gICAgICAgIH1cblxuICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBkcmFnLCB0cnVlKTtcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIGRyYWdFbmQsIHRydWUpO1xuICAgIH1cbn1cblxuLyoqXG4gKiDnqpflj6MgcmVzaXplIOaXtu+8jOmHjeaWsOefq+ato+WdkOagh++8jOS/neivgeWcqOeUu+adv+WGhVxuICovXG5leHBvcnQgZnVuY3Rpb24gYWRqdXN0V2luZG93UG9zaXRpb24oJHdpbmRvdzogSFRNTEVsZW1lbnQsIGxpbWl0ZWRBcmVhRWxlbWVudDogSFRNTEVsZW1lbnQpIHtcbiAgICBjb25zdCBsaW1pdGVkQXJlYVNlY3Rpb24gPSBsaW1pdGVkQXJlYUVsZW1lbnQuc2hhZG93Um9vdCEucXVlcnlTZWxlY3Rvcignc2VjdGlvbicpITtcbiAgICBjb25zdCBsaW1pdGVkQXJlYVNlY3Rpb25SZWN0ID0ge1xuICAgICAgICBsZWZ0OiBsaW1pdGVkQXJlYVNlY3Rpb24uY2xpZW50TGVmdCxcbiAgICAgICAgcmlnaHQ6IGxpbWl0ZWRBcmVhU2VjdGlvbi5jbGllbnRMZWZ0ICsgbGltaXRlZEFyZWFTZWN0aW9uLmNsaWVudFdpZHRoLFxuICAgICAgICB0b3A6IGxpbWl0ZWRBcmVhU2VjdGlvbi5jbGllbnRUb3AsXG4gICAgICAgIGJvdHRvbTogbGltaXRlZEFyZWFTZWN0aW9uLmNsaWVudFRvcCArIGxpbWl0ZWRBcmVhU2VjdGlvbi5jbGllbnRIZWlnaHQsXG4gICAgfTtcblxuICAgIGNvbnN0IGxlZnQgPSBwYXJzZUZsb2F0KCR3aW5kb3cuc3R5bGUubGVmdCkgfHwgdW5kZWZpbmVkO1xuICAgIGlmIChsZWZ0ICE9PSB1bmRlZmluZWQgJiYgKFxuICAgICAgICBsZWZ0IDwgbGltaXRlZEFyZWFTZWN0aW9uUmVjdC5sZWZ0IHx8XG4gICAgICAgIGxlZnQgPiAobGltaXRlZEFyZWFTZWN0aW9uUmVjdC5yaWdodCAtICR3aW5kb3cub2Zmc2V0V2lkdGgpKSkge1xuICAgICAgICBjb25zdCBuZXdMZWZ0ID0gTWF0aC5taW4oTWF0aC5tYXgobGVmdCwgbGltaXRlZEFyZWFTZWN0aW9uUmVjdC5sZWZ0KSwgbGltaXRlZEFyZWFTZWN0aW9uUmVjdC5yaWdodCAtICR3aW5kb3cub2Zmc2V0V2lkdGgpO1xuICAgICAgICAkd2luZG93LnN0eWxlLmxlZnQgPSBuZXdMZWZ0ICsgJ3B4JztcbiAgICB9XG5cbiAgICBjb25zdCB0b3AgPSBwYXJzZUZsb2F0KCR3aW5kb3cuc3R5bGUudG9wKSB8fCB1bmRlZmluZWQ7XG4gICAgaWYgKHRvcCAhPT0gdW5kZWZpbmVkICYmIChcbiAgICAgICAgdG9wIDwgbGltaXRlZEFyZWFTZWN0aW9uUmVjdC50b3AgfHxcbiAgICAgICAgdG9wID4gbGltaXRlZEFyZWFTZWN0aW9uUmVjdC5ib3R0b20gLSAkd2luZG93Lm9mZnNldEhlaWdodFxuICAgICkpIHtcbiAgICAgICAgLy8g5qCh5q2j5L2N572u77yM56Gu5L+d56qX5Y+j5Zyo54i26IqC54K55Yy65Z+f5YaFXG4gICAgICAgIGxldCBuZXdUb3AgPSBNYXRoLm1pbiggTWF0aC5tYXgodG9wLCBsaW1pdGVkQXJlYVNlY3Rpb25SZWN0LnRvcCksIGxpbWl0ZWRBcmVhU2VjdGlvblJlY3QuYm90dG9tIC0gJHdpbmRvdy5vZmZzZXRIZWlnaHQpO1xuICAgICAgICBjb25zdCBtaW5Ub3AgPSBsaW1pdGVkQXJlYUVsZW1lbnQuc2hhZG93Um9vdCEucXVlcnlTZWxlY3RvcignaGVhZGVyJykhLm9mZnNldEhlaWdodDtcbiAgICAgICAgbmV3VG9wID0gTWF0aC5tYXgobWluVG9wLCBuZXdUb3ApO1xuICAgICAgICAkd2luZG93LnN0eWxlLnRvcCA9IG5ld1RvcCArICdweCc7XG4gICAgfVxufVxuIl19